---
import "../styles/global.css";
import { translations, type Language } from "../lib/translations";
import { getLanguage } from "../lib/api";

interface BreadcrumbItem {
  name: string;
  url: string;
}

interface HreflangUrls {
  tr: string;
  en: string;
  de: string;
}

interface Props {
  title?: string;
  description?: string;
  image?: string;
  article?: boolean;
  publishedTime?: string;
  noIndex?: boolean;
  breadcrumbs?: BreadcrumbItem[];
  lang?: Language;
  hreflangUrls?: HreflangUrls;
  category?: string;
}

// Auto-detect language from subdomain if not provided
const detectedLang = getLanguage(Astro.request);

const {
  title = "3D-labX ‚Äì T√ºrkiye'nin 3D Baskƒ± Rehberi",
  description = "3D yazƒ±cƒ± ayarlarƒ±, filament rehberleri, sorun √ß√∂z√ºmleri ve √ºr√ºn incelemeleri. T√ºrkiye'nin en kapsamlƒ± 3D baskƒ± kaynaƒüƒ±.",
  image = "/og.png",
  article = false,
  publishedTime,
  noIndex = false,
  breadcrumbs,
  lang = detectedLang,
  hreflangUrls,
  category,
} = Astro.props;

// Hreflang URLs - √∂zel URL verilmi≈üse kullan, yoksa aynƒ± path'i kullan
const finalHreflangUrls: HreflangUrls = hreflangUrls || {
  tr: `https://3d-labx.com${Astro.url.pathname}`,
  en: `https://en.3d-labx.com${Astro.url.pathname}`,
  de: `https://de.3d-labx.com${Astro.url.pathname}`
};

// Get translations for footer
const t = translations[lang];

// Language-specific base URLs
const langBaseUrls: Record<Language, string> = {
  tr: "https://3d-labx.com",
  en: "https://en.3d-labx.com",
  de: "https://de.3d-labx.com"
};

// OG locale mapping
const ogLocales: Record<Language, string> = {
  tr: "tr_TR",
  en: "en_US",
  de: "de_DE"
};

// Language-specific meta descriptions (fallbacks)
const defaultDescriptions: Record<Language, string> = {
  tr: "3D yazƒ±cƒ± ayarlarƒ±, filament rehberleri, sorun √ß√∂z√ºmleri ve √ºr√ºn incelemeleri. T√ºrkiye'nin en kapsamlƒ± 3D baskƒ± kaynaƒüƒ±.",
  en: "3D printer settings, filament guides, troubleshooting and product reviews. Your comprehensive 3D printing resource.",
  de: "3D-Drucker-Einstellungen, Filament-Anleitungen, Fehlerbehebung und Produktbewertungen. Ihre umfassende 3D-Druck-Ressource."
};

// Language-specific default titles
const defaultTitles: Record<Language, string> = {
  tr: "3D-labX ‚Äì T√ºrkiye'nin 3D Baskƒ± Rehberi",
  en: "3D-labX ‚Äì Your 3D Printing Guide",
  de: "3D-labX ‚Äì Ihr 3D-Druck Ratgeber"
};

// Use language-specific canonical URL
const canonicalURL = new URL(Astro.url.pathname, langBaseUrls[lang]);
const ogImage = image.startsWith("http") ? image : new URL(image, canonicalURL).href;

// Get language-specific meta content
const metaDescription = description || defaultDescriptions[lang];
const metaTitle = title === "3D-labX ‚Äì T√ºrkiye'nin 3D Baskƒ± Rehberi" ? defaultTitles[lang] : title;

// Auto-generate breadcrumbs from URL path if not provided
const categoryNames: Record<string, string> = {
  "3d-baski": "3D Baskƒ±",
  "incelemeler": "ƒ∞ncelemeler",
  "rehberler": "Rehberler",
  "sorun-cozumleri": "Sorun √á√∂z√ºmleri",
  "topluluk": "Topluluk",
};

const pathParts = Astro.url.pathname.split("/").filter(Boolean);
const baseUrl = langBaseUrls[lang];
const homeNames: Record<Language, string> = { tr: "Ana Sayfa", en: "Home", de: "Startseite" };
const autoBreadcrumbs: BreadcrumbItem[] = [{ name: homeNames[lang], url: `${baseUrl}/` }];
if (pathParts.length > 0 && categoryNames[pathParts[0]]) {
  autoBreadcrumbs.push({ name: categoryNames[pathParts[0]], url: `${baseUrl}/${pathParts[0]}` });
}
if (pathParts.length > 1 && article) {
  autoBreadcrumbs.push({ name: title.replace(" ‚Äì 3D-labX", "").replace(" - 3D-labX", ""), url: canonicalURL.href });
}

const finalBreadcrumbs = breadcrumbs || (pathParts.length > 0 ? autoBreadcrumbs : null);
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google Consent Mode v2 (must be BEFORE all Google tags) -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'denied',
        'wait_for_update': 500
      });
    </script>

    <!-- Google Funding Choices (CMP) -->
    <script is:inline async src="https://fundingchoices.google.com/i/ca-pub-5103156785085864?ers=1" nonce=""></script>
    <script is:inline nonce="">
      (function() {
        function signalGooglefcPresent(){if(!window.frames['googlefcPresent']){if(document.body){var i=document.createElement('iframe');i.style='width:0;height:0;border:none;z-index:-1000;left:-1000px;top:-1000px;';i.style.display='none';i.name='googlefcPresent';document.body.appendChild(i)}else{setTimeout(signalGooglefcPresent,0)}}}signalGooglefcPresent();
      })();
    </script>

    <!-- Google Tag Manager -->
    <script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PN77D39H');</script>
    <!-- End Google Tag Manager -->

    <!-- Google Analytics -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-7M54F92VCE"></script>
    <script is:inline>
      gtag('js', new Date());
      gtag('config', 'G-7M54F92VCE');
    </script>

    <!-- Google AdSense -->
    <script is:inline async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5103156785085864" crossorigin="anonymous"></script>

    <!-- Theme Script (Prevents Flash) -->
    <script is:inline>
      (function() {
        // Tema y√ºkle
        let theme = localStorage.getItem('theme') || 'dark';
        if (theme === 'system') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // Sadece data-theme attribute ile kontrol et, inline style kullanma
        document.documentElement.setAttribute('data-theme', theme);

        // Yazƒ± boyutu y√ºkle
        const fontSize = localStorage.getItem('fontSize') || 'medium';
        const sizes = { 'small': '14px', 'medium': '16px', 'large': '18px' };
        document.documentElement.style.fontSize = sizes[fontSize] || '16px';
      })();
    </script>

    <!-- SEO -->
    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    <link rel="canonical" href={canonicalURL} />
    <meta name="author" content="3D-labX" />
    <meta name="publisher" content="3D-labX" />
    <meta name="robots" content={noIndex ? "noindex, nofollow" : "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"} />
    <meta name="googlebot" content={noIndex ? "noindex, nofollow" : "index, follow"} />
    <meta name="language" content={lang === "tr" ? "Turkish" : lang === "en" ? "English" : "German"} />
    <meta name="revisit-after" content="7 days" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="3D-labX RSS" href="/rss.xml" />

    <!-- Hreflang for multilingual support -->
    <link rel="alternate" hreflang="tr" href={finalHreflangUrls.tr} />
    <link rel="alternate" hreflang="en" href={finalHreflangUrls.en} />
    <link rel="alternate" hreflang="de" href={finalHreflangUrls.de} />
    <link rel="alternate" hreflang="x-default" href={finalHreflangUrls.tr} />

    <!-- Open Graph -->
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content={article ? "article" : "website"} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="3D-labX" />
    <meta property="og:locale" content={ogLocales[lang]} />
    {lang !== "tr" && <meta property="og:locale:alternate" content="tr_TR" />}
    {lang !== "en" && <meta property="og:locale:alternate" content="en_US" />}
    {lang !== "de" && <meta property="og:locale:alternate" content="de_DE" />}
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    {article && publishedTime && (
      <meta property="article:published_time" content={publishedTime} />
    )}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@3DLabX" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Theme Color -->
    <meta name="theme-color" content="#2563EB" />
    <meta name="msapplication-TileColor" content="#2563EB" />

    <!-- Preconnect & Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://tech-portal-api.turgut-d01.workers.dev" />
    <link rel="dns-prefetch" href="https://tech-portal-api.turgut-d01.workers.dev" />
    <link rel="dns-prefetch" href="https://pub-9142f11355e84e1da1dd96a4c14e4afb.r2.dev" />

    <!-- JSON-LD Organization Schema (always present) -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "3D-labX",
      "url": "https://3d-labx.com",
      "logo": "https://3d-labx.com/favicon.svg",
      "description": defaultDescriptions[lang],
      "sameAs": [
        "https://www.youtube.com/@3D-LabX"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service",
        "url": "https://3d-labx.com/iletisim",
        "availableLanguage": ["Turkish", "English", "German"]
      }
    })} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(
      article ? {
        "@context": "https://schema.org",
        "@type": category === "incelemeler" ? "Review" : category === "3d-baski" || category === "teknoloji" ? "NewsArticle" : category === "rehberler" ? "TechArticle" : "Article",
        "headline": metaTitle,
        "name": metaTitle,
        "description": metaDescription,
        "url": canonicalURL.href,
        "image": ogImage,
        "inLanguage": lang === "tr" ? "tr-TR" : lang === "en" ? "en-US" : "de-DE",
        "datePublished": publishedTime,
        "dateModified": publishedTime,
        "author": {
          "@type": "Organization",
          "name": "3D-labX",
          "url": "https://3d-labx.com"
        },
        "publisher": {
          "@type": "Organization",
          "name": "3D-labX",
          "url": "https://3d-labx.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://3d-labx.com/favicon.svg",
            "width": 512,
            "height": 512
          }
        },
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": canonicalURL.href
        },
        ...(category === "incelemeler" ? {
          "itemReviewed": {
            "@type": "Product",
            "name": metaTitle.replace(" ƒ∞ncelemesi", "").replace(" Review", "").replace(" Bewertung", "").replace(" ‚Äì 3D-labX", "")
          },
          "reviewRating": {
            "@type": "Rating",
            "bestRating": "5"
          },
          "author": {
            "@type": "Person",
            "name": "Turer"
          }
        } : {}),
        ...(category === "rehberler" || category === "sorun-cozumleri" ? {
          "proficiencyLevel": category === "sorun-cozumleri" ? "Beginner" : "Intermediate"
        } : {})
      } : {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": metaTitle,
        "description": metaDescription,
        "url": canonicalURL.href,
        "inLanguage": lang === "tr" ? "tr-TR" : lang === "en" ? "en-US" : "de-DE",
        "potentialAction": {
          "@type": "SearchAction",
          "target": `${langBaseUrls[lang]}/search?q={search_term_string}`,
          "query-input": "required name=search_term_string"
        }
      }
    )} />

    {/* BreadcrumbList Structured Data */}
    {finalBreadcrumbs && finalBreadcrumbs.length > 1 && (
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": finalBreadcrumbs.map((item, index) => ({
          "@type": "ListItem",
          "position": index + 1,
          "name": item.name,
          "item": item.url
        }))
      })} />
    )}
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PN77D39H"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <slot />

    <!-- Join Banner (shown for non-logged-in users) -->
    <div class="join-banner" id="joinBanner" style="display: none;">
      <div class="join-banner-content">
        <div class="join-banner-text">
          <span class="join-emoji">üéâ</span>
          <span><strong>{t.footer.joinCommunity}</strong> {t.footer.joinDesc}</span>
        </div>
        <div class="join-banner-actions">
          <a href="/auth/kayit" class="join-btn">{t.footer.signUp}</a>
          <button class="join-dismiss" id="joinDismiss" title={t.footer.close}>‚úï</button>
        </div>
      </div>
    </div>

    <footer class="site-footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-brand">
            <a href="/" class="footer-logo">3D-labX</a>
            <p>{t.footer.brandDescription}</p>
            <div class="footer-social">
              <a href="https://www.youtube.com/@3D-LabX" target="_blank" rel="noopener" class="social-link youtube" title="YouTube">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
              </a>
            </div>
          </div>

          <div class="footer-links">
            <div class="footer-column">
              <h4>{t.footer.printing3d}</h4>
              <ul>
                <li><a href="/3d-baski">{t.footer.news}</a></li>
                <li><a href="/rehberler">{t.footer.guides}</a></li>
                <li><a href="/sorun-cozumleri">{t.footer.troubleshooting}</a></li>
                <li><a href="/incelemeler">{t.footer.reviews}</a></li>
                <li><a href="/topluluk">{t.footer.community}</a></li>
              </ul>
            </div>

            <div class="footer-column">
              <h4>{t.footer.popularTopics}</h4>
              <ul>
                <li><a href="/rehberler/cura-slicer-interaktif-rehber">{t.footer.curaGuide}</a></li>
                <li><a href="/rehberler/orca-slicer-rehberi">{t.footer.orcaGuide}</a></li>
                <li><a href="/sorun-cozumleri">{t.footer.troubleshooting}</a></li>
                <li><a href="/filamentler">{t.footer.filamentGuide}</a></li>
                <li><a href="/iletisim">{t.footer.contact}</a></li>
                <li><a href="/rss.xml" class="rss-link">üì° {t.footer.rssFeed}</a></li>
              </ul>
            </div>
          </div>

          <!-- Newsletter Section -->
          <div class="footer-newsletter">
            <h4>üì¨ {t.footer.newsletter}</h4>
            <p>{t.footer.newsletterDesc}</p>
            <form class="newsletter-form" id="newsletterForm">
              <input type="email" placeholder={t.footer.emailPlaceholder} required />
              <button type="submit">{t.footer.subscribe}</button>
            </form>
            <p class="newsletter-note">{t.footer.noSpam}</p>
          </div>
        </div>

        <div class="footer-bottom">
          <p>&copy; {new Date().getFullYear()} 3D-labX - {t.footer.copyright}</p>
        </div>
      </div>
    </footer>

    <!-- Toast Notification System -->
    <script is:inline>
      window.showToast = function(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const icons = {
          info: '‚ÑπÔ∏è',
          success: '‚úÖ',
          warning: '‚ö†Ô∏è',
          error: '‚ùå'
        };

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <span class="toast-icon">${icons[type] || icons.info}</span>
          <div class="toast-content">${message}</div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        container.appendChild(toast);

        // Auto remove
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      };
    </script>

    <!-- Newsletter Script -->
    <script is:inline define:vars={{
      subscribingText: t.footer.subscribing,
      successText: t.footer.subscribeSuccess,
      errorText: t.footer.subscribeError,
      connectionErrorText: t.footer.connectionError
    }}>
      document.getElementById('newsletterForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = this.querySelector('input[type="email"]').value;
        const btn = this.querySelector('button');
        const originalText = btn.textContent;

        btn.textContent = subscribingText;
        btn.disabled = true;

        try {
          const res = await fetch('https://tech-portal-api.turgut-d01.workers.dev/api/newsletter/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          if (res.ok) {
            window.showToast(successText, 'success');
            this.reset();
          } else {
            const data = await res.json();
            window.showToast(data.error || errorText, 'error');
          }
        } catch (err) {
          window.showToast(connectionErrorText, 'error');
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });
    </script>

    <!-- Code Copy Button Script -->
    <script is:inline>
      function initCodeCopyButtons() {
        // Find all pre elements
        document.querySelectorAll('pre').forEach(el => addCopyButton(el));

        // Also find code blocks in article content (divs with monospace font and dark background)
        document.querySelectorAll('.article-content div, .article-content p').forEach(el => {
          // Skip if already wrapped
          if (el.parentElement?.classList.contains('code-block-wrapper')) return;

          // Check computed styles
          const style = window.getComputedStyle(el);
          const fontFamily = style.fontFamily.toLowerCase();
          const bgColor = style.backgroundColor;

          // Detect code blocks: monospace font + dark background
          const isMonospace = fontFamily.includes('mono') || fontFamily.includes('consolas') || fontFamily.includes('fira');
          const isDarkBg = bgColor.includes('rgb(30') || bgColor.includes('rgb(24') || bgColor.includes('rgb(31');

          // Check if it looks like a code block (has monospace + dark bg or specific structure)
          if (isMonospace && isDarkBg) {
            // Make sure it's a standalone code block, not inline code
            const text = el.textContent.trim();
            if (text.length > 5 && !el.querySelector('ul, ol, table, img')) {
              addCopyButton(el);
            }
          }
        });

        function addCopyButton(el) {
          // Skip if already wrapped
          if (el.parentElement?.classList.contains('code-block-wrapper')) return;

          // Skip if it's inside certain containers
          if (el.closest('.poll-options') || el.closest('.comment-form') || el.closest('.code-block-wrapper')) return;

          // Create wrapper
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';

          // Create copy button
          const copyBtn = document.createElement('button');
          copyBtn.className = 'code-copy-btn';
          copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>Kopyala</span>
          `;

          // Copy functionality
          copyBtn.addEventListener('click', async () => {
            const code = el.querySelector('code')?.textContent || el.textContent;

            try {
              await navigator.clipboard.writeText(code.trim());
              copyBtn.classList.add('copied');
              copyBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>Kopyalandƒ±!</span>
              `;

              setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  <span>Kopyala</span>
                `;
              }, 2000);
            } catch (err) {
              console.error('Copy failed:', err);
            }
          });

          // Wrap the element
          el.parentNode.insertBefore(wrapper, el);
          wrapper.appendChild(el);
          wrapper.appendChild(copyBtn);
        }
      }

      // Run on page load
      document.addEventListener('DOMContentLoaded', initCodeCopyButtons);

      // Run on Astro page navigation
      document.addEventListener('astro:after-swap', initCodeCopyButtons);

      // Run immediately if DOM is already loaded
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initCodeCopyButtons();
      }
    </script>

    <!-- Site-Wide Logging System -->
    <script is:inline>
      (function() {
        const LOG_API = 'https://tech-portal-api.turgut-d01.workers.dev/api/logs';
        const LOG_QUEUE = [];
        let isSending = false;

        // Global logger
        window.siteLog = function(type, message, details = null, level = 'info') {
          const logEntry = {
            type,
            level,
            message,
            details,
            pageUrl: window.location.href,
            timestamp: new Date().toISOString()
          };

          LOG_QUEUE.push(logEntry);
          processQueue();
        };

        // Process queue
        async function processQueue() {
          if (isSending || LOG_QUEUE.length === 0) return;
          isSending = true;

          while (LOG_QUEUE.length > 0) {
            const entry = LOG_QUEUE.shift();
            try {
              const headers = { 'Content-Type': 'application/json' };
              const token = localStorage.getItem('authToken');
              if (token) headers['Authorization'] = `Bearer ${token}`;

              await fetch(LOG_API, {
                method: 'POST',
                headers,
                body: JSON.stringify(entry)
              });
            } catch (err) {
              // Silently fail - don't break the site for logging
            }
          }
          isSending = false;
        }

        // Auto-log page views
        window.siteLog('pageview', 'Sayfa g√∂r√ºnt√ºlendi', {
          referrer: document.referrer,
          title: document.title
        });

        // Log page navigation (Astro)
        document.addEventListener('astro:after-swap', () => {
          window.siteLog('pageview', 'Sayfa g√∂r√ºnt√ºlendi', {
            referrer: document.referrer,
            title: document.title
          });
        });

        // Log errors
        window.addEventListener('error', (e) => {
          window.siteLog('error', e.message || 'JavaScript hatasƒ±', {
            filename: e.filename,
            lineno: e.lineno,
            colno: e.colno
          }, 'error');
        });

        // Log unhandled promise rejections
        window.addEventListener('unhandledrejection', (e) => {
          window.siteLog('error', 'Promise rejection', {
            reason: e.reason?.message || String(e.reason)
          }, 'error');
        });

        // Log clicks on important elements
        document.addEventListener('click', (e) => {
          const target = e.target.closest('a, button, [data-track]');
          if (!target) return;

          // Track outbound links
          if (target.tagName === 'A' && target.hostname !== window.location.hostname) {
            window.siteLog('click', 'Dƒ±≈ü link tƒ±klandƒ±', {
              href: target.href,
              text: target.textContent?.slice(0, 50)
            });
          }

          // Track data-track elements
          if (target.dataset.track) {
            window.siteLog('click', target.dataset.track, {
              element: target.tagName,
              text: target.textContent?.slice(0, 50)
            });
          }
        });

        // Log search
        const searchForm = document.querySelector('form[action="/search"]');
        if (searchForm) {
          searchForm.addEventListener('submit', (e) => {
            const input = searchForm.querySelector('input[name="q"]');
            if (input?.value) {
              window.siteLog('search', 'Arama yapƒ±ldƒ±', { query: input.value });
            }
          });
        }

        // Log form submissions
        document.addEventListener('submit', (e) => {
          const form = e.target;
          if (form.id && !form.action?.includes('/search')) {
            window.siteLog('form', 'Form g√∂nderildi', { formId: form.id });
          }
        });

        // Log auth events
        window.addEventListener('storage', (e) => {
          if (e.key === 'authToken') {
            if (e.newValue && !e.oldValue) {
              window.siteLog('auth', 'Kullanƒ±cƒ± giri≈ü yaptƒ±');
            } else if (!e.newValue && e.oldValue) {
              window.siteLog('auth', 'Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yaptƒ±');
            }
          }
        });
      })();
    </script>

    <!-- Join Banner Logic -->
    <script is:inline>
      (function() {
        const joinBanner = document.getElementById('joinBanner');
        const joinDismiss = document.getElementById('joinDismiss');
        const footer = document.querySelector('.site-footer');

        function checkJoinBanner() {
          const token = localStorage.getItem('authToken');
          const dismissed = sessionStorage.getItem('joinBannerDismissed');

          if (!token && !dismissed && joinBanner) {
            joinBanner.style.display = 'block';
            if (footer) footer.style.paddingBottom = '80px';
          } else if (joinBanner) {
            joinBanner.style.display = 'none';
            if (footer) footer.style.paddingBottom = '24px';
          }
        }

        joinDismiss?.addEventListener('click', () => {
          sessionStorage.setItem('joinBannerDismissed', 'true');
          if (joinBanner) joinBanner.style.display = 'none';
          if (footer) footer.style.paddingBottom = '24px';
        });

        // Check on load
        checkJoinBanner();

        // Re-check on auth changes
        window.addEventListener('storage', (e) => {
          if (e.key === 'authToken') {
            checkJoinBanner();
          }
        });
      })();
    </script>
  </body>
</html>

<style is:global>
  /* Toast Notifications */
  .toast-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 360px;
  }

  .toast {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    animation: toastSlideIn 0.3s ease;
    font-size: 0.9rem;
    color: var(--text-main);
  }

  .toast.info {
    border-left: 4px solid #3B82F6;
  }

  .toast.success {
    border-left: 4px solid #22C55E;
  }

  .toast.warning {
    border-left: 4px solid #F59E0B;
  }

  .toast.error {
    border-left: 4px solid #EF4444;
  }

  .toast-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .toast-content {
    flex: 1;
  }

  .toast-content a {
    color: #F97316;
    font-weight: 600;
    text-decoration: none;
  }

  .toast-content a:hover {
    text-decoration: underline;
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    font-size: 1.1rem;
    line-height: 1;
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  .toast-close:hover {
    opacity: 1;
  }

  .toast.hiding {
    animation: toastSlideOut 0.3s ease forwards;
  }

  @keyframes toastSlideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes toastSlideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  @media (max-width: 480px) {
    .toast-container {
      left: 10px;
      right: 10px;
      max-width: none;
    }
  }

  /* Join Banner */
  .join-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 999;
    background: linear-gradient(135deg, #2563EB 0%, #7C3AED 100%);
    padding: 12px 20px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
  }

  .join-banner-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .join-banner-text {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 0.95rem;
  }

  .join-emoji {
    font-size: 1.5rem;
  }

  .join-banner-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .join-btn {
    padding: 10px 24px;
    background: white;
    color: #2563EB;
    font-weight: 700;
    font-size: 0.9rem;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .join-btn:hover {
    background: #f1f5f9;
    transform: scale(1.03);
  }

  .join-dismiss {
    background: transparent;
    border: none;
    color: white;
    opacity: 0.7;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 4px 8px;
    transition: opacity 0.2s;
  }

  .join-dismiss:hover {
    opacity: 1;
  }

  @media (max-width: 640px) {
    .join-banner-content {
      flex-direction: column;
      text-align: center;
    }

    .join-banner-text {
      flex-direction: column;
      gap: 8px;
    }
  }

  .site-footer {
    margin-top: 64px;
    padding: 48px 0 24px;
    padding-bottom: 80px; /* Space for join banner */
    border-top: none;
    background: var(--bg-card);
    color: var(--text-muted);
    font-size: 0.9rem;
    position: relative;
  }

  .site-footer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #F97316, #EAB308, #22C55E, #06B6D4, #A855F7, #EC4899);
  }

  .footer-content {
    display: grid;
    grid-template-columns: 1.5fr 2fr;
    gap: 48px;
    margin-bottom: 32px;
  }

  .footer-brand {
    max-width: 300px;
  }

  .footer-logo {
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #F97316, #EAB308);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-decoration: none;
    display: inline-block;
    margin-bottom: 12px;
  }

  .footer-brand p {
    color: var(--text-muted);
    line-height: 1.6;
    margin: 0;
  }

  .footer-social {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }

  .social-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--bg-soft);
    color: var(--text-muted);
    transition: all 0.3s ease;
  }

  .social-link:hover {
    transform: translateY(-2px);
  }

  .social-link.youtube:hover {
    background: #FF0000;
    color: white;
  }

  .footer-links {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
  }

  .footer-column h4 {
    color: var(--text-main);
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0 0 16px;
  }

  .footer-column ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .footer-column li {
    margin-bottom: 10px;
  }

  .footer-column a {
    color: var(--text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .footer-column a:hover {
    color: var(--accent);
  }

  .footer-column .rss-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  /* Newsletter */
  .footer-newsletter {
    grid-column: 1 / -1;
    background: var(--bg-soft);
    padding: 24px;
    border-radius: 16px;
    text-align: center;
    margin-top: 16px;
  }

  .footer-newsletter h4 {
    color: var(--text-main);
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 8px;
  }

  .footer-newsletter > p {
    color: var(--text-muted);
    margin: 0 0 16px;
    font-size: 0.9rem;
  }

  .newsletter-form {
    display: flex;
    gap: 10px;
    max-width: 400px;
    margin: 0 auto;
  }

  .newsletter-form input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-soft);
    border-radius: 10px;
    font-size: 0.9rem;
    background: var(--bg-card);
    color: var(--text-main);
    transition: border-color 0.2s ease;
  }

  .newsletter-form input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .newsletter-form button {
    padding: 12px 20px;
    background: linear-gradient(135deg, #F97316, #EAB308);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    white-space: nowrap;
  }

  .newsletter-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
  }

  .newsletter-note {
    font-size: 0.75rem !important;
    color: var(--text-light) !important;
    margin-top: 10px !important;
    margin-bottom: 0 !important;
  }

  @media (max-width: 480px) {
    .newsletter-form {
      flex-direction: column;
    }

    .newsletter-form button {
      width: 100%;
    }
  }

  .footer-bottom {
    padding-top: 24px;
    border-top: 1px solid var(--border-soft);
    text-align: center;
  }

  .footer-bottom p {
    margin: 0;
    color: var(--text-light);
    font-size: 0.85rem;
  }

  @media (max-width: 768px) {
    .footer-content {
      grid-template-columns: 1fr;
      gap: 32px;
    }

    .footer-brand {
      max-width: 100%;
      text-align: center;
    }

    .footer-social {
      justify-content: center;
    }

    .footer-links {
      grid-template-columns: repeat(2, 1fr);
      text-align: center;
    }
  }

  @media (max-width: 480px) {
    .footer-links {
      grid-template-columns: 1fr;
      gap: 24px;
    }
  }
</style>
