---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Header from "../../../components/Header.astro";
import { getApiBase, getLanguage, type Language } from "../../../lib/api";

export const prerender = false;

const { category: categorySlug } = Astro.params;
const API_BASE = getApiBase(Astro.request);
const lang = getLanguage(Astro.request);

// √áeviriler
const translations: Record<Language, {
  community: string;
  forum: string;
  newTopic: string;
  sortLabel: string;
  sortLatest: string;
  sortPopular: string;
  sortUnsolved: string;
  pinned: string;
  solved: string;
  lastReply: string;
  noTopics: string;
  noTopicsDesc: string;
  createTopic: string;
  prev: string;
  next: string;
  justNow: string;
  minutesAgo: string;
  hoursAgo: string;
  daysAgo: string;
}> = {
  tr: {
    community: "Topluluk",
    forum: "Forum",
    newTopic: "Yeni Konu",
    sortLabel: "Sƒ±rala:",
    sortLatest: "Son Cevaplanan",
    sortPopular: "Pop√ºler",
    sortUnsolved: "√á√∂z√ºlmemi≈ü",
    pinned: "üìå Sabit",
    solved: "‚úì √á√∂z√ºld√º",
    lastReply: "Son:",
    noTopics: "Hen√ºz konu yok",
    noTopicsDesc: "Bu kategoride hen√ºz konu a√ßƒ±lmamƒ±≈ü. ƒ∞lk konuyu sen a√ß!",
    createTopic: "Konu A√ß",
    prev: "‚Üê √ñnceki",
    next: "Sonraki ‚Üí",
    justNow: "Az √∂nce",
    minutesAgo: "dk √∂nce",
    hoursAgo: "saat √∂nce",
    daysAgo: "g√ºn √∂nce"
  },
  en: {
    community: "Community",
    forum: "Forum",
    newTopic: "New Topic",
    sortLabel: "Sort:",
    sortLatest: "Latest",
    sortPopular: "Popular",
    sortUnsolved: "Unsolved",
    pinned: "üìå Pinned",
    solved: "‚úì Solved",
    lastReply: "Last:",
    noTopics: "No topics yet",
    noTopicsDesc: "No topics in this category yet. Be the first to create one!",
    createTopic: "Create Topic",
    prev: "‚Üê Previous",
    next: "Next ‚Üí",
    justNow: "Just now",
    minutesAgo: "min ago",
    hoursAgo: "hr ago",
    daysAgo: "d ago"
  },
  de: {
    community: "Community",
    forum: "Forum",
    newTopic: "Neues Thema",
    sortLabel: "Sortieren:",
    sortLatest: "Neueste",
    sortPopular: "Beliebt",
    sortUnsolved: "Ungel√∂st",
    pinned: "üìå Angepinnt",
    solved: "‚úì Gel√∂st",
    lastReply: "Letzter:",
    noTopics: "Noch keine Themen",
    noTopicsDesc: "In dieser Kategorie gibt es noch keine Themen. Erstellen Sie das erste!",
    createTopic: "Thema erstellen",
    prev: "‚Üê Zur√ºck",
    next: "Weiter ‚Üí",
    justNow: "Gerade eben",
    minutesAgo: "Min. her",
    hoursAgo: "Std. her",
    daysAgo: "T. her"
  }
};

const t = translations[lang];

const url = new URL(Astro.request.url);
const currentPage = Math.max(1, parseInt(url.searchParams.get("page") || "1", 10));
const sort = url.searchParams.get("sort") || "latest";

let category: any = null;
let threads: any[] = [];
let pagination: any = null;

try {
  const res = await fetch(`${API_BASE}/api/forum/categories/${categorySlug}/threads?page=${currentPage}&limit=20&sort=${sort}&lang=${lang}`);
  if (res.ok) {
    const data = await res.json();
    category = data.category;
    threads = data.threads || [];
    pagination = data.pagination;
  }
} catch (e) {
  console.error("Forum konularƒ± y√ºklenemedi:", e);
}

if (!category) {
  return Astro.redirect("/topluluk/forum");
}

const dateLocale = lang === 'tr' ? 'tr-TR' : lang === 'de' ? 'de-DE' : 'en-US';

function timeAgo(dateStr: string) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diff < 60) return t.justNow;
  if (diff < 3600) return `${Math.floor(diff / 60)} ${t.minutesAgo}`;
  if (diff < 86400) return `${Math.floor(diff / 3600)} ${t.hoursAgo}`;
  if (diff < 604800) return `${Math.floor(diff / 86400)} ${t.daysAgo}`;
  return date.toLocaleDateString(dateLocale, { day: "numeric", month: "short" });
}
---

<BaseLayout 
  title={`${category.name} - Forum | 3D-labX`}
  description={category.description}
>
  <Header />

  <main class="category-page">
    <div class="container">
      <div class="page-header">
        <div class="header-left">
          <nav class="breadcrumb">
            <a href="/topluluk">{t.community}</a>
            <span>/</span>
            <a href="/topluluk/forum">{t.forum}</a>
            <span>/</span>
            <span>{category.name}</span>
          </nav>
          <div class="category-title">
            <span class="cat-icon">{category.icon}</span>
            <h1>{category.name}</h1>
          </div>
          <p>{category.description}</p>
        </div>
        <div class="header-right">
          <a href={`/topluluk/forum/yeni?category=${categorySlug}`} class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            {t.newTopic}
          </a>
        </div>
      </div>

      <!-- Sƒ±ralama -->
      <div class="sort-bar">
        <span class="sort-label">{t.sortLabel}</span>
        <div class="sort-options">
          <a href={`?sort=latest`} class={sort === "latest" ? "active" : ""}>{t.sortLatest}</a>
          <a href={`?sort=popular`} class={sort === "popular" ? "active" : ""}>{t.sortPopular}</a>
          <a href={`?sort=unsolved`} class={sort === "unsolved" ? "active" : ""}>{t.sortUnsolved}</a>
        </div>
      </div>

      <!-- Konular -->
      <div class="threads-list">
        {threads.length > 0 ? threads.map((thread) => (
          <a href={`/topluluk/forum/konu/${thread.slug}`} class={`thread-row ${thread.is_pinned ? 'pinned' : ''} ${thread.is_solved ? 'solved' : ''}`}>
            <div class="thread-avatar">
              {thread.avatar_url ? (
                <img src={thread.avatar_url} alt={thread.username} />
              ) : (
                <div class="avatar-placeholder">{thread.username?.charAt(0).toUpperCase()}</div>
              )}
            </div>
            <div class="thread-main">
              <div class="thread-title">
                {thread.is_pinned === 1 && <span class="badge pinned">{t.pinned}</span>}
                {thread.is_solved === 1 && <span class="badge solved">{t.solved}</span>}
                {thread.is_locked === 1 && <span class="badge locked">üîí</span>}
                <h3>{thread.title}</h3>
              </div>
              <div class="thread-meta">
                <span class="author">@{thread.username}</span>
                <span class="dot">‚Ä¢</span>
                <span class="time">{timeAgo(thread.created_at)}</span>
                {thread.last_reply_at && (
                  <>
                    <span class="dot">‚Ä¢</span>
                    <span class="last-reply">{t.lastReply} @{thread.last_reply_username || 'anonim'}</span>
                  </>
                )}
              </div>
            </div>
            <div class="thread-stats">
              <div class="stat">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span>{thread.reply_count}</span>
              </div>
              <div class="stat">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <span>{thread.view_count}</span>
              </div>
            </div>
          </a>
        )) : (
          <div class="empty-state">
            <div class="empty-icon">üí¨</div>
            <h3>{t.noTopics}</h3>
            <p>{t.noTopicsDesc}</p>
            <a href={`/topluluk/forum/yeni?category=${categorySlug}`} class="btn btn-primary">{t.createTopic}</a>
          </div>
        )}
      </div>

      <!-- Sayfalama -->
      {pagination && pagination.totalPages > 1 && (
        <nav class="pagination">
          <a href={`?page=${currentPage - 1}&sort=${sort}`} class={`page-btn ${!pagination.hasPrev ? 'disabled' : ''}`}>
            {t.prev}
          </a>
          <span class="page-info">{pagination.page} / {pagination.totalPages}</span>
          <a href={`?page=${currentPage + 1}&sort=${sort}`} class={`page-btn ${!pagination.hasNext ? 'disabled' : ''}`}>
            {t.next}
          </a>
        </nav>
      )}
    </div>
  </main>
</BaseLayout>

<style>
  .category-page {
    padding-top: 140px;
    padding-bottom: 64px;
    min-height: 100vh;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    gap: 20px;
    flex-wrap: wrap;
  }

  .breadcrumb {
    display: flex;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .breadcrumb a {
    color: #F97316;
    text-decoration: none;
  }

  .category-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .cat-icon {
    font-size: 2rem;
  }

  .page-header h1 {
    margin: 0;
    font-size: 1.8rem;
  }

  .page-header p {
    margin: 0;
    color: var(--text-muted);
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
    color: white;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(249, 115, 22, 0.4);
  }

  .sort-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    margin-bottom: 16px;
  }

  .sort-label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .sort-options {
    display: flex;
    gap: 8px;
  }

  .sort-options a {
    padding: 6px 12px;
    font-size: 0.85rem;
    color: var(--text-muted);
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .sort-options a:hover {
    background: var(--bg-main);
    color: var(--text-main);
  }

  .sort-options a.active {
    background: #F97316;
    color: white;
  }

  .threads-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .thread-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .thread-row:hover {
    border-color: #F97316;
    transform: translateX(4px);
  }

  .thread-row.pinned {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.05), transparent);
    border-color: rgba(249, 115, 22, 0.3);
  }

  .thread-row.solved {
    border-left: 3px solid #22C55E;
  }

  .thread-avatar img,
  .avatar-placeholder {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    object-fit: cover;
  }

  .avatar-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #F97316, #EA580C);
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .thread-main {
    flex: 1;
    min-width: 0;
  }

  .thread-title {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }

  .thread-title h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-main);
  }

  .badge {
    padding: 2px 8px;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 6px;
  }

  .badge.pinned {
    background: rgba(249, 115, 22, 0.15);
    color: #F97316;
  }

  .badge.solved {
    background: rgba(34, 197, 94, 0.15);
    color: #22C55E;
  }

  .badge.locked {
    background: rgba(107, 114, 128, 0.15);
    color: #6B7280;
  }

  .thread-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .dot {
    opacity: 0.5;
  }

  .thread-stats {
    display: flex;
    gap: 16px;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }

  .empty-state h3 {
    margin: 0 0 8px;
  }

  .empty-state p {
    color: var(--text-muted);
    margin-bottom: 20px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-top: 32px;
  }

  .page-btn {
    padding: 10px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 10px;
    color: var(--text-main);
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .page-btn:hover:not(.disabled) {
    border-color: #F97316;
    color: #F97316;
  }

  .page-btn.disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .page-info {
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  @media (max-width: 640px) {
    .category-page {
      padding-top: 120px;
    }

    .page-header {
      flex-direction: column;
    }

    .sort-bar {
      flex-wrap: wrap;
    }

    .thread-row {
      flex-wrap: wrap;
      padding: 14px;
    }

    .thread-stats {
      width: 100%;
      justify-content: flex-start;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 1px solid var(--border-soft);
    }
  }
</style>
