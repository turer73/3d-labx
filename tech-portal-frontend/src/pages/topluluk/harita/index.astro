---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Header from "../../../components/Header.astro";
import { getApiBase, getLanguage, type Language } from "../../../lib/api";

export const prerender = false;

const lang = getLanguage(Astro.request);
const API_BASE = getApiBase(Astro.request);

// √áeviriler
const translations: Record<Language, {
  pageTitle: string;
  pageDesc: string;
  heroTitle: string;
  heroSubtitle: string;
  heroMakers: string;
  heroActiveCities: string;
  heroAllCountry: string;
  breadcrumbCommunity: string;
  breadcrumbMap: string;
  title: string;
  subtitle: string;
  joinMap: string;
  totalMakers: string;
  activeCities: string;
  printingService: string;
  infoBannerTitle: string;
  infoBannerDesc: string;
  infoBannerNote: string;
  citiesSidebar: string;
  allCountry: string;
  emptyCitiesNote: string;
  makersInCity: string;
  allMakers: string;
  filterPrintingService: string;
  verified: string;
  apprentice: string;
  journeyman: string;
  master: string;
  grandmaster: string;
  printService: string;
  helpAvailable: string;
  contact: string;
  noMakersInCity: string;
  noMakersYet: string;
  beFirstOnMap: string;
  disclaimerTitle: string;
  disclaimerText: string;
  contactInfo: string;
  copy: string;
  copied: string;
  open: string;
  send: string;
  noContactInfo: string;
  sampleProfile: string;
  sampleProfileNote: string;
  contactNote: string;
}> = {
  tr: {
    pageTitle: "Maker Haritasƒ± - T√ºrkiye'deki 3D Baskƒ±cƒ±lar - 3D-labX",
    pageDesc: "T√ºrkiye'deki 3D baskƒ± meraklƒ±larƒ±nƒ± ke≈üfet. ≈ûehrindeki maker'larla tanƒ±≈ü, yardƒ±m al veya ver.",
    heroTitle: "üó∫Ô∏è Maker Haritasƒ±",
    heroSubtitle: "T√ºrkiye'nin d√∂rt bir yanƒ±ndaki 3D baskƒ± meraklƒ±larƒ±nƒ± ke≈üfet, tanƒ±≈ü, birlikte √ºret!",
    heroMakers: "Maker",
    heroActiveCities: "Aktif ƒ∞l",
    heroAllCountry: "T√ºrkiye'nin Tamamƒ±",
    breadcrumbCommunity: "Topluluk",
    breadcrumbMap: "Maker Haritasƒ±",
    title: "üó∫Ô∏è Maker Haritasƒ±",
    subtitle: "T√ºrkiye'deki 3D baskƒ± tutkunlarƒ±nƒ± ke≈üfet",
    joinMap: "Haritaya Katƒ±l",
    totalMakers: "Toplam Maker",
    activeCities: "Aktif ƒ∞l",
    printingService: "Baskƒ± Hizmeti",
    infoBannerTitle: "Maker Haritasƒ± Nedir?",
    infoBannerDesc: "≈ûehrindeki 3D baskƒ± meraklƒ±larƒ±nƒ± bul, tanƒ±≈ü, fikir al. ƒ∞ster yardƒ±ma ihtiyacƒ±n olsun, ister tecr√ºbeni payla≈ümak iste - Maker Haritasƒ± seni doƒüru ki≈üilerle bulu≈üturur.",
    infoBannerNote: "‚ö†Ô∏è Platform sadece tanƒ±≈ütƒ±rma ama√ßlƒ±dƒ±r. Ticari i≈ülemler kullanƒ±cƒ±larƒ±n sorumluluƒüundadƒ±r.",
    citiesSidebar: "üìç ƒ∞ller",
    allCountry: "T√ºm T√ºrkiye",
    emptyCitiesNote: "il hen√ºz bo≈ü",
    makersInCity: "'deki Maker'lar",
    allMakers: "T√ºm Maker'lar",
    filterPrintingService: "üñ®Ô∏è Baskƒ± hizmeti verenler",
    verified: "Doƒürulanmƒ±≈ü",
    apprentice: "√áƒ±rak",
    journeyman: "Kalfa",
    master: "Usta",
    grandmaster: "B√ºy√ºkusta",
    printService: "üñ®Ô∏è Baskƒ± Hizmeti",
    helpAvailable: "ü§ù Yardƒ±ma A√ßƒ±k",
    contact: "üí¨ ƒ∞leti≈üim",
    noMakersInCity: "'de hen√ºz maker yok",
    noMakersYet: "Hen√ºz haritada maker yok",
    beFirstOnMap: "ƒ∞lk haritaya eklenen sen ol!",
    disclaimerTitle: "‚ö†Ô∏è √ñnemli Uyarƒ±",
    disclaimerText: "3D-labX, kullanƒ±cƒ±lar arasƒ±nda sadece tanƒ±≈üma ortamƒ± saƒülar. Platform √ºzerinden ger√ßekle≈üen ileti≈üim, anla≈üma veya ticari i≈ülemlerden doƒüacak sorunlardan 3D-labX sorumlu deƒüildir. L√ºtfen tanƒ±≈ümadan √∂nce Sorumluluk Reddi metnini okuyun.",
    contactInfo: "üì¨ ƒ∞leti≈üim Bilgileri",
    copy: "Kopyala",
    copied: "Kopyalandƒ±!",
    open: "A√ß",
    send: "G√∂nder",
    noContactInfo: "Bu kullanƒ±cƒ± hen√ºz ileti≈üim bilgisi eklememi≈ü.",
    sampleProfile: "√ñrnek Profil",
    sampleProfileNote: "üß™ Bu √∂rnek bir profildir. Ger√ßek kullanƒ±cƒ±lar i√ßin ileti≈üim bilgileri g√∂r√ºnecektir.",
    contactNote: "‚ö†Ô∏è ƒ∞leti≈üim kurmadan √∂nce sorumluluk reddi metnini okuyun."
  },
  en: {
    pageTitle: "Maker Map - 3D Printers Community - 3D-labX",
    pageDesc: "Discover 3D printing enthusiasts. Meet makers in your city, get or give help.",
    heroTitle: "üó∫Ô∏è Maker Map",
    heroSubtitle: "Discover, meet, and create together with 3D printing enthusiasts from all around!",
    heroMakers: "Makers",
    heroActiveCities: "Active Cities",
    heroAllCountry: "Entire Country",
    breadcrumbCommunity: "Community",
    breadcrumbMap: "Maker Map",
    title: "üó∫Ô∏è Maker Map",
    subtitle: "Discover 3D printing enthusiasts",
    joinMap: "Join Map",
    totalMakers: "Total Makers",
    activeCities: "Active Cities",
    printingService: "Printing Service",
    infoBannerTitle: "What is Maker Map?",
    infoBannerDesc: "Find 3D printing enthusiasts in your city, meet them, get advice. Whether you need help or want to share your experience - Maker Map connects you with the right people.",
    infoBannerNote: "‚ö†Ô∏è Platform is for introductions only. Commercial transactions are users' responsibility.",
    citiesSidebar: "üìç Cities",
    allCountry: "All Cities",
    emptyCitiesNote: "cities are empty",
    makersInCity: " Makers",
    allMakers: "All Makers",
    filterPrintingService: "üñ®Ô∏è Offering printing service",
    verified: "Verified",
    apprentice: "Apprentice",
    journeyman: "Journeyman",
    master: "Master",
    grandmaster: "Grandmaster",
    printService: "üñ®Ô∏è Printing Service",
    helpAvailable: "ü§ù Available to Help",
    contact: "üí¨ Contact",
    noMakersInCity: " has no makers yet",
    noMakersYet: "No makers on the map yet",
    beFirstOnMap: "Be the first to join the map!",
    disclaimerTitle: "‚ö†Ô∏è Important Notice",
    disclaimerText: "3D-labX only provides a platform for introductions. 3D-labX is not responsible for any communication, agreements or commercial transactions between users. Please read the Disclaimer before connecting.",
    contactInfo: "üì¨ Contact Information",
    copy: "Copy",
    copied: "Copied!",
    open: "Open",
    send: "Send",
    noContactInfo: "This user hasn't added contact information yet.",
    sampleProfile: "Sample Profile",
    sampleProfileNote: "üß™ This is a sample profile. Real users will show contact information.",
    contactNote: "‚ö†Ô∏è Read the disclaimer before contacting."
  },
  de: {
    pageTitle: "Maker-Karte - 3D-Drucker-Community - 3D-labX",
    pageDesc: "Entdecken Sie 3D-Druck-Enthusiasten. Treffen Sie Maker in Ihrer Stadt, holen oder geben Sie Hilfe.",
    heroTitle: "üó∫Ô∏è Maker-Karte",
    heroSubtitle: "Entdecken, treffen und gemeinsam mit 3D-Druck-Enthusiasten aus aller Welt kreieren!",
    heroMakers: "Makers",
    heroActiveCities: "Aktive St√§dte",
    heroAllCountry: "Ganzes Land",
    breadcrumbCommunity: "Community",
    breadcrumbMap: "Maker-Karte",
    title: "üó∫Ô∏è Maker-Karte",
    subtitle: "Entdecken Sie 3D-Druck-Enthusiasten",
    joinMap: "Karte beitreten",
    totalMakers: "Gesamte Makers",
    activeCities: "Aktive St√§dte",
    printingService: "Druckservice",
    infoBannerTitle: "Was ist die Maker-Karte?",
    infoBannerDesc: "Finden Sie 3D-Druck-Enthusiasten in Ihrer Stadt, treffen Sie sie, holen Sie sich Rat. Ob Sie Hilfe brauchen oder Ihre Erfahrung teilen m√∂chten - Maker-Karte verbindet Sie mit den richtigen Menschen.",
    infoBannerNote: "‚ö†Ô∏è Plattform dient nur zur Vermittlung. Kommerzielle Transaktionen liegen in der Verantwortung der Benutzer.",
    citiesSidebar: "üìç St√§dte",
    allCountry: "Alle St√§dte",
    emptyCitiesNote: "St√§dte sind leer",
    makersInCity: " Makers",
    allMakers: "Alle Makers",
    filterPrintingService: "üñ®Ô∏è Bietet Druckservice",
    verified: "Verifiziert",
    apprentice: "Lehrling",
    journeyman: "Geselle",
    master: "Meister",
    grandmaster: "Gro√ümeister",
    printService: "üñ®Ô∏è Druckservice",
    helpAvailable: "ü§ù Hilfsbereit",
    contact: "üí¨ Kontakt",
    noMakersInCity: " hat noch keine Makers",
    noMakersYet: "Noch keine Makers auf der Karte",
    beFirstOnMap: "Sei der Erste auf der Karte!",
    disclaimerTitle: "‚ö†Ô∏è Wichtiger Hinweis",
    disclaimerText: "3D-labX bietet nur eine Plattform f√ºr Vermittlungen. 3D-labX ist nicht verantwortlich f√ºr Kommunikation, Vereinbarungen oder kommerzielle Transaktionen zwischen Benutzern. Bitte lesen Sie den Haftungsausschluss vor der Kontaktaufnahme.",
    contactInfo: "üì¨ Kontaktinformationen",
    copy: "Kopieren",
    copied: "Kopiert!",
    open: "√ñffnen",
    send: "Senden",
    noContactInfo: "Dieser Benutzer hat noch keine Kontaktinformationen hinzugef√ºgt.",
    sampleProfile: "Beispielprofil",
    sampleProfileNote: "üß™ Dies ist ein Beispielprofil. Echte Benutzer zeigen Kontaktinformationen.",
    contactNote: "‚ö†Ô∏è Lesen Sie den Haftungsausschluss vor der Kontaktaufnahme."
  }
};

const t = translations[lang];

const url = new URL(Astro.request.url);
const selectedCity = url.searchParams.get("city") || "";
const filterPrinting = url.searchParams.get("printing") === "1";

let cities: any[] = [];
let makers: any[] = [];

// ƒ∞lleri √ßek
try {
  const res = await fetch(`${API_BASE}/api/map/cities`);
  if (res.ok) {
    const data = await res.json();
    cities = data.cities || [];
  }
} catch (e) {
  console.error("Cities y√ºklenemedi:", e);
}

// Maker'larƒ± √ßek
try {
  let apiUrl = `${API_BASE}/api/map/makers?limit=50`;
  if (selectedCity) apiUrl += `&city=${encodeURIComponent(selectedCity)}`;
  if (filterPrinting) apiUrl += `&offers_printing=1`;

  const res = await fetch(apiUrl);
  if (res.ok) {
    const data = await res.json();
    makers = data.makers || [];
  }
} catch (e) {
  console.error("Makers y√ºklenemedi:", e);
}

// Printers'ƒ± parse et
function parsePrinters(printers: string): string[] {
  try {
    return JSON.parse(printers || '[]');
  } catch {
    return [];
  }
}

// Specialties'i parse et
function parseSpecialties(specialties: string): string[] {
  try {
    return JSON.parse(specialties || '[]');
  } catch {
    return [];
  }
}

// Level badge
function getLevelBadge(points: number): { emoji: string; label: string; color: string } {
  if (points >= 2000) return { emoji: 'üëë', label: t.grandmaster, color: '#FFD700' };
  if (points >= 501) return { emoji: '‚öôÔ∏è', label: t.master, color: '#8B5CF6' };
  if (points >= 101) return { emoji: 'üîß', label: t.journeyman, color: '#3B82F6' };
  return { emoji: 'üå±', label: t.apprentice, color: '#10B981' };
}

// Toplam maker sayƒ±sƒ±
const totalMakers = cities.reduce((sum, c) => sum + (c.maker_count || 0), 0);
---

<BaseLayout
  title={t.pageTitle}
  description={t.pageDesc}
>
  <Header />

  <!-- Hero Banner -->
  <section class="hero-banner">
    <div class="hero-image">
      <img
        src="https://tech-portal-api.turgut-d01.workers.dev/r2/maker-haritasi-hero.jpg"
        alt={t.heroTitle}
        loading="eager"
      />
      <div class="hero-overlay"></div>
    </div>
    <div class="hero-content">
      <h1>{t.heroTitle}</h1>
      <p>{t.heroSubtitle}</p>
      <div class="hero-stats">
        <div class="hero-stat">
          <span class="number">{totalMakers}</span>
          <span class="label">{t.heroMakers}</span>
        </div>
        <div class="hero-stat">
          <span class="number">{cities.filter(c => c.maker_count > 0).length}</span>
          <span class="label">{t.heroActiveCities}</span>
        </div>
        <div class="hero-stat">
          <span class="number">81</span>
          <span class="label">{t.heroAllCountry}</span>
        </div>
      </div>
    </div>
  </section>

  <main class="map-page">
    <div class="container">
      <div class="page-header">
        <div class="header-left">
          <nav class="breadcrumb">
            <a href="/topluluk">{t.breadcrumbCommunity}</a>
            <span>/</span>
            <span>{t.breadcrumbMap}</span>
          </nav>
          <h1>{t.title}</h1>
          <p>{t.subtitle}</p>
        </div>
        <div class="header-right">
          <a href="/topluluk/harita/profil" class="btn btn-primary" id="joinMapBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            {t.joinMap}
          </a>
        </div>
      </div>

      <!-- ƒ∞statistikler -->
      <div class="stats-overview">
        <div class="stat-card">
          <span class="stat-number">{totalMakers}</span>
          <span class="stat-label">{t.totalMakers}</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">{cities.filter(c => c.maker_count > 0).length}</span>
          <span class="stat-label">{t.activeCities}</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">{makers.filter(m => m.offers_printing).length}</span>
          <span class="stat-label">{t.printingService}</span>
        </div>
      </div>

      <!-- Info Banner -->
      <div class="info-banner">
        <div class="info-icon">ü§ù</div>
        <div class="info-content">
          <h3>{t.infoBannerTitle}</h3>
          <p>{t.infoBannerDesc}</p>
          <small>{t.infoBannerNote}</small>
        </div>
      </div>

      <div class="content-grid">
        <!-- Sol: ƒ∞l Listesi -->
        <aside class="cities-sidebar">
          <h3>{t.citiesSidebar}</h3>
          <div class="cities-list">
            <a
              href="/topluluk/harita"
              class={`city-item ${!selectedCity ? 'active' : ''}`}
            >
              <span class="city-name">{t.allCountry}</span>
              <span class="city-count">{totalMakers}</span>
            </a>
            {cities.filter(c => c.maker_count > 0).map(city => (
              <a
                href={`/topluluk/harita?city=${city.name}`}
                class={`city-item ${selectedCity === city.name ? 'active' : ''}`}
              >
                <span class="city-name">{city.name}</span>
                <span class="city-count">{city.maker_count}</span>
              </a>
            ))}
            {cities.filter(c => c.maker_count === 0).length > 0 && (
              <div class="empty-cities-note">
                <small>+ {cities.filter(c => c.maker_count === 0).length} {t.emptyCitiesNote}</small>
              </div>
            )}
          </div>
        </aside>

        <!-- Saƒü: Maker Listesi -->
        <div class="makers-section">
          <div class="section-header">
            <h2>
              {selectedCity ? `${selectedCity}${t.makersInCity}` : t.allMakers}
              <span class="count">({makers.length})</span>
            </h2>
            <div class="filters">
              <label class="filter-checkbox">
                <input
                  type="checkbox"
                  id="filterPrinting"
                  checked={filterPrinting}
                />
                <span>{t.filterPrintingService}</span>
              </label>
            </div>
          </div>

          <div class="makers-grid">
            {makers.length > 0 ? makers.map((maker) => {
              const printers = parsePrinters(maker.printers);
              const specialties = parseSpecialties(maker.specialties);
              const level = getLevelBadge(maker.reputation_points || 0);
              const isSample = maker.is_sample === 1;

              return (
                <div
                  class={`maker-card ${isSample ? 'sample-profile' : ''}`}
                  data-username={maker.username}
                  data-display-name={maker.display_name || maker.username}
                  data-city={maker.city}
                  data-district={maker.district || ''}
                  data-bio={maker.bio || ''}
                  data-printers={maker.printers || '[]'}
                  data-specialties={maker.specialties || '[]'}
                  data-user-id={maker.user_id || 0}
                  data-discord={maker.contact_discord || ''}
                  data-telegram={maker.contact_telegram || ''}
                  data-instagram={maker.contact_instagram || ''}
                  data-email={maker.contact_email || ''}
                  data-phone={maker.contact_phone || ''}
                  data-show-email={maker.show_email || 0}
                  data-show-phone={maker.show_phone || 0}
                  data-allow-messages={maker.allow_messages !== 0 ? '1' : '0'}
                  data-contact-preference={maker.contact_preference || 'message'}
                  data-offers-printing={maker.offers_printing}
                  data-offers-help={maker.offers_help}
                  data-reputation={maker.reputation_points || 0}
                  data-is-sample={isSample ? '1' : '0'}
                >
                  {isSample && <span class="sample-badge">{t.sampleProfile}</span>}
                  <div class="maker-header">
                    <div class="maker-avatar">
                      {maker.avatar_url ? (
                        <img src={maker.avatar_url} alt={maker.username} />
                      ) : (
                        <div class="avatar-placeholder">{maker.username?.charAt(0).toUpperCase()}</div>
                      )}
                      {maker.is_verified === 1 && <span class="verified-badge" title={t.verified}>‚úì</span>}
                    </div>
                    <div class="maker-info">
                      <span class="maker-name">@{maker.username}</span>
                      <div class="maker-location">
                        üìç {maker.city}{maker.district ? `, ${maker.district}` : ''}
                      </div>
                    </div>
                    <div class="maker-level" style={`color: ${level.color}`} title={`${level.label} - ${maker.reputation_points || 0} puan`}>
                      <span class="level-emoji">{level.emoji}</span>
                      <span class="level-label">{level.label}</span>
                    </div>
                  </div>

                  {maker.bio && (
                    <p class="maker-bio">{maker.bio.substring(0, 120)}{maker.bio.length > 120 ? '...' : ''}</p>
                  )}

                  {printers.length > 0 && (
                    <div class="maker-printers">
                      <span class="printers-label">üñ®Ô∏è</span>
                      <span class="printers-list">{printers.slice(0, 3).join(', ')}{printers.length > 3 ? ` +${printers.length - 3}` : ''}</span>
                    </div>
                  )}

                  {specialties.length > 0 && (
                    <div class="maker-specialties">
                      {specialties.slice(0, 3).map(spec => (
                        <span class="specialty-tag">{spec}</span>
                      ))}
                    </div>
                  )}

                  <div class="maker-footer">
                    <div class="maker-services">
                      {maker.offers_printing === 1 && (
                        <span class="service-badge printing">{t.printService}</span>
                      )}
                      {maker.offers_help === 1 && (
                        <span class="service-badge help">{t.helpAvailable}</span>
                      )}
                    </div>
                    <button
                      class="contact-btn"
                      data-username={maker.username}
                      data-display-name={maker.display_name || maker.username}
                      data-city={maker.city}
                      data-district={maker.district || ''}
                      data-discord={maker.contact_discord || ''}
                      data-telegram={maker.contact_telegram || ''}
                      data-instagram={maker.contact_instagram || ''}
                      data-email={maker.contact_email || ''}
                    >
                      {t.contact}
                    </button>
                  </div>
                </div>
              );
            }) : (
              <div class="empty-state">
                <div class="empty-icon">üó∫Ô∏è</div>
                <h3>{selectedCity ? `${selectedCity}${t.noMakersInCity}` : t.noMakersYet}</h3>
                <p>{t.beFirstOnMap}</p>
                <a href="/topluluk/harita/profil" class="btn btn-primary">{t.joinMap}</a>
              </div>
            )}
          </div>
        </div>
      </div>

      <!-- Sorumluluk Reddi -->
      <div class="disclaimer">
        <h4>{t.disclaimerTitle}</h4>
        <p>{t.disclaimerText}</p>
      </div>
    </div>
  </main>

  <!-- ƒ∞leti≈üim Modal (Yeni Tasarƒ±m) -->
  <div id="contactModal" class="contact-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button class="modal-close" id="closeModal">&times;</button>

      <!-- Header -->
      <div class="modal-header">
        <div class="modal-avatar" id="modalAvatar">T</div>
        <div class="modal-user-info">
          <h3 id="modalUsername">@username</h3>
          <p id="modalLocation">ƒ∞stanbul, Kadƒ±k√∂y</p>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="contact">
          <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          {lang === 'tr' ? 'ƒ∞leti≈üim' : lang === 'de' ? 'Kontakt' : 'Contact'}
        </button>
        <button class="modal-tab" data-tab="message" id="messageTab">
          <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          {lang === 'tr' ? 'Mesaj G√∂nder' : lang === 'de' ? 'Nachricht' : 'Message'}
        </button>
      </div>

      <!-- Contact Tab -->
      <div class="modal-tab-content active" id="tabContact">
        <div class="contact-list" id="contactList">
          <!-- JS ile doldurulacak -->
        </div>
        <div class="contact-note">
          <small>{t.contactNote}</small>
        </div>
      </div>

      <!-- Message Tab -->
      <div class="modal-tab-content" id="tabMessage">
        <div class="message-form" id="messageForm">
          <div class="message-login-notice hidden" id="msgLoginNotice">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
            <p>{lang === 'tr' ? 'Mesaj g√∂ndermek i√ßin giri≈ü yapƒ±n.' : lang === 'de' ? 'Melden Sie sich an, um eine Nachricht zu senden.' : 'Sign in to send a message.'}</p>
            <a href="/auth/giris" class="msg-login-btn">{lang === 'tr' ? 'Giri≈ü Yap' : lang === 'de' ? 'Anmelden' : 'Sign In'}</a>
          </div>
          <div class="message-disabled hidden" id="msgDisabledNotice">
            <p>{lang === 'tr' ? 'Bu kullanƒ±cƒ± site i√ßi mesaj kabul etmiyor.' : lang === 'de' ? 'Dieser Benutzer akzeptiert keine Nachrichten.' : 'This user does not accept messages.'}</p>
          </div>
          <div class="message-input-area" id="msgInputArea">
            <textarea id="messageInput" placeholder={lang === 'tr' ? 'Mesajƒ±nƒ±zƒ± yazƒ±n... (Kendinizi tanƒ±tƒ±n, ne hakkƒ±nda yardƒ±m istediƒüinizi belirtin)' : lang === 'de' ? 'Schreiben Sie Ihre Nachricht...' : 'Write your message...'} rows="4" maxlength="1000"></textarea>
            <div class="message-footer">
              <span class="msg-char-count"><span id="msgCharCount">0</span>/1000</span>
              <button type="button" class="msg-send-btn" id="sendMessageBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                {lang === 'tr' ? 'G√∂nder' : lang === 'de' ? 'Senden' : 'Send'}
              </button>
            </div>
          </div>
          <div class="message-success hidden" id="msgSuccess">
            <span class="success-icon">‚úÖ</span>
            <p>{lang === 'tr' ? 'Mesajƒ±nƒ±z g√∂nderildi!' : lang === 'de' ? 'Nachricht gesendet!' : 'Message sent!'}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Hero Banner */
  .hero-banner {
    position: relative;
    width: 100%;
    height: 400px;
    overflow: hidden;
    margin-top: 80px;
  }

  .hero-image {
    position: absolute;
    inset: 0;
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.3) 0%,
      rgba(0, 0, 0, 0.6) 100%
    );
  }

  .hero-content {
    position: relative;
    z-index: 10;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    color: white;
  }

  .hero-content h1 {
    font-size: 2.8rem;
    margin: 0 0 12px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  }

  .hero-content p {
    font-size: 1.2rem;
    margin: 0 0 30px;
    max-width: 600px;
    opacity: 0.95;
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
  }

  .hero-stats {
    display: flex;
    gap: 40px;
  }

  .hero-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .hero-stat .number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #FFD700;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  }

  .hero-stat .label {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  @media (max-width: 768px) {
    .hero-banner {
      height: 350px;
      margin-top: 70px;
    }

    .hero-content h1 {
      font-size: 2rem;
    }

    .hero-content p {
      font-size: 1rem;
    }

    .hero-stats {
      gap: 24px;
    }

    .hero-stat .number {
      font-size: 1.8rem;
    }
  }

  .map-page {
    padding-top: 40px;
    padding-bottom: 64px;
    min-height: 100vh;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Sample Profile Badge */
  .maker-card {
    position: relative;
    cursor: pointer;
  }

  .maker-card.sample-profile {
    border-style: dashed;
    opacity: 0.85;
  }

  .sample-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 4px 10px;
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 5;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    gap: 20px;
    flex-wrap: wrap;
  }

  .breadcrumb {
    display: flex;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .breadcrumb a { color: #8B5CF6; text-decoration: none; }

  .page-header h1 { margin: 0 0 8px; font-size: 1.8rem; }
  .page-header p { margin: 0; color: var(--text-muted); }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    color: white;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(139, 92, 246, 0.4);
  }

  /* ƒ∞statistikler */
  .stats-overview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    padding: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    text-align: center;
  }

  .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: #8B5CF6;
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  /* Info Banner */
  .info-banner {
    display: flex;
    gap: 20px;
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.05));
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 16px;
    margin-bottom: 24px;
  }

  .info-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
  }

  .info-content h3 {
    margin: 0 0 8px;
    font-size: 1rem;
    color: #8B5CF6;
  }

  .info-content p {
    margin: 0 0 8px;
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .info-content small {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  /* Content Grid */
  .content-grid {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 24px;
  }

  /* Cities Sidebar */
  .cities-sidebar {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 140px;
  }

  .cities-sidebar h3 {
    margin: 0 0 16px;
    font-size: 1rem;
  }

  .cities-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 500px;
    overflow-y: auto;
  }

  .city-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 10px;
    text-decoration: none;
    color: var(--text-main);
    transition: all 0.2s ease;
  }

  .city-item:hover {
    background: var(--bg-main);
  }

  .city-item.active {
    background: #8B5CF6;
    color: white;
  }

  .city-count {
    padding: 2px 8px;
    background: var(--bg-main);
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .city-item.active .city-count {
    background: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .empty-cities-note {
    padding: 12px;
    text-align: center;
    color: var(--text-light);
  }

  /* Makers Section */
  .makers-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .section-header h2 {
    margin: 0;
    font-size: 1.3rem;
  }

  .section-header .count {
    font-weight: 400;
    color: var(--text-muted);
    font-size: 1rem;
  }

  .filter-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 10px;
    font-size: 0.9rem;
    color: var(--text-muted);
    transition: all 0.2s ease;
  }

  .filter-checkbox:hover {
    border-color: #8B5CF6;
  }

  .filter-checkbox input {
    accent-color: #8B5CF6;
  }

  .makers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
  }

  .maker-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 20px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: all 0.2s ease;
  }

  .maker-card:hover {
    border-color: #8B5CF6;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
  }

  .maker-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .maker-avatar {
    position: relative;
    width: 56px;
    height: 56px;
    flex-shrink: 0;
  }

  .maker-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 14px;
    object-fit: cover;
  }

  .maker-avatar .avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    font-size: 1.3rem;
    font-weight: 600;
    border-radius: 14px;
  }

  .verified-badge {
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 20px;
    height: 20px;
    background: #10B981;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    border: 2px solid var(--bg-card);
  }

  .maker-info {
    flex: 1;
    min-width: 0;
  }

  .maker-name {
    font-weight: 600;
    font-size: 1.05rem;
    color: var(--text-main);
    text-decoration: none;
    display: block;
    margin-bottom: 4px;
  }

  .maker-name:hover {
    color: #8B5CF6;
  }

  .maker-location {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .maker-level {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 8px 12px;
    background: var(--bg-main);
    border-radius: 10px;
  }

  .level-emoji {
    font-size: 1.2rem;
  }

  .level-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .maker-bio {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .maker-printers {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .printers-label {
    flex-shrink: 0;
  }

  .maker-specialties {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .specialty-tag {
    padding: 4px 10px;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 6px;
    font-size: 0.75rem;
    color: #8B5CF6;
  }

  .maker-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 12px;
    border-top: 1px solid var(--border-soft);
  }

  .maker-services {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .service-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .service-badge.printing {
    background: rgba(249, 115, 22, 0.1);
    color: #F97316;
  }

  .service-badge.help {
    background: rgba(16, 185, 129, 0.1);
    color: #10B981;
  }

  .contact-btn {
    padding: 8px 16px;
    background: #8B5CF6;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .contact-btn:hover {
    background: #7C3AED;
    transform: translateY(-2px);
  }

  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    background: var(--bg-card);
    border: 2px dashed var(--border-soft);
    border-radius: 20px;
  }

  .empty-icon { font-size: 4rem; margin-bottom: 16px; }
  .empty-state h3 { margin: 0 0 8px; font-size: 1.2rem; }
  .empty-state p { color: var(--text-muted); margin-bottom: 20px; }

  /* Disclaimer */
  .disclaimer {
    margin-top: 48px;
    padding: 20px 24px;
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 16px;
  }

  .disclaimer h4 {
    margin: 0 0 8px;
    color: #EF4444;
    font-size: 0.95rem;
  }

  .disclaimer p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .disclaimer a {
    color: #EF4444;
    font-weight: 500;
  }

  @media (max-width: 900px) {
    .content-grid {
      grid-template-columns: 1fr;
    }

    .cities-sidebar {
      position: static;
    }

    .cities-list {
      max-height: none;
      flex-direction: row;
      flex-wrap: wrap;
    }

    .stats-overview {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 640px) {
    .map-page {
      padding-top: 120px;
    }

    .page-header {
      flex-direction: column;
    }

    .info-banner {
      flex-direction: column;
      text-align: center;
    }

    .makers-grid {
      grid-template-columns: 1fr;
    }

    .maker-footer {
      flex-direction: column;
      gap: 12px;
    }

    .contact-btn {
      width: 100%;
    }
  }

  /* Contact Modal */
  .contact-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .contact-modal.active {
    display: flex;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: relative;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 20px;
    padding: 0;
    max-width: 440px;
    width: 92%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalIn 0.25s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-main);
    border-radius: 8px;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 2;
  }

  .modal-close:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #EF4444;
  }

  .modal-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px 24px 16px;
  }

  .modal-avatar {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    font-weight: 600;
    flex-shrink: 0;
  }

  .modal-user-info h3 {
    margin: 0 0 4px;
    font-size: 1.05rem;
    color: var(--text-main);
  }

  .modal-user-info p {
    margin: 0;
    font-size: 0.82rem;
    color: var(--text-muted);
  }

  /* Tab Navigation */
  .modal-tabs {
    display: flex;
    gap: 0;
    padding: 0 24px;
    border-bottom: 2px solid var(--border-soft);
  }

  .modal-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .modal-tab:hover {
    color: #8B5CF6;
  }

  .modal-tab.active {
    color: #8B5CF6;
    border-bottom-color: #8B5CF6;
  }

  .modal-tab svg {
    flex-shrink: 0;
  }

  /* Tab Content */
  .modal-tab-content {
    display: none;
    padding: 20px 24px 24px;
  }

  .modal-tab-content.active {
    display: block;
  }

  /* Contact List */
  .contact-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .contact-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--bg-main);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text-main);
    transition: all 0.2s ease;
  }

  .contact-item:hover {
    background: rgba(139, 92, 246, 0.08);
    border-color: rgba(139, 92, 246, 0.3);
  }

  .contact-item.preferred {
    border-color: rgba(139, 92, 246, 0.4);
    background: rgba(139, 92, 246, 0.05);
  }

  .contact-icon {
    font-size: 1.2rem;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
    border-radius: 10px;
    flex-shrink: 0;
  }

  .contact-info {
    flex: 1;
    min-width: 0;
  }

  .contact-label {
    display: block;
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-bottom: 1px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .contact-value {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--text-main);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .contact-preferred-tag {
    font-size: 0.65rem;
    padding: 2px 6px;
    background: rgba(139, 92, 246, 0.15);
    color: #8B5CF6;
    border-radius: 4px;
    font-weight: 600;
    white-space: nowrap;
  }

  .contact-action {
    padding: 6px 12px;
    background: #8B5CF6;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .contact-action:hover {
    background: #7C3AED;
  }

  .contact-note {
    margin-top: 16px;
    padding: 10px 14px;
    background: rgba(251, 191, 36, 0.08);
    border: 1px solid rgba(251, 191, 36, 0.15);
    border-radius: 10px;
    text-align: center;
  }

  .contact-note small {
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .no-contact {
    text-align: center;
    padding: 24px 16px;
    color: var(--text-muted);
  }

  /* Message Tab */
  .message-form {
    min-height: 180px;
  }

  .message-login-notice,
  .message-disabled {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 32px 16px;
    text-align: center;
  }

  .message-login-notice svg { color: #8B5CF6; }
  .message-login-notice p,
  .message-disabled p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .msg-login-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 24px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .msg-login-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .message-input-area textarea {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-main);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    font-size: 0.9rem;
    color: var(--text-main);
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    box-sizing: border-box;
    transition: border-color 0.2s ease;
  }

  .message-input-area textarea:focus {
    outline: none;
    border-color: #8B5CF6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  .message-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
  }

  .msg-char-count {
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .msg-send-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .msg-send-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .msg-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .message-success {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 32px 16px;
    text-align: center;
  }

  .message-success .success-icon {
    font-size: 2.5rem;
  }

  .message-success p {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #10B981;
  }

  .hidden { display: none !important; }
</style>

<script define:vars={{ jsTranslations: { copy: t.copy, copied: t.copied, open: t.open, send: t.send, sampleProfile: t.sampleProfile, sampleProfileNote: t.sampleProfileNote, noContactInfo: t.noContactInfo }, jsLang: lang }}>
  const t = jsTranslations;
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';
  let currentTargetUserId = null;

  // Filter checkbox
  const filterCheckbox = document.getElementById('filterPrinting');
  filterCheckbox?.addEventListener('change', () => {
    const url = new URL(window.location.href);
    if (filterCheckbox.checked) {
      url.searchParams.set('printing', '1');
    } else {
      url.searchParams.delete('printing');
    }
    window.location.href = url.toString();
  });

  // Modal elementleri
  const modal = document.getElementById('contactModal');
  const modalBackdrop = modal?.querySelector('.modal-backdrop');
  const closeModalBtn = document.getElementById('closeModal');
  const modalAvatar = document.getElementById('modalAvatar');
  const modalUsername = document.getElementById('modalUsername');
  const modalLocation = document.getElementById('modalLocation');
  const contactList = document.getElementById('contactList');

  // Tab elementleri
  const tabContact = document.getElementById('tabContact');
  const tabMessage = document.getElementById('tabMessage');
  const modalTabs = document.querySelectorAll('.modal-tab');

  // Mesaj elementleri
  const msgLoginNotice = document.getElementById('msgLoginNotice');
  const msgDisabledNotice = document.getElementById('msgDisabledNotice');
  const msgInputArea = document.getElementById('msgInputArea');
  const msgSuccess = document.getElementById('msgSuccess');
  const messageInput = document.getElementById('messageInput');
  const msgCharCount = document.getElementById('msgCharCount');
  const sendMessageBtn = document.getElementById('sendMessageBtn');

  function getAuthToken() {
    return localStorage.getItem('authToken');
  }

  // Tab switching
  modalTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      modalTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      if (tabName === 'contact') {
        tabContact?.classList.add('active');
        tabMessage?.classList.remove('active');
      } else {
        tabContact?.classList.remove('active');
        tabMessage?.classList.add('active');
      }
    });
  });

  // Modal'ƒ± kapat
  function closeModal() {
    modal?.classList.remove('active');
    currentTargetUserId = null;
    // Reset tabs
    modalTabs.forEach(t => t.classList.remove('active'));
    modalTabs[0]?.classList.add('active');
    tabContact?.classList.add('active');
    tabMessage?.classList.remove('active');
    // Reset message form
    if (messageInput) messageInput.value = '';
    if (msgCharCount) msgCharCount.textContent = '0';
    msgSuccess?.classList.add('hidden');
    msgInputArea?.classList.remove('hidden');
  }

  modalBackdrop?.addEventListener('click', closeModal);
  closeModalBtn?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // Kopyalama fonksiyonu
  function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
      const original = btn.textContent;
      btn.textContent = t.copied;
      btn.style.background = '#10B981';
      setTimeout(() => {
        btn.textContent = original;
        btn.style.background = '';
      }, 1500);
    });
  }

  // Karakter sayacƒ±
  messageInput?.addEventListener('input', () => {
    if (msgCharCount) msgCharCount.textContent = messageInput.value.length.toString();
  });

  // Mesaj g√∂nder
  sendMessageBtn?.addEventListener('click', async () => {
    if (!currentTargetUserId || !messageInput?.value?.trim()) return;

    const token = getAuthToken();
    if (!token) return;

    sendMessageBtn.disabled = true;
    sendMessageBtn.textContent = jsLang === 'tr' ? 'G√∂nderiliyor...' : 'Sending...';

    try {
      const res = await fetch(`${API_URL}/api/messages`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          to_user_id: currentTargetUserId,
          content: messageInput.value.trim()
        })
      });

      const data = await res.json();

      if (res.ok) {
        msgInputArea?.classList.add('hidden');
        msgSuccess?.classList.remove('hidden');
      } else {
        const errMsg = data.error || 'Hata olu≈ütu';
        alert(errMsg);
      }
    } catch (err) {
      alert('Baƒülantƒ± hatasƒ±');
    } finally {
      sendMessageBtn.disabled = false;
      const sendText = jsLang === 'tr' ? 'G√∂nder' : jsLang === 'de' ? 'Senden' : 'Send';
      sendMessageBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> ${sendText}`;
    }
  });

  // Preferred label
  const prefLabel = jsLang === 'tr' ? 'Tercih' : jsLang === 'de' ? 'Bevorzugt' : 'Preferred';

  // Modal'ƒ± a√ß fonksiyonu
  function openModal(element) {
    const username = element.getAttribute('data-username') || '';
    const displayName = element.getAttribute('data-display-name') || username;
    const city = element.getAttribute('data-city') || '';
    const district = element.getAttribute('data-district') || '';
    const discord = element.getAttribute('data-discord') || '';
    const telegram = element.getAttribute('data-telegram') || '';
    const instagram = element.getAttribute('data-instagram') || '';
    const email = element.getAttribute('data-email') || '';
    const phone = element.getAttribute('data-phone') || '';
    const showEmail = element.getAttribute('data-show-email') === '1';
    const showPhone = element.getAttribute('data-show-phone') === '1';
    const allowMessages = element.getAttribute('data-allow-messages') === '1';
    const contactPref = element.getAttribute('data-contact-preference') || 'message';
    const isSample = element.getAttribute('data-is-sample') === '1';
    const userId = parseInt(element.getAttribute('data-user-id') || '0');

    currentTargetUserId = userId;

    // Modal bilgilerini doldur
    if (modalAvatar) modalAvatar.textContent = displayName.charAt(0).toUpperCase();
    if (modalUsername) {
      modalUsername.innerHTML = `@${username}${isSample ? ` <span style="font-size:0.7rem;color:#F59E0B;background:rgba(245,158,11,0.15);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.sampleProfile}</span>` : ''}`;
    }
    if (modalLocation) modalLocation.textContent = district ? `${city}, ${district}` : city;

    // ƒ∞leti≈üim listesini olu≈ütur
    let contactHTML = '';

    // Site i√ßi mesaj (her zaman g√∂ster eƒüer kabul ediyorsa)
    if (allowMessages && !isSample) {
      const isPreferred = contactPref === 'message';
      contactHTML += `
        <div class="contact-item${isPreferred ? ' preferred' : ''}" style="cursor:pointer;" onclick="document.querySelector('[data-tab=message]').click()">
          <span class="contact-icon">üí¨</span>
          <div class="contact-info">
            <span class="contact-label">${jsLang === 'tr' ? 'Sƒ∞TE ƒ∞√áƒ∞ MESAJ' : jsLang === 'de' ? 'PLATTFORM-NACHRICHT' : 'PLATFORM MESSAGE'}</span>
            <span class="contact-value">${jsLang === 'tr' ? 'Mesaj g√∂ndermek i√ßin tƒ±kla' : jsLang === 'de' ? 'Klicken zum Senden' : 'Click to send message'}</span>
          </div>
          ${isPreferred ? `<span class="contact-preferred-tag">${prefLabel}</span>` : ''}
        </div>
      `;
    }

    if (discord) {
      const isPreferred = contactPref === 'discord';
      contactHTML += `
        <div class="contact-item${isPreferred ? ' preferred' : ''}">
          <span class="contact-icon">üéÆ</span>
          <div class="contact-info">
            <span class="contact-label">DISCORD</span>
            <span class="contact-value">${discord}</span>
          </div>
          ${isPreferred ? `<span class="contact-preferred-tag">${prefLabel}</span>` : ''}
          <button class="contact-action" onclick="copyToClipboard('${discord}', this)">${t.copy}</button>
        </div>
      `;
    }

    if (telegram) {
      const isPreferred = contactPref === 'telegram';
      contactHTML += `
        <a href="https://t.me/${telegram.replace('@', '')}" target="_blank" class="contact-item${isPreferred ? ' preferred' : ''}">
          <span class="contact-icon">‚úàÔ∏è</span>
          <div class="contact-info">
            <span class="contact-label">TELEGRAM</span>
            <span class="contact-value">${telegram}</span>
          </div>
          ${isPreferred ? `<span class="contact-preferred-tag">${prefLabel}</span>` : ''}
          <span class="contact-action">${t.open}</span>
        </a>
      `;
    }

    if (instagram) {
      const isPreferred = contactPref === 'instagram';
      contactHTML += `
        <a href="https://instagram.com/${instagram.replace('@', '')}" target="_blank" class="contact-item${isPreferred ? ' preferred' : ''}">
          <span class="contact-icon">üì∏</span>
          <div class="contact-info">
            <span class="contact-label">INSTAGRAM</span>
            <span class="contact-value">${instagram}</span>
          </div>
          ${isPreferred ? `<span class="contact-preferred-tag">${prefLabel}</span>` : ''}
          <span class="contact-action">${t.open}</span>
        </a>
      `;
    }

    if (email && showEmail) {
      const isPreferred = contactPref === 'email';
      contactHTML += `
        <a href="mailto:${email}" class="contact-item${isPreferred ? ' preferred' : ''}">
          <span class="contact-icon">üìß</span>
          <div class="contact-info">
            <span class="contact-label">E-POSTA</span>
            <span class="contact-value">${email}</span>
          </div>
          ${isPreferred ? `<span class="contact-preferred-tag">${prefLabel}</span>` : ''}
          <span class="contact-action">${t.send}</span>
        </a>
      `;
    }

    if (phone && showPhone) {
      const isPreferred = contactPref === 'phone';
      contactHTML += `
        <a href="tel:${phone}" class="contact-item${isPreferred ? ' preferred' : ''}">
          <span class="contact-icon">üì±</span>
          <div class="contact-info">
            <span class="contact-label">${jsLang === 'tr' ? 'TELEFON' : jsLang === 'de' ? 'TELEFON' : 'PHONE'}</span>
            <span class="contact-value">${phone}</span>
          </div>
          ${isPreferred ? `<span class="contact-preferred-tag">${prefLabel}</span>` : ''}
          <span class="contact-action">${jsLang === 'tr' ? 'Ara' : jsLang === 'de' ? 'Anrufen' : 'Call'}</span>
        </a>
      `;
    }

    if (!contactHTML) {
      contactHTML = isSample
        ? `<div class="no-contact">${t.sampleProfileNote}</div>`
        : `<div class="no-contact">${t.noContactInfo}</div>`;
    }

    if (contactList) contactList.innerHTML = contactHTML;

    // Mesaj tab'ƒ±nƒ± ayarla
    msgSuccess?.classList.add('hidden');
    msgLoginNotice?.classList.add('hidden');
    msgDisabledNotice?.classList.add('hidden');
    msgInputArea?.classList.add('hidden');

    if (isSample) {
      msgDisabledNotice?.classList.remove('hidden');
      if (msgDisabledNotice) msgDisabledNotice.querySelector('p').textContent = t.sampleProfileNote;
    } else if (!allowMessages) {
      msgDisabledNotice?.classList.remove('hidden');
    } else if (!getAuthToken()) {
      msgLoginNotice?.classList.remove('hidden');
    } else {
      msgInputArea?.classList.remove('hidden');
    }

    // Reset message
    if (messageInput) messageInput.value = '';
    if (msgCharCount) msgCharCount.textContent = '0';

    // Modal'ƒ± a√ß
    modal?.classList.add('active');
  }

  // Maker kartlarƒ±na tƒ±klama
  const makerCards = document.querySelectorAll('.maker-card');
  makerCards.forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('.contact-btn')) return;
      openModal(card);
    });
  });

  // ƒ∞leti≈üim butonlarƒ±
  const contactBtns = document.querySelectorAll('.contact-btn');
  contactBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const card = btn.closest('.maker-card');
      if (card) openModal(card);
    });
  });

  // Global fonksiyon
  window.copyToClipboard = copyToClipboard;
</script>
