---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import { getApiBase, getPostUrl, type Language } from "../../lib/api";

export const prerender = false;

const lang: Language = "de";

const t = {
  pageTitle: "3D-Drucker Bewertungen",
  pageDesc: "Ausführliche Bewertungen von 3D-Druckern, Filamenten und Zubehör",
  badge: "Bewertungen",
  newsCount: "Bewertungen",
  lastUpdate: "Letzte Aktualisierung",
  featured: "Redaktionsempfehlung",
  errorTitle: "Beim Laden ist ein Fehler aufgetreten.",
  noContent: "Noch keine Bewertungen vorhanden.",
  backHome: "Zurück zur Startseite"
};

type Post = { id: number; title: string; summary: string; slug: string; category: string; image_url?: string; is_featured: number; created_at?: string; };

const API_BASE = getApiBase(Astro.request);
let posts: Post[] = [];
let error: string | null = null;

try {
  const res = await fetch(`${API_BASE}/api/posts?category=incelemeler&limit=50&lang=de`, { headers: { "Accept": "application/json" } });
  if (!res.ok) throw new Error(`API Fehler: ${res.status}`);
  const data = await res.json();
  posts = data.posts || [];
} catch (e) { error = e instanceof Error ? e.message : "Unbekannter Fehler"; }

const title = `${t.pageTitle} – 3D-labX`;
const today = new Date().toLocaleDateString("de-DE", { year: "numeric", month: "long", day: "numeric" });
---

<BaseLayout title={title} description={t.pageDesc}>
  <Header />
  <main class="category-page">
    <div class="container">
      <div class="page-header">
        <div class="page-title-group">
          <div class="title-badge"><span>{t.badge}</span></div>
          <h1>{t.pageTitle}</h1>
          <p class="page-desc">{t.pageDesc}</p>
        </div>
        <div class="post-stats">
          <span class="post-count">{posts.length} {t.newsCount}</span>
          <span class="update-date">{t.lastUpdate}: {today}</span>
        </div>
      </div>
      {error && <div class="message message-error"><p>{t.errorTitle}: {error}</p></div>}
      {!error && posts.length === 0 && <div class="empty-state"><h2>Noch keine Bewertungen</h2><p>{t.noContent}</p><a href="/">{t.backHome}</a></div>}
      {posts.length > 0 && (
        <div class="bento-grid">
          {posts.map((post, index) => (
            <a href={getPostUrl("incelemeler", post.slug, lang)} class={`bento-card ${index < 2 ? 'bento-wide' : ''}`}>
              {post.image_url && <div class="bento-image"><img src={post.image_url} alt={post.title} loading="lazy" /></div>}
              <div class="bento-content">
                {post.is_featured === 1 && <span class="bento-badge">{t.featured}</span>}
                <h3>{post.title}</h3>
                <p>{post.summary}</p>
                {post.created_at && <time class="bento-date">{new Date(post.created_at).toLocaleDateString("de-DE", { month: "short", day: "numeric" })}</time>}
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
  </main>
</BaseLayout>

<style>
  .category-page { padding-top: 140px; padding-bottom: 64px; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
  .page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
  .page-title-group { display: flex; flex-direction: column; gap: 8px; }
  .title-badge { display: inline-flex; padding: 6px 12px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 20px; color: #A855F7; font-size: 0.8rem; font-weight: 600; width: fit-content; }
  .page-header h1 { margin: 0; font-size: 2rem; background: linear-gradient(135deg, var(--text-main), var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .page-desc { color: var(--text-muted); font-size: 1rem; margin: 0; }
  .post-stats { display: flex; gap: 8px; }
  .post-count { padding: 8px 16px; background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: 20px; color: var(--text-muted); font-size: 0.85rem; }
  .update-date { padding: 8px 16px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05)); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 20px; color: #A855F7; font-size: 0.8rem; }
  .bento-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
  .bento-card { background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: 16px; overflow: hidden; text-decoration: none; display: flex; flex-direction: column; transition: transform 0.3s ease; }
  .bento-card:hover { transform: translateY(-4px); border-color: rgba(168, 85, 247, 0.4); }
  .bento-card.bento-wide { grid-column: span 2; }
  .bento-image { aspect-ratio: 16/10; overflow: hidden; }
  .bento-wide .bento-image { aspect-ratio: 21/10; }
  .bento-image img { width: 100%; height: 100%; object-fit: cover; }
  .bento-content { padding: 12px 14px; display: flex; flex-direction: column; flex: 1; }
  .bento-badge { display: inline-block; width: fit-content; padding: 3px 8px; background: linear-gradient(135deg, #A855F7, #9333EA); color: white; font-size: 0.65rem; border-radius: 6px; margin-bottom: 8px; }
  .bento-content h3 { margin: 0 0 8px; font-size: 1rem; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .bento-content p { margin: 0; font-size: 0.85rem; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1; }
  .bento-date { margin-top: 12px; font-size: 0.75rem; color: var(--text-light); }
  .empty-state { text-align: center; padding: 60px 20px; }
  @media (max-width: 900px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 640px) { .category-page { padding-top: 120px; } .bento-grid { grid-template-columns: 1fr; } .bento-card.bento-wide { grid-column: span 1; } }
</style>
