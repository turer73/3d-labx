---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import { getApiBase } from "../lib/api";

type Result = {
  id: number;
  title_tr: string;
  summary_tr: string;
  slug: string;
  category: string;
  image_url?: string;
  created_at?: string;
};

type SearchResponse = {
  results: Result[];
  query: string;
  total: number;
};

const API_BASE = getApiBase(Astro.request);
const q = Astro.url.searchParams.get("q")?.trim() || "";

let results: Result[] = [];
let total = 0;
let error: string | null = null;

if (q) {
  try {
    const res = await fetch(
      `${API_BASE}/api/search?q=${encodeURIComponent(q)}`,
      { headers: { "Accept": "application/json" } }
    );

    if (!res.ok) {
      throw new Error(`API hatasÄ±: ${res.status}`);
    }

    const data: SearchResponse = await res.json();
    results = data.results || [];
    total = data.total || results.length;
  } catch (e) {
    error = e instanceof Error ? e.message : "Bilinmeyen hata";
    console.error("Arama hatasÄ±:", error);
  }
}

const title = q
  ? `Arama: "${q}" â€“ 3D-labX`
  : "Arama â€“ 3D-labX";

const description = q
  ? `"${q}" iÃ§in ${total} sonuÃ§ bulundu.`
  : "Site iÃ§inde arama yapÄ±n.";

const categoryNames: Record<string, string> = {
  "3d-baski": "3D BaskÄ±",
  "teknoloji": "Teknoloji",
  "yapay-zeka": "Yapay Zeka"
};
---

<BaseLayout title={title} description={description} noIndex={true}>
  <Header />

  <main class="search-page">
    <div class="container">
      <div class="search-header">
      <h1>Arama</h1>

      <form action="/search" method="get" class="search-box">
        <input
          type="search"
          name="q"
          value={q}
          placeholder="Ne aramak istiyorsunuz?"
          aria-label="Arama sorgusu"
          autocomplete="off"
          autofocus
        />
        <button type="submit" class="btn btn-primary">Ara</button>
      </form>
    </div>

    {error && (
      <div class="message message-error">
        <p><strong>Arama yapÄ±lÄ±rken bir hata oluÅŸtu.</strong></p>
        <p class="text-sm">{error}</p>
      </div>
    )}

    {!q && !error && (
      <div class="search-empty">
        <div class="search-icon">ğŸ”</div>
        <p>Arama yapmak iÃ§in yukarÄ±daki kutuya bir kelime yazÄ±n.</p>
      </div>
    )}

    {q && !error && results.length === 0 && (
      <div class="no-results">
        <div class="no-results-icon">ğŸ˜•</div>
        <h2>SonuÃ§ BulunamadÄ±</h2>
        <p>
          <strong>"{q}"</strong> iÃ§in sonuÃ§ bulunamadÄ±.
        </p>
        <ul class="suggestions">
          <li>FarklÄ± anahtar kelimeler deneyin</li>
          <li>Daha genel terimler kullanÄ±n</li>
          <li>YazÄ±m hatasÄ± olmadÄ±ÄŸÄ±ndan emin olun</li>
        </ul>
      </div>
    )}

    {q && results.length > 0 && (
      <div class="results-section">
        <p class="results-count">
          <strong>"{q}"</strong> iÃ§in {total} sonuÃ§ bulundu
        </p>

        <div class="results-list">
          {results.map((result) => (
            <article class="result-card">
              {result.image_url && (
                <a href={`/${result.category}/${result.slug}`} class="result-image">
                  <img src={result.image_url} alt={result.title_tr} loading="lazy" />
                </a>
              )}
              <div class="result-content">
                <span class="result-category badge badge-muted">
                  {categoryNames[result.category] || result.category}
                </span>
                <h2>
                  <a href={`/${result.category}/${result.slug}`}>{result.title_tr}</a>
                </h2>
                <p>{result.summary_tr}</p>
                {result.created_at && (
                  <time class="result-date" datetime={result.created_at}>
                    {new Date(result.created_at).toLocaleDateString("tr-TR", {
                      year: "numeric",
                      month: "long",
                      day: "numeric"
                    })}
                  </time>
                )}
              </div>
            </article>
          ))}
        </div>
      </div>
    )}
    </div>
  </main>
</BaseLayout>

<style>
  .search-page {
    padding-top: 156px;
    padding-bottom: 64px;
    min-height: 100vh;
  }

  .search-header {
    margin-bottom: var(--spacing-xl);
  }

  .search-header h1 {
    margin-bottom: var(--spacing-lg);
  }

  .search-box {
    display: flex;
    gap: var(--spacing-sm);
    max-width: 600px;
  }

  .search-box input {
    flex: 1;
    padding: var(--spacing-md);
    border: 2px solid var(--border-soft);
    border-radius: var(--radius-md);
    font-size: 1rem;
    background: var(--bg-card);
    color: var(--text-main);
    transition: border-color var(--transition-fast);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .search-box button {
    padding: var(--spacing-md) var(--spacing-xl);
  }

  .search-empty,
  .no-results {
    text-align: center;
    padding: var(--spacing-2xl) var(--spacing-lg);
    color: var(--text-muted);
  }

  .search-icon,
  .no-results-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
  }

  .no-results h2 {
    color: var(--text-main);
    margin-bottom: var(--spacing-sm);
  }

  .suggestions {
    list-style: none;
    padding: 0;
    margin-top: var(--spacing-lg);
    font-size: 0.9rem;
  }

  .suggestions li {
    padding: var(--spacing-xs) 0;
  }

  .suggestions li::before {
    content: "â€¢ ";
    color: var(--accent);
  }

  .results-section {
    margin-top: var(--spacing-lg);
  }

  .results-count {
    color: var(--text-muted);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border-soft);
  }

  .results-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .result-card {
    display: flex;
    gap: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-lg);
    transition: transform var(--transition-base), box-shadow var(--transition-base);
  }

  .result-card:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-md);
  }

  .result-image {
    flex-shrink: 0;
    width: 160px;
    height: 100px;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .result-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .result-content {
    flex: 1;
    min-width: 0;
  }

  .result-category {
    margin-bottom: var(--spacing-xs);
  }

  .result-content h2 {
    font-size: 1.1rem;
    margin: var(--spacing-xs) 0;
    line-height: 1.4;
  }

  .result-content h2 a {
    color: var(--text-main);
    text-decoration: none;
  }

  .result-content h2 a:hover {
    color: var(--accent);
  }

  .result-content p {
    color: var(--text-muted);
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .result-date {
    display: block;
    margin-top: var(--spacing-sm);
    font-size: 0.8rem;
    color: var(--text-light);
  }

  @media (max-width: 640px) {
    .search-box {
      flex-direction: column;
    }

    .search-box button {
      width: 100%;
    }

    .result-card {
      flex-direction: column;
    }

    .result-image {
      width: 100%;
      height: 160px;
    }
  }
</style>
