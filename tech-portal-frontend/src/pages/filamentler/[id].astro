---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";

const { id } = Astro.params;
---

<BaseLayout title="Filament Detay ‚Äì 3D-labX">
  <Header />

  <main class="filament-detail-page">
    <div class="container">
      <!-- Loading -->
      <div id="loadingState" class="loading-state">
        <div class="spinner"></div>
        <p>Filament bilgileri y√ºkleniyor...</p>
      </div>

      <!-- Content -->
      <div id="content" class="hidden">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
          <a href="/filamentler">‚Üê Filament Veritabanƒ±</a>
        </nav>

        <!-- Filament Header -->
        <div class="filament-header-card">
          <div class="header-main">
            <div class="header-info">
              <span class="brand" id="brand">Marka</span>
              <h1 id="model">Model</h1>
              <div class="material-badge" id="materialBadge">PLA</div>
              <div class="color-info" id="colorInfo">
                <span class="color-dot"></span>
                <span class="color-name">Renk</span>
              </div>
            </div>
            <div class="header-rating">
              <div class="rating-big">
                <span class="rating-value" id="avgRating">0.0</span>
                <span class="rating-stars" id="ratingStars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                <span class="rating-count" id="ratingCount">0 test</span>
              </div>
              <div class="price-big" id="priceInfo">
                <span class="price">‚Ç∫0</span>
                <span class="weight">/ 1000g</span>
              </div>
            </div>
          </div>
          <div class="header-actions">
            <a href="#tests" class="btn btn-primary">Test Sonu√ßlarƒ±nƒ± G√∂r</a>
            <button class="btn btn-secondary" id="addTestBtn">+ Test Ekle</button>
            <button class="btn btn-secondary" id="addReviewBtn">+ Yorum Yaz</button>
          </div>
        </div>

        <!-- ƒ∞statistikler -->
        <div class="stats-grid" id="statsGrid">
          <!-- Dinamik doldurulacak -->
        </div>

        <!-- Test Ayarlarƒ± √ñzeti -->
        <div class="settings-card" id="settingsCard">
          <h3>üîß √ñnerilen Ayarlar (Topluluk Ortalamasƒ±)</h3>
          <div class="settings-grid">
            <div class="setting-item">
              <span class="setting-label">Nozul Sƒ±caklƒ±ƒüƒ±</span>
              <span class="setting-value" id="avgNozzle">-</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">Tabla Sƒ±caklƒ±ƒüƒ±</span>
              <span class="setting-value" id="avgBed">-</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">Baskƒ± Hƒ±zƒ±</span>
              <span class="setting-value" id="avgSpeed">-</span>
            </div>
          </div>
        </div>

        <!-- Test Sonu√ßlarƒ± -->
        <section class="tests-section" id="tests">
          <h2>üß™ Test Sonu√ßlarƒ±</h2>
          <div class="tests-list" id="testsList">
            <div class="empty-state">Hen√ºz test sonucu yok</div>
          </div>
        </section>

        <!-- Yorumlar -->
        <section class="reviews-section">
          <h2>üí¨ Kullanƒ±cƒ± Yorumlarƒ±</h2>
          <div class="reviews-list" id="reviewsList">
            <div class="empty-state">Hen√ºz yorum yok</div>
          </div>
        </section>
      </div>

      <!-- Test Ekleme Modal -->
      <div class="modal-overlay hidden" id="testModal">
        <div class="modal">
          <div class="modal-header">
            <h3>üß™ Test Sonucu Ekle</h3>
            <button class="modal-close" id="closeTestModal">√ó</button>
          </div>
          <form id="testForm">
            <div class="form-row">
              <div class="form-group">
                <label>Yazƒ±cƒ± Modeli</label>
                <input type="text" name="printer_model" placeholder="Ender 3 Pro, Prusa MK3S..." />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Nozul Sƒ±caklƒ±ƒüƒ± (¬∞C)</label>
                <input type="number" name="nozzle_temp" placeholder="210" min="150" max="300" />
              </div>
              <div class="form-group">
                <label>Tabla Sƒ±caklƒ±ƒüƒ± (¬∞C)</label>
                <input type="number" name="bed_temp" placeholder="60" min="0" max="120" />
              </div>
              <div class="form-group">
                <label>Baskƒ± Hƒ±zƒ± (mm/s)</label>
                <input type="number" name="print_speed" placeholder="50" min="10" max="300" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Retraction (mm)</label>
                <input type="number" name="retraction_mm" step="0.1" placeholder="4.5" />
              </div>
              <div class="form-group">
                <label>Retraction Hƒ±zƒ± (mm/s)</label>
                <input type="number" name="retraction_speed" placeholder="45" />
              </div>
              <div class="form-group">
                <label>Soƒüutma (%)</label>
                <input type="number" name="cooling_percent" placeholder="100" min="0" max="100" />
              </div>
            </div>

            <h4>Performans Deƒüerlendirmesi</h4>
            <div class="rating-inputs">
              <div class="rating-input">
                <label>Katman Yapƒ±≈ümasƒ±</label>
                <div class="star-rating" data-name="layer_adhesion_rating">
                  <button type="button" data-value="1">‚òÖ</button>
                  <button type="button" data-value="2">‚òÖ</button>
                  <button type="button" data-value="3">‚òÖ</button>
                  <button type="button" data-value="4">‚òÖ</button>
                  <button type="button" data-value="5">‚òÖ</button>
                </div>
              </div>
              <div class="rating-input">
                <label>Y√ºzey Kalitesi</label>
                <div class="star-rating" data-name="surface_quality_rating">
                  <button type="button" data-value="1">‚òÖ</button>
                  <button type="button" data-value="2">‚òÖ</button>
                  <button type="button" data-value="3">‚òÖ</button>
                  <button type="button" data-value="4">‚òÖ</button>
                  <button type="button" data-value="5">‚òÖ</button>
                </div>
              </div>
              <div class="rating-input">
                <label>Stringing (Az = ƒ∞yi)</label>
                <div class="star-rating" data-name="stringing_rating">
                  <button type="button" data-value="1">‚òÖ</button>
                  <button type="button" data-value="2">‚òÖ</button>
                  <button type="button" data-value="3">‚òÖ</button>
                  <button type="button" data-value="4">‚òÖ</button>
                  <button type="button" data-value="5">‚òÖ</button>
                </div>
              </div>
              <div class="rating-input">
                <label>Warping (Az = ƒ∞yi)</label>
                <div class="star-rating" data-name="warping_rating">
                  <button type="button" data-value="1">‚òÖ</button>
                  <button type="button" data-value="2">‚òÖ</button>
                  <button type="button" data-value="3">‚òÖ</button>
                  <button type="button" data-value="4">‚òÖ</button>
                  <button type="button" data-value="5">‚òÖ</button>
                </div>
              </div>
              <div class="rating-input overall">
                <label>Genel Puan *</label>
                <div class="star-rating" data-name="overall_rating">
                  <button type="button" data-value="1">‚òÖ</button>
                  <button type="button" data-value="2">‚òÖ</button>
                  <button type="button" data-value="3">‚òÖ</button>
                  <button type="button" data-value="4">‚òÖ</button>
                  <button type="button" data-value="5">‚òÖ</button>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Notlar</label>
              <textarea name="notes" rows="3" placeholder="Baskƒ± deneyiminizi payla≈üƒ±n..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-full">Test Sonucunu Kaydet</button>
          </form>
        </div>
      </div>

      <!-- Yorum Ekleme Modal -->
      <div class="modal-overlay hidden" id="reviewModal">
        <div class="modal">
          <div class="modal-header">
            <h3>üí¨ Yorum Yaz</h3>
            <button class="modal-close" id="closeReviewModal">√ó</button>
          </div>
          <form id="reviewForm">
            <div class="form-group">
              <label>Ba≈ülƒ±k</label>
              <input type="text" name="title" placeholder="Kƒ±sa bir √∂zet..." />
            </div>
            <div class="rating-input overall">
              <label>Puan *</label>
              <div class="star-rating" data-name="rating">
                <button type="button" data-value="1">‚òÖ</button>
                <button type="button" data-value="2">‚òÖ</button>
                <button type="button" data-value="3">‚òÖ</button>
                <button type="button" data-value="4">‚òÖ</button>
                <button type="button" data-value="5">‚òÖ</button>
              </div>
            </div>
            <div class="form-group">
              <label>Yorum *</label>
              <textarea name="content" rows="4" placeholder="Deneyiminizi detaylƒ± anlatƒ±n..." required></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Artƒ±lar</label>
                <textarea name="pros" rows="2" placeholder="ƒ∞yi y√∂nleri..."></textarea>
              </div>
              <div class="form-group">
                <label>Eksiler</label>
                <textarea name="cons" rows="2" placeholder="Geli≈ütirilmesi gereken..."></textarea>
              </div>
            </div>
            <div class="form-group">
              <label>Satƒ±n Aldƒ±ƒüƒ±nƒ±z Yer</label>
              <input type="text" name="purchase_source" placeholder="Maƒüaza adƒ± veya web sitesi" />
            </div>
            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" name="would_recommend" />
                Bu filamenti tavsiye ederim
              </label>
            </div>
            <button type="submit" class="btn btn-primary btn-full">Yorumu G√∂nder</button>
          </form>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  .filament-detail-page {
    padding: 100px 20px 60px;
    min-height: 100vh;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
  }

  .loading-state {
    text-align: center;
    padding: 100px 20px;
    color: var(--text-muted);
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-soft);
    border-top-color: #E30A17;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .hidden {
    display: none !important;
  }

  .breadcrumb {
    margin-bottom: 24px;
  }

  .breadcrumb a {
    color: var(--text-muted);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    color: #E30A17;
  }

  /* Header Card */
  .filament-header-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 24px;
  }

  .header-main {
    display: flex;
    justify-content: space-between;
    gap: 24px;
    margin-bottom: 24px;
  }

  .brand {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 4px;
    display: block;
  }

  .header-info h1 {
    font-size: 2rem;
    margin-bottom: 12px;
  }

  .material-badge {
    display: inline-block;
    padding: 6px 14px;
    background: rgba(227, 10, 23, 0.1);
    color: #E30A17;
    border-radius: 8px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .color-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .color-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid var(--border-soft);
  }

  .header-rating {
    text-align: right;
  }

  .rating-big {
    margin-bottom: 16px;
  }

  .rating-value {
    font-size: 3rem;
    font-weight: 700;
    color: #E30A17;
    display: block;
    line-height: 1;
  }

  .rating-stars {
    color: #fbbf24;
    font-size: 1.25rem;
  }

  .rating-count {
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  .price-big .price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #E30A17;
  }

  .price-big .weight {
    color: var(--text-muted);
  }

  .header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #E30A17;
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(227, 10, 23, 0.3);
  }

  .btn-secondary {
    background: var(--bg-main);
    color: var(--text-main);
    border: 1px solid var(--border-soft);
  }

  .btn-secondary:hover {
    border-color: #E30A17;
    color: #E30A17;
  }

  .btn-full {
    width: 100%;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }

  .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #E30A17;
  }

  .stat-card .stat-label {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  /* Settings Card */
  .settings-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .settings-card h3 {
    margin-bottom: 16px;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .setting-item {
    text-align: center;
    padding: 16px;
    background: var(--bg-main);
    border-radius: 10px;
  }

  .setting-label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .setting-value {
    font-size: 1.25rem;
    font-weight: 700;
  }

  /* Sections */
  .tests-section, .reviews-section {
    margin-bottom: 32px;
  }

  .tests-section h2, .reviews-section h2 {
    margin-bottom: 16px;
  }

  .tests-list, .reviews-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .test-card, .review-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 20px;
  }

  .test-header, .review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #E30A17, #A855F7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
  }

  .user-name {
    font-weight: 600;
  }

  .test-date, .review-date {
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .test-settings {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    padding: 16px;
    background: var(--bg-main);
    border-radius: 10px;
    margin-bottom: 16px;
  }

  .test-setting {
    text-align: center;
  }

  .test-setting-label {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .test-setting-value {
    font-weight: 600;
  }

  .test-ratings {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .test-rating-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .test-rating-label {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .test-rating-stars {
    color: #fbbf24;
  }

  .review-rating {
    color: #fbbf24;
    font-size: 1.25rem;
  }

  .review-title {
    font-weight: 600;
    margin-bottom: 8px;
  }

  .review-content {
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 12px;
  }

  .review-pros-cons {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;
  }

  .pros, .cons {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.9rem;
  }

  .pros {
    background: rgba(16, 185, 129, 0.1);
  }

  .cons {
    background: rgba(239, 68, 68, 0.1);
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    background: var(--bg-card);
    border-radius: 16px;
    border: 1px solid var(--border-soft);
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal {
    background: var(--bg-card);
    border-radius: 20px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-soft);
    border-radius: 10px;
    background: var(--bg-main);
    color: var(--text-main);
    font-size: 1rem;
  }

  .form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: #E30A17;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  .checkbox-group input[type="checkbox"] {
    width: auto;
  }

  /* Star Rating Input */
  .rating-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .rating-input {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .rating-input.overall {
    grid-column: 1 / -1;
    background: rgba(227, 10, 23, 0.05);
    padding: 16px;
    border-radius: 10px;
  }

  .star-rating {
    display: flex;
    gap: 4px;
  }

  .star-rating button {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--border-soft);
    cursor: pointer;
    transition: color 0.2s;
  }

  .star-rating button.active,
  .star-rating button:hover {
    color: #fbbf24;
  }

  h4 {
    margin: 20px 0 16px;
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
    .header-main {
      flex-direction: column;
    }

    .header-rating {
      text-align: left;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .settings-grid {
      grid-template-columns: 1fr;
    }

    .rating-inputs {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline define:vars={{ filamentId: id }}>
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';
  let currentFilament = null;

  document.addEventListener('DOMContentLoaded', () => {
    loadFilamentDetail();
    setupModals();
    setupStarRatings();
  });

  async function loadFilamentDetail() {
    try {
      const res = await fetch(`${API_URL}/api/filaments/${filamentId}`);
      if (!res.ok) throw new Error('Filament bulunamadƒ±');

      const data = await res.json();
      currentFilament = data.filament;

      renderFilamentDetail(data);
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    } catch (error) {
      console.error('Load error:', error);
      document.getElementById('loadingState').innerHTML = `
        <div class="empty-state">
          <h3>Filament bulunamadƒ±</h3>
          <a href="/filamentler" class="btn btn-primary">Filamentlere D√∂n</a>
        </div>
      `;
    }
  }

  function renderFilamentDetail(data) {
    const { filament, tests, reviews, averages } = data;

    // Header info
    document.getElementById('brand').textContent = filament.brand;
    document.getElementById('model').textContent = filament.model;
    document.getElementById('materialBadge').textContent = filament.material_type;

    // Color
    const colorInfo = document.getElementById('colorInfo');
    colorInfo.querySelector('.color-dot').style.backgroundColor = getColorHex(filament.color);
    colorInfo.querySelector('.color-name').textContent = filament.color || 'Belirtilmemi≈ü';

    // Rating
    document.getElementById('avgRating').textContent = (filament.avg_rating || 0).toFixed(1);
    document.getElementById('ratingStars').textContent = getStars(filament.avg_rating || 0);
    document.getElementById('ratingCount').textContent = `${filament.total_reviews || 0} test`;

    // Price
    const priceInfo = document.getElementById('priceInfo');
    priceInfo.querySelector('.price').textContent = filament.price_tl ? `‚Ç∫${filament.price_tl.toFixed(2)}` : '-';
    priceInfo.querySelector('.weight').textContent = `/ ${filament.weight_grams}g`;

    // Stats
    const statsGrid = document.getElementById('statsGrid');
    statsGrid.innerHTML = `
      <div class="stat-card">
        <div class="stat-value">${(averages.avg_layer_adhesion || 0).toFixed(1)}</div>
        <div class="stat-label">Katman Yapƒ±≈ümasƒ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${(averages.avg_surface_quality || 0).toFixed(1)}</div>
        <div class="stat-label">Y√ºzey Kalitesi</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${(averages.avg_stringing || 0).toFixed(1)}</div>
        <div class="stat-label">Stringing</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${(averages.avg_warping || 0).toFixed(1)}</div>
        <div class="stat-label">Warping</div>
      </div>
    `;

    // Settings
    document.getElementById('avgNozzle').textContent = averages.avg_nozzle_temp ? `${averages.avg_nozzle_temp}¬∞C` : '-';
    document.getElementById('avgBed').textContent = averages.avg_bed_temp ? `${averages.avg_bed_temp}¬∞C` : '-';
    document.getElementById('avgSpeed').textContent = averages.avg_print_speed ? `${averages.avg_print_speed} mm/s` : '-';

    // Tests
    renderTests(tests);

    // Reviews
    renderReviews(reviews);
  }

  function renderTests(tests) {
    const container = document.getElementById('testsList');
    if (tests.length === 0) {
      container.innerHTML = '<div class="empty-state">Hen√ºz test sonucu yok. ƒ∞lk testi sen ekle!</div>';
      return;
    }

    container.innerHTML = tests.map(t => `
      <div class="test-card">
        <div class="test-header">
          <div class="user-info">
            <div class="user-avatar">${(t.display_name || t.username || 'U').substring(0, 1).toUpperCase()}</div>
            <div>
              <div class="user-name">${t.display_name || t.username}</div>
              <div class="test-date">${new Date(t.created_at).toLocaleDateString('tr-TR')}</div>
            </div>
          </div>
          <div class="test-overall">
            <span style="font-size: 1.5rem; font-weight: 700; color: #E30A17;">${t.overall_rating}/5</span>
          </div>
        </div>
        ${t.printer_model ? `<div style="margin-bottom: 12px;"><strong>Yazƒ±cƒ±:</strong> ${t.printer_model}</div>` : ''}
        <div class="test-settings">
          <div class="test-setting">
            <div class="test-setting-label">Nozul</div>
            <div class="test-setting-value">${t.nozzle_temp ? t.nozzle_temp + '¬∞C' : '-'}</div>
          </div>
          <div class="test-setting">
            <div class="test-setting-label">Tabla</div>
            <div class="test-setting-value">${t.bed_temp ? t.bed_temp + '¬∞C' : '-'}</div>
          </div>
          <div class="test-setting">
            <div class="test-setting-label">Hƒ±z</div>
            <div class="test-setting-value">${t.print_speed ? t.print_speed + ' mm/s' : '-'}</div>
          </div>
          <div class="test-setting">
            <div class="test-setting-label">Retraction</div>
            <div class="test-setting-value">${t.retraction_mm ? t.retraction_mm + 'mm' : '-'}</div>
          </div>
          <div class="test-setting">
            <div class="test-setting-label">Soƒüutma</div>
            <div class="test-setting-value">${t.cooling_percent !== null ? t.cooling_percent + '%' : '-'}</div>
          </div>
        </div>
        <div class="test-ratings">
          <div class="test-rating-item">
            <span class="test-rating-label">Katman</span>
            <span class="test-rating-stars">${getStars(t.layer_adhesion_rating || 0)}</span>
          </div>
          <div class="test-rating-item">
            <span class="test-rating-label">Y√ºzey</span>
            <span class="test-rating-stars">${getStars(t.surface_quality_rating || 0)}</span>
          </div>
          <div class="test-rating-item">
            <span class="test-rating-label">Stringing</span>
            <span class="test-rating-stars">${getStars(t.stringing_rating || 0)}</span>
          </div>
          <div class="test-rating-item">
            <span class="test-rating-label">Warping</span>
            <span class="test-rating-stars">${getStars(t.warping_rating || 0)}</span>
          </div>
        </div>
        ${t.notes ? `<p style="margin-top: 16px; color: var(--text-muted);">${t.notes}</p>` : ''}
      </div>
    `).join('');
  }

  function renderReviews(reviews) {
    const container = document.getElementById('reviewsList');
    if (reviews.length === 0) {
      container.innerHTML = '<div class="empty-state">Hen√ºz yorum yok. ƒ∞lk yorumu sen yaz!</div>';
      return;
    }

    container.innerHTML = reviews.map(r => `
      <div class="review-card">
        <div class="review-header">
          <div class="user-info">
            <div class="user-avatar">${(r.display_name || r.username || 'U').substring(0, 1).toUpperCase()}</div>
            <div>
              <div class="user-name">${r.display_name || r.username}</div>
              <div class="review-date">${new Date(r.created_at).toLocaleDateString('tr-TR')}</div>
            </div>
          </div>
          <div class="review-rating">${getStars(r.rating)}</div>
        </div>
        ${r.title ? `<div class="review-title">${r.title}</div>` : ''}
        <p class="review-content">${r.content}</p>
        ${(r.pros || r.cons) ? `
          <div class="review-pros-cons">
            ${r.pros ? `<div class="pros"><strong>üëç Artƒ±lar:</strong><br>${r.pros}</div>` : ''}
            ${r.cons ? `<div class="cons"><strong>üëé Eksiler:</strong><br>${r.cons}</div>` : ''}
          </div>
        ` : ''}
        ${r.would_recommend ? '<div style="color: #10B981;">‚úì Tavsiye ediyor</div>' : ''}
      </div>
    `).join('');
  }

  function setupModals() {
    const testModal = document.getElementById('testModal');
    const reviewModal = document.getElementById('reviewModal');

    document.getElementById('addTestBtn').addEventListener('click', () => {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('Test eklemek i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.');
        window.location.href = '/auth/giris';
        return;
      }
      testModal.classList.remove('hidden');
    });

    document.getElementById('addReviewBtn').addEventListener('click', () => {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('Yorum yazmak i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.');
        window.location.href = '/auth/giris';
        return;
      }
      reviewModal.classList.remove('hidden');
    });

    document.getElementById('closeTestModal').addEventListener('click', () => {
      testModal.classList.add('hidden');
    });

    document.getElementById('closeReviewModal').addEventListener('click', () => {
      reviewModal.classList.add('hidden');
    });

    // Form submissions
    document.getElementById('testForm').addEventListener('submit', handleTestSubmit);
    document.getElementById('reviewForm').addEventListener('submit', handleReviewSubmit);
  }

  function setupStarRatings() {
    document.querySelectorAll('.star-rating').forEach(container => {
      const buttons = container.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const value = parseInt(btn.dataset.value);
          buttons.forEach((b, i) => {
            b.classList.toggle('active', i < value);
          });
          container.dataset.value = value;
        });
      });
    });
  }

  async function handleTestSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const token = localStorage.getItem('authToken');

    const data = {
      filament_id: parseInt(filamentId),
      printer_model: form.printer_model.value,
      nozzle_temp: form.nozzle_temp.value ? parseInt(form.nozzle_temp.value) : null,
      bed_temp: form.bed_temp.value ? parseInt(form.bed_temp.value) : null,
      print_speed: form.print_speed.value ? parseInt(form.print_speed.value) : null,
      retraction_mm: form.retraction_mm.value ? parseFloat(form.retraction_mm.value) : null,
      retraction_speed: form.retraction_speed.value ? parseInt(form.retraction_speed.value) : null,
      cooling_percent: form.cooling_percent.value ? parseInt(form.cooling_percent.value) : null,
      layer_adhesion_rating: parseInt(form.querySelector('[data-name="layer_adhesion_rating"]').dataset.value) || null,
      surface_quality_rating: parseInt(form.querySelector('[data-name="surface_quality_rating"]').dataset.value) || null,
      stringing_rating: parseInt(form.querySelector('[data-name="stringing_rating"]').dataset.value) || null,
      warping_rating: parseInt(form.querySelector('[data-name="warping_rating"]').dataset.value) || null,
      overall_rating: parseInt(form.querySelector('[data-name="overall_rating"]').dataset.value),
      notes: form.notes.value
    };

    if (!data.overall_rating) {
      alert('L√ºtfen genel puan verin.');
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/filaments/tests`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (!res.ok) throw new Error(result.error || 'Hata olu≈ütu');

      alert('Test sonucu eklendi! +15 puan kazandƒ±nƒ±z.');
      document.getElementById('testModal').classList.add('hidden');
      loadFilamentDetail();
    } catch (error) {
      alert(error.message);
    }
  }

  async function handleReviewSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const token = localStorage.getItem('authToken');

    const data = {
      filament_id: parseInt(filamentId),
      rating: parseInt(form.querySelector('[data-name="rating"]').dataset.value),
      title: form.title.value,
      content: form.content.value,
      pros: form.pros.value,
      cons: form.cons.value,
      would_recommend: form.would_recommend.checked,
      purchase_source: form.purchase_source.value
    };

    if (!data.rating || !data.content) {
      alert('L√ºtfen puan ve yorum girin.');
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/filaments/reviews`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (!res.ok) throw new Error(result.error || 'Hata olu≈ütu');

      alert('Yorum eklendi! +10 puan kazandƒ±nƒ±z.');
      document.getElementById('reviewModal').classList.add('hidden');
      loadFilamentDetail();
    } catch (error) {
      alert(error.message);
    }
  }

  function getStars(rating) {
    const full = Math.floor(rating);
    const half = rating % 1 >= 0.5 ? 1 : 0;
    const empty = 5 - full - half;
    return '‚òÖ'.repeat(full) + (half ? '‚òÜ' : '') + '‚òÜ'.repeat(empty);
  }

  function getColorHex(colorName) {
    const colorMap = {
      'Beyaz': '#FFFFFF', 'Siyah': '#1a1a1a', 'Kirmizi': '#E30A17', 'Kƒ±rmƒ±zƒ±': '#E30A17',
      'Mavi': '#3B82F6', 'Yesil': '#10B981', 'Ye≈üil': '#10B981', 'Sari': '#FBBF24',
      'Sarƒ±': '#FBBF24', 'Turuncu': '#F97316', 'Mor': '#8B5CF6', 'Pembe': '#EC4899',
      'Gri': '#6B7280', 'Kahverengi': '#92400E', 'Altin': '#D4AF37', 'Altƒ±n': '#D4AF37',
      'Gumus': '#C0C0C0', 'G√ºm√º≈ü': '#C0C0C0', 'Seffaf': '#E5E7EB', '≈ûeffaf': '#E5E7EB'
    };
    return colorMap[colorName] || '#6B7280';
  }
</script>
