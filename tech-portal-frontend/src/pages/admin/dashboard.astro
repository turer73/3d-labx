---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="Dashboard - Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item active">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">üìù</span>
          Yazilar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">üë•</span>
          Uyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">üì°</span>
          RSS Kaynaklari
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">üì¶</span>
          Icerik Kutulari
        </a>
        <a href="/admin/logs" class="nav-item">
          <span class="icon">üìã</span>
          Site Loglari
        </a>
        <a href="/admin/translations" class="nav-item">
          <span class="icon">üåç</span>
          Ceviriler
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">‚ûï</span>
          Yeni Yazi
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          üö™ Cikis Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <!-- Header with refresh & time -->
      <header class="dash-header">
        <div class="dash-header-left">
          <h1>Dashboard</h1>
          <p class="dash-subtitle">Sistem Durumu & Analitik</p>
        </div>
        <div class="dash-header-right">
          <span class="dash-time" id="dashTime"></span>
          <button class="dash-refresh-btn" id="refreshBtn" title="Yenile">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
      </header>

      <!-- System Health Bar -->
      <div class="health-bar" id="healthBar">
        <div class="health-item health-ok">
          <span class="health-dot"></span>
          <span>API</span>
        </div>
        <div class="health-item health-ok">
          <span class="health-dot"></span>
          <span>Database</span>
        </div>
        <div class="health-item" id="healthErrors">
          <span class="health-dot"></span>
          <span>Hatalar: <b id="errorCount">-</b></span>
        </div>
        <div class="health-item health-ok">
          <span class="health-dot"></span>
          <span id="uptimeText">Uptime: OK</span>
        </div>
      </div>

      <!-- KPI Cards Row 1 -->
      <div class="kpi-grid">
        <div class="kpi-card kpi-primary">
          <div class="kpi-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
          <div class="kpi-content">
            <span class="kpi-value" id="kpiTotalPosts">-</span>
            <span class="kpi-label">Toplam Yazi</span>
            <span class="kpi-sub" id="kpiPostsSub"></span>
          </div>
        </div>
        <div class="kpi-card kpi-blue">
          <div class="kpi-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div class="kpi-content">
            <span class="kpi-value" id="kpiTotalUsers">-</span>
            <span class="kpi-label">Toplam Uye</span>
            <span class="kpi-sub" id="kpiUsersSub"></span>
          </div>
        </div>
        <div class="kpi-card kpi-green">
          <div class="kpi-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </div>
          <div class="kpi-content">
            <span class="kpi-value" id="kpiPageViews">-</span>
            <span class="kpi-label">Sayfa Goruntulenme</span>
            <span class="kpi-sub" id="kpiViewsSub"></span>
          </div>
        </div>
        <div class="kpi-card kpi-orange">
          <div class="kpi-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div class="kpi-content">
            <span class="kpi-value" id="kpiComments">-</span>
            <span class="kpi-label">Yorumlar</span>
            <span class="kpi-sub" id="kpiCommentsSub"></span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <!-- Traffic Chart -->
        <div class="chart-card chart-wide">
          <div class="chart-header">
            <h3>Trafik Trendi (Son 14 Gun)</h3>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-dot" style="background:#6366F1"></span> Sayfa Goruntulenme</span>
              <span class="legend-item"><span class="legend-dot" style="background:#10B981"></span> Tekil Ziyaretci</span>
            </div>
          </div>
          <div class="chart-body">
            <canvas id="trafficChart" height="220"></canvas>
          </div>
        </div>

        <!-- Category Distribution -->
        <div class="chart-card">
          <div class="chart-header">
            <h3>Kategori Dagilimi</h3>
          </div>
          <div class="chart-body category-chart-body">
            <div id="categoryBars"></div>
          </div>
        </div>
      </div>

      <!-- Content Stats Row -->
      <div class="content-stats-row">
        <!-- Category Breakdown -->
        <div class="mini-stats-card">
          <h4>Icerik Detay</h4>
          <div class="mini-stats-grid" id="categoryStats">
            <div class="mini-stat">
              <span class="mini-stat-icon" style="background:rgba(59,130,246,0.1);color:#3B82F6">üñ®Ô∏è</span>
              <div>
                <span class="mini-stat-value" id="cat3d">-</span>
                <span class="mini-stat-label">3D Baski</span>
              </div>
            </div>
            <div class="mini-stat">
              <span class="mini-stat-icon" style="background:rgba(139,92,246,0.1);color:#8B5CF6">üí°</span>
              <div>
                <span class="mini-stat-value" id="catTech">-</span>
                <span class="mini-stat-label">Teknoloji</span>
              </div>
            </div>
            <div class="mini-stat">
              <span class="mini-stat-icon" style="background:rgba(6,182,212,0.1);color:#06B6D4">üìò</span>
              <div>
                <span class="mini-stat-value" id="catRehber">-</span>
                <span class="mini-stat-label">Rehberler</span>
              </div>
            </div>
            <div class="mini-stat">
              <span class="mini-stat-icon" style="background:rgba(34,197,94,0.1);color:#22C55E">üîß</span>
              <div>
                <span class="mini-stat-value" id="catSorun">-</span>
                <span class="mini-stat-label">Sorun Cozumleri</span>
              </div>
            </div>
            <div class="mini-stat">
              <span class="mini-stat-icon" style="background:rgba(168,85,247,0.1);color:#A855F7">‚≠ê</span>
              <div>
                <span class="mini-stat-value" id="catInceleme">-</span>
                <span class="mini-stat-label">Incelemeler</span>
              </div>
            </div>
            <div class="mini-stat">
              <span class="mini-stat-icon" style="background:rgba(245,158,11,0.1);color:#F59E0B">ü§ñ</span>
              <div>
                <span class="mini-stat-value" id="catAI">-</span>
                <span class="mini-stat-label">Yapay Zeka</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Publish Status -->
        <div class="mini-stats-card">
          <h4>Yayin Durumu</h4>
          <div class="publish-stats">
            <div class="publish-bar-container">
              <div class="publish-bar">
                <div class="publish-bar-fill" id="publishBarFill" style="width:0%"></div>
              </div>
              <div class="publish-numbers">
                <span><b id="publishCount">-</b> Yayinda</span>
                <span><b id="draftCount">-</b> Taslak</span>
              </div>
            </div>
            <div class="publish-extras">
              <div class="publish-extra-item">
                <span class="pei-icon">‚≠ê</span>
                <span><b id="featuredCount">-</b> One Cikan</span>
              </div>
              <div class="publish-extra-item">
                <span class="pei-icon">üì°</span>
                <span><b id="rssCount">-</b> RSS Kaynagi</span>
              </div>
              <div class="publish-extra-item">
                <span class="pei-icon">üí¨</span>
                <span><b id="forumThreads">-</b> Forum Konusu</span>
              </div>
              <div class="publish-extra-item">
                <span class="pei-icon">üìÖ</span>
                <span><b id="last24hPosts">-</b> Son 24 Saat</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="mini-stats-card">
          <h4>Hizli Islemler</h4>
          <div class="quick-actions-grid">
            <a href="/admin/new?category=3d-baski" class="qa-btn qa-orange">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              3D Baski Haber
            </a>
            <a href="/admin/new?category=rehberler" class="qa-btn qa-cyan">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Yeni Rehber
            </a>
            <a href="/admin/new?category=sorun-cozumleri" class="qa-btn qa-green">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Sorun Cozumu
            </a>
            <a href="/admin/new?category=incelemeler" class="qa-btn qa-purple">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Inceleme
            </a>
            <a href="/admin/posts" class="qa-btn qa-gray">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
              Tum Yazilar
            </a>
            <a href="/admin/logs" class="qa-btn qa-gray">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
              Loglar
            </a>
          </div>
        </div>
      </div>

      <!-- Tables Row -->
      <div class="tables-row">
        <!-- Recent Posts -->
        <div class="table-card">
          <div class="table-card-header">
            <h3>Son Eklenen Yazilar</h3>
            <a href="/admin/posts" class="table-link">Tumunu Gor ‚Üí</a>
          </div>
          <div class="table-scroll">
            <table class="dash-table" id="recentPostsTable">
              <thead>
                <tr>
                  <th>Baslik</th>
                  <th>Kategori</th>
                  <th>Durum</th>
                  <th>Tarih</th>
                </tr>
              </thead>
              <tbody id="recentPostsBody">
                <tr><td colspan="4" class="loading-row"><span class="spinner"></span> Yukleniyor...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Recent Users + Errors -->
        <div class="side-tables">
          <div class="table-card compact">
            <div class="table-card-header">
              <h3>Son Uyeler</h3>
              <a href="/admin/users" class="table-link">Tumunu Gor ‚Üí</a>
            </div>
            <div id="recentUsersList" class="user-list">
              <div class="loading-row"><span class="spinner"></span></div>
            </div>
          </div>

          <div class="table-card compact">
            <div class="table-card-header">
              <h3>Son Hatalar</h3>
              <a href="/admin/logs" class="table-link">Loglar ‚Üí</a>
            </div>
            <div id="recentErrorsList" class="error-list">
              <div class="loading-row"><span class="spinner"></span></div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
</BaseLayout>

<script>
  const API_BASE = 'https://tech-portal-api.turgut-d01.workers.dev';
  const secret = localStorage.getItem('adminSecret');
  if (!secret) window.location.href = '/admin';

  // Logout
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  // Mobile menu
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  function toggleMobileMenu() {
    mobileMenuToggle?.classList.toggle('active');
    sidebar?.classList.toggle('open');
    sidebarOverlay?.classList.toggle('active');
  }
  mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
  sidebarOverlay?.addEventListener('click', toggleMobileMenu);

  // Clock
  function updateClock() {
    const el = document.getElementById('dashTime');
    if (el) el.textContent = new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: 'short' });
  }
  updateClock();
  setInterval(updateClock, 1000);

  // Refresh
  document.getElementById('refreshBtn')?.addEventListener('click', () => {
    const btn = document.getElementById('refreshBtn');
    btn?.classList.add('spinning');
    loadDashboard().finally(() => setTimeout(() => btn?.classList.remove('spinning'), 500));
  });

  const CATEGORY_NAMES: Record<string, string> = {
    '3d-baski': '3D Baski',
    'teknoloji': 'Teknoloji',
    'yapay-zeka': 'Yapay Zeka',
    'rehberler': 'Rehber',
    'sorun-cozumleri': 'Sorun Cozumu',
    'incelemeler': 'Inceleme'
  };

  const CATEGORY_COLORS: Record<string, string> = {
    '3d-baski': '#3B82F6',
    'teknoloji': '#8B5CF6',
    'yapay-zeka': '#F59E0B',
    'rehberler': '#06B6D4',
    'sorun-cozumleri': '#22C55E',
    'incelemeler': '#A855F7'
  };

  // Mini bar chart with canvas
  function drawTrafficChart(dailyLogs: any[]) {
    const canvas = document.getElementById('trafficChart') as HTMLCanvasElement;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    const W = rect.width;
    const H = rect.height;

    // Fill last 14 days
    const days: any[] = [];
    for (let i = 13; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      const found = dailyLogs.find((l: any) => l.date === key);
      days.push({
        label: d.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' }),
        views: found?.page_views || 0,
        visitors: found?.unique_visitors || 0
      });
    }

    const maxVal = Math.max(...days.map(d => Math.max(d.views, d.visitors)), 1);
    const padTop = 20, padBottom = 35, padLeft = 40, padRight = 10;
    const chartW = W - padLeft - padRight;
    const chartH = H - padTop - padBottom;

    // Grid
    ctx.strokeStyle = 'rgba(148,163,184,0.15)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = padTop + (chartH / 4) * i;
      ctx.beginPath();
      ctx.moveTo(padLeft, y);
      ctx.lineTo(W - padRight, y);
      ctx.stroke();
      ctx.fillStyle = '#94A3B8';
      ctx.font = '11px system-ui';
      ctx.textAlign = 'right';
      ctx.fillText(Math.round(maxVal - (maxVal / 4) * i).toString(), padLeft - 6, y + 4);
    }

    // Draw line
    function drawLine(data: number[], color: string, fill: boolean) {
      if (!ctx) return;
      const step = chartW / (days.length - 1);
      ctx.beginPath();
      data.forEach((v, i) => {
        const x = padLeft + i * step;
        const y = padTop + chartH - (v / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.strokeStyle = color;
      ctx.lineWidth = 2.5;
      ctx.lineJoin = 'round';
      ctx.stroke();

      if (fill) {
        const step = chartW / (days.length - 1);
        ctx.lineTo(padLeft + (data.length - 1) * step, padTop + chartH);
        ctx.lineTo(padLeft, padTop + chartH);
        ctx.closePath();
        const grad = ctx.createLinearGradient(0, padTop, 0, padTop + chartH);
        grad.addColorStop(0, color.replace(')', ',0.15)').replace('rgb', 'rgba'));
        grad.addColorStop(1, color.replace(')', ',0.01)').replace('rgb', 'rgba'));
        ctx.fillStyle = grad;
        ctx.fill();
      }

      // Points
      data.forEach((v, i) => {
        if (!ctx) return;
        const x = padLeft + i * step;
        const y = padTop + chartH - (v / maxVal) * chartH;
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
      });
    }

    drawLine(days.map(d => d.views), 'rgb(99,102,241)', true);
    drawLine(days.map(d => d.visitors), 'rgb(16,185,129)', false);

    // X labels
    ctx.fillStyle = '#94A3B8';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    const step = chartW / (days.length - 1);
    days.forEach((d, i) => {
      if (i % 2 === 0 || i === days.length - 1) {
        ctx.fillText(d.label, padLeft + i * step, H - 8);
      }
    });
  }

  function renderCategoryBars(distribution: any[]) {
    const container = document.getElementById('categoryBars');
    if (!container) return;
    const total = distribution.reduce((sum: number, d: any) => sum + d.count, 0);
    container.innerHTML = distribution.map((d: any) => {
      const pct = total > 0 ? ((d.count / total) * 100).toFixed(1) : '0';
      const color = CATEGORY_COLORS[d.category] || '#64748B';
      return `
        <div class="cat-bar-row">
          <div class="cat-bar-label">
            <span style="color:${color}">${CATEGORY_NAMES[d.category] || d.category}</span>
            <span class="cat-bar-num">${d.count} (%${pct})</span>
          </div>
          <div class="cat-bar-track">
            <div class="cat-bar-fill" style="width:${pct}%;background:${color}"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderRecentPosts(posts: any[]) {
    const tbody = document.getElementById('recentPostsBody');
    if (!tbody) return;
    if (!posts.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="empty-row">Henuz yazi yok</td></tr>';
      return;
    }
    tbody.innerHTML = posts.map((p: any) => {
      const color = CATEGORY_COLORS[p.category] || '#64748B';
      return `
        <tr>
          <td class="title-cell"><a href="/admin/edit/${p.id}">${(p.title_tr || '').substring(0, 45)}${(p.title_tr || '').length > 45 ? '...' : ''}</a></td>
          <td><span class="cat-badge" style="background:${color}15;color:${color}">${CATEGORY_NAMES[p.category] || p.category}</span></td>
          <td><span class="status-dot ${p.published ? 'published' : 'draft'}"></span>${p.published ? 'Yayinda' : 'Taslak'}</td>
          <td class="date-cell">${new Date(p.created_at).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' })}</td>
        </tr>
      `;
    }).join('');
  }

  function renderRecentUsers(users: any[]) {
    const el = document.getElementById('recentUsersList');
    if (!el) return;
    if (!users.length) { el.innerHTML = '<div class="empty-state">Henuz uye yok</div>'; return; }
    el.innerHTML = users.map((u: any) => `
      <div class="user-item">
        <div class="user-avatar">${(u.username || '?')[0].toUpperCase()}</div>
        <div class="user-info">
          <span class="user-name">${u.username}</span>
          <span class="user-date">${new Date(u.created_at).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
        </div>
        <span class="user-status ${u.is_active ? 'active' : 'inactive'}">${u.is_active ? 'Aktif' : 'Pasif'}</span>
      </div>
    `).join('');
  }

  function renderRecentErrors(errors: any[]) {
    const el = document.getElementById('recentErrorsList');
    if (!el) return;
    if (!errors.length) { el.innerHTML = '<div class="empty-state success">Hata yok ‚úì</div>'; return; }
    el.innerHTML = errors.map((e: any) => `
      <div class="error-item">
        <div class="error-msg">${(e.message || '').substring(0, 60)}</div>
        <div class="error-meta">
          <span>${e.page_url ? new URL(e.page_url, 'https://x').pathname.substring(0, 30) : '-'}</span>
          <span>${new Date(e.created_at).toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
        </div>
      </div>
    `).join('');
  }

  async function loadDashboard() {
    try {
      const res = await fetch(`${API_BASE}/admin/dashboard-stats-v2`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });
      if (!res.ok) throw new Error('API Error: ' + res.status);
      const d = await res.json();

      // KPIs
      const el = (id: string) => document.getElementById(id);
      el('kpiTotalPosts')!.textContent = (d.posts?.total || 0).toString();
      el('kpiPostsSub')!.textContent = `${d.posts?.last24h || 0} yeni (24s) / ${d.posts?.last7d || 0} (7g)`;
      el('kpiTotalUsers')!.textContent = (d.users?.total || 0).toString();
      el('kpiUsersSub')!.textContent = `${d.users?.today || 0} bugun / ${d.users?.active || 0} aktif`;
      el('kpiPageViews')!.textContent = (d.logs?.pageViews || 0).toString();
      el('kpiViewsSub')!.textContent = `${d.logs?.todayPageViews || 0} bugun / ${d.logs?.uniqueVisitors || 0} tekil`;
      el('kpiComments')!.textContent = (d.comments || 0).toString();
      el('kpiCommentsSub')!.textContent = `${d.forum?.threads || 0} forum konusu`;

      // Health
      const errCount = d.logs?.errors || 0;
      el('errorCount')!.textContent = errCount.toString();
      const healthErrors = el('healthErrors');
      if (healthErrors) {
        healthErrors.className = errCount > 0 ? 'health-item health-warn' : 'health-item health-ok';
      }

      // Categories
      el('cat3d')!.textContent = (d.posts?.baski_3d || 0).toString();
      el('catTech')!.textContent = (d.posts?.teknoloji || 0).toString();
      el('catRehber')!.textContent = (d.posts?.rehberler || 0).toString();
      el('catSorun')!.textContent = (d.posts?.sorun_cozumleri || 0).toString();
      el('catInceleme')!.textContent = (d.posts?.incelemeler || 0).toString();
      el('catAI')!.textContent = (d.posts?.yapay_zeka || 0).toString();

      // Publish
      const pub = d.posts?.published || 0;
      const draft = d.posts?.draft || 0;
      const totalP = pub + draft || 1;
      el('publishCount')!.textContent = pub.toString();
      el('draftCount')!.textContent = draft.toString();
      (el('publishBarFill') as HTMLElement).style.width = `${(pub / totalP * 100).toFixed(1)}%`;
      el('featuredCount')!.textContent = (d.posts?.featured || 0).toString();
      el('rssCount')!.textContent = (d.rss?.active || 0).toString();
      el('forumThreads')!.textContent = (d.forum?.threads || 0).toString();
      el('last24hPosts')!.textContent = (d.posts?.last24h || 0).toString();

      // Charts
      drawTrafficChart(d.dailyLogs || []);
      renderCategoryBars(d.categoryDistribution || []);

      // Tables
      renderRecentPosts(d.recentPosts || []);
      renderRecentUsers(d.recentUsers || []);
      renderRecentErrors(d.recentErrors || []);

    } catch (err) {
      console.error('Dashboard load error:', err);
    }
  }

  loadDashboard();

  // Auto refresh every 60s
  setInterval(loadDashboard, 60000);

  // Redraw chart on resize
  let resizeTimer: any;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => loadDashboard(), 300);
  });
</script>

<style>
  /* ========== DASHBOARD HEADER ========== */
  .dash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(99,102,241,0.1);
  }
  .dash-header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 800;
    background: var(--admin-gradient-1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .dash-subtitle { color: #64748B; font-size: 0.9rem; margin: 4px 0 0; }
  .dash-header-right { display: flex; align-items: center; gap: 12px; }
  .dash-time {
    font-size: 0.85rem;
    color: #64748B;
    font-variant-numeric: tabular-nums;
    background: rgba(99,102,241,0.06);
    padding: 6px 14px;
    border-radius: 8px;
    font-weight: 500;
  }
  .dash-refresh-btn {
    width: 40px; height: 40px;
    border-radius: 10px;
    border: 2px solid rgba(99,102,241,0.15);
    background: white;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--admin-primary);
    transition: all 0.3s;
  }
  .dash-refresh-btn:hover { background: var(--admin-primary-light); }
  .dash-refresh-btn.spinning svg { animation: spin 0.6s linear; }

  /* ========== HEALTH BAR ========== */
  .health-bar {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    padding: 12px 20px;
    background: white;
    border-radius: 12px;
    border: 1px solid rgba(99,102,241,0.08);
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    flex-wrap: wrap;
  }
  .health-item {
    display: flex; align-items: center; gap: 8px;
    font-size: 0.82rem; font-weight: 600; color: #64748B;
  }
  .health-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #94A3B8;
  }
  .health-ok .health-dot { background: #10B981; box-shadow: 0 0 6px rgba(16,185,129,0.4); }
  .health-warn .health-dot { background: #F59E0B; box-shadow: 0 0 6px rgba(245,158,11,0.4); }
  .health-error .health-dot { background: #EF4444; box-shadow: 0 0 6px rgba(239,68,68,0.4); }

  /* ========== KPI CARDS ========== */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 24px;
  }
  .kpi-card {
    background: white;
    border-radius: 16px;
    padding: 22px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
    border: 1px solid rgba(99,102,241,0.08);
    box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }
  .kpi-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }
  .kpi-primary::after { background: linear-gradient(90deg, #6366F1, #8B5CF6); }
  .kpi-blue::after { background: linear-gradient(90deg, #3B82F6, #06B6D4); }
  .kpi-green::after { background: linear-gradient(90deg, #10B981, #34D399); }
  .kpi-orange::after { background: linear-gradient(90deg, #F59E0B, #FB923C); }
  .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(0,0,0,0.08); }
  .kpi-icon {
    width: 48px; height: 48px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .kpi-primary .kpi-icon { background: rgba(99,102,241,0.1); color: #6366F1; }
  .kpi-blue .kpi-icon { background: rgba(59,130,246,0.1); color: #3B82F6; }
  .kpi-green .kpi-icon { background: rgba(16,185,129,0.1); color: #10B981; }
  .kpi-orange .kpi-icon { background: rgba(245,158,11,0.1); color: #F59E0B; }
  .kpi-content { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
  .kpi-value { font-size: 1.75rem; font-weight: 800; color: #0F172A; line-height: 1.1; }
  .kpi-label { font-size: 0.82rem; color: #64748B; font-weight: 600; }
  .kpi-sub { font-size: 0.72rem; color: #94A3B8; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ========== CHARTS ========== */
  .charts-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }
  .chart-card {
    background: white;
    border-radius: 16px;
    border: 1px solid rgba(99,102,241,0.08);
    box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    overflow: hidden;
  }
  .chart-header {
    padding: 18px 22px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  .chart-header h3 { margin: 0; font-size: 0.95rem; font-weight: 700; color: #0F172A; }
  .chart-legend { display: flex; gap: 14px; }
  .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.72rem; color: #64748B; }
  .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
  .chart-body { padding: 0 16px 16px; }
  .chart-body canvas { width: 100% !important; display: block; }
  .category-chart-body { padding: 8px 22px 18px; }

  /* Category Bars */
  .cat-bar-row { margin-bottom: 12px; }
  .cat-bar-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; font-weight: 600; }
  .cat-bar-num { color: #94A3B8; font-weight: 500; }
  .cat-bar-track { height: 8px; background: #F1F5F9; border-radius: 4px; overflow: hidden; }
  .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }

  /* ========== CONTENT STATS ROW ========== */
  .content-stats-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }
  .mini-stats-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(99,102,241,0.08);
    box-shadow: 0 4px 16px rgba(0,0,0,0.04);
  }
  .mini-stats-card h4 { margin: 0 0 16px; font-size: 0.9rem; font-weight: 700; color: #0F172A; }
  .mini-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .mini-stat { display: flex; gap: 10px; align-items: center; }
  .mini-stat-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
  }
  .mini-stat-value { font-size: 1.1rem; font-weight: 800; color: #0F172A; display: block; line-height: 1.2; }
  .mini-stat-label { font-size: 0.72rem; color: #64748B; font-weight: 500; }

  /* Publish Status */
  .publish-bar-container { margin-bottom: 16px; }
  .publish-bar { height: 10px; background: #FEF3C7; border-radius: 5px; overflow: hidden; }
  .publish-bar-fill { height: 100%; background: linear-gradient(90deg, #10B981, #34D399); border-radius: 5px; transition: width 1s; }
  .publish-numbers { display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.78rem; color: #64748B; }
  .publish-extras { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .publish-extra-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 0.78rem; color: #475569;
    padding: 6px 10px;
    background: #F8FAFC;
    border-radius: 8px;
  }
  .pei-icon { font-size: 0.9rem; }

  /* Quick Actions Grid */
  .quick-actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .qa-btn {
    display: flex; align-items: center; gap: 6px;
    padding: 10px 12px; border-radius: 10px;
    font-size: 0.78rem; font-weight: 600;
    text-decoration: none; transition: all 0.2s;
    border: 1.5px solid transparent;
  }
  .qa-orange { background: rgba(249,115,22,0.06); color: #EA580C; border-color: rgba(249,115,22,0.15); }
  .qa-orange:hover { background: rgba(249,115,22,0.12); }
  .qa-cyan { background: rgba(6,182,212,0.06); color: #0891B2; border-color: rgba(6,182,212,0.15); }
  .qa-cyan:hover { background: rgba(6,182,212,0.12); }
  .qa-green { background: rgba(34,197,94,0.06); color: #16A34A; border-color: rgba(34,197,94,0.15); }
  .qa-green:hover { background: rgba(34,197,94,0.12); }
  .qa-purple { background: rgba(168,85,247,0.06); color: #9333EA; border-color: rgba(168,85,247,0.15); }
  .qa-purple:hover { background: rgba(168,85,247,0.12); }
  .qa-gray { background: rgba(100,116,139,0.06); color: #475569; border-color: rgba(100,116,139,0.15); }
  .qa-gray:hover { background: rgba(100,116,139,0.12); }

  /* ========== TABLES ROW ========== */
  .tables-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
  }
  .table-card {
    background: white;
    border-radius: 16px;
    border: 1px solid rgba(99,102,241,0.08);
    box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    overflow: hidden;
  }
  .table-card-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 18px 22px;
    border-bottom: 1px solid #F1F5F9;
  }
  .table-card-header h3 { margin: 0; font-size: 0.95rem; font-weight: 700; color: #0F172A; }
  .table-link { font-size: 0.8rem; color: var(--admin-primary); text-decoration: none; font-weight: 600; }
  .table-link:hover { text-decoration: underline; }
  .table-scroll { overflow-x: auto; }
  .dash-table { width: 100%; border-collapse: collapse; }
  .dash-table th {
    padding: 12px 18px; text-align: left;
    font-size: 0.72rem; font-weight: 700; color: #64748B;
    text-transform: uppercase; letter-spacing: 0.5px;
    background: #FAFBFF;
  }
  .dash-table td {
    padding: 14px 18px;
    font-size: 0.85rem; color: #1E293B; font-weight: 500;
    border-bottom: 1px solid #F1F5F9;
  }
  .dash-table tr:last-child td { border-bottom: none; }
  .dash-table tr:hover { background: #FAFBFF; }
  .cat-badge {
    display: inline-block;
    padding: 3px 10px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600;
  }
  .status-dot {
    display: inline-block; width: 7px; height: 7px;
    border-radius: 50%; margin-right: 6px;
  }
  .status-dot.published { background: #10B981; }
  .status-dot.draft { background: #F59E0B; }

  .side-tables { display: flex; flex-direction: column; gap: 20px; }
  .table-card.compact { }

  /* User List */
  .user-list { padding: 8px 0; }
  .user-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 20px;
    border-bottom: 1px solid #F8FAFC;
  }
  .user-item:last-child { border-bottom: none; }
  .user-avatar {
    width: 32px; height: 32px; border-radius: 8px;
    background: var(--admin-gradient-1);
    color: white; font-weight: 700; font-size: 0.8rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .user-info { flex: 1; min-width: 0; }
  .user-name { display: block; font-size: 0.82rem; font-weight: 600; color: #0F172A; }
  .user-date { display: block; font-size: 0.7rem; color: #94A3B8; }
  .user-status {
    font-size: 0.68rem; font-weight: 600; padding: 3px 8px; border-radius: 6px;
  }
  .user-status.active { background: rgba(16,185,129,0.1); color: #059669; }
  .user-status.inactive { background: rgba(239,68,68,0.1); color: #DC2626; }

  /* Error List */
  .error-list { padding: 8px 0; }
  .error-item { padding: 10px 20px; border-bottom: 1px solid #F8FAFC; }
  .error-item:last-child { border-bottom: none; }
  .error-msg { font-size: 0.78rem; font-weight: 600; color: #DC2626; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .error-meta { display: flex; justify-content: space-between; font-size: 0.68rem; color: #94A3B8; }

  .empty-state { padding: 24px; text-align: center; color: #94A3B8; font-size: 0.85rem; }
  .empty-state.success { color: #059669; }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 1200px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .charts-row { grid-template-columns: 1fr; }
    .content-stats-row { grid-template-columns: 1fr 1fr; }
    .tables-row { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: 1fr; }
    .content-stats-row { grid-template-columns: 1fr; }
    .health-bar { flex-direction: column; gap: 8px; }
    .dash-header { flex-direction: column; gap: 12px; align-items: flex-start; }
  }

  /* ========== DARK MODE ========== */
  @media (prefers-color-scheme: dark) {
    .health-bar, .kpi-card, .chart-card, .mini-stats-card, .table-card {
      background: #1E293B;
      border-color: #334155;
    }
    .dash-subtitle { color: #94A3B8; }
    .dash-time { background: rgba(99,102,241,0.1); color: #A5B4FC; }
    .dash-refresh-btn { background: #1E293B; border-color: #334155; color: #A5B4FC; }
    .dash-refresh-btn:hover { background: #312E81; }
    .kpi-value, .mini-stat-value, .chart-header h3, .mini-stats-card h4,
    .table-card-header h3, .user-name { color: #F1F5F9; }
    .kpi-label, .kpi-sub, .mini-stat-label, .cat-bar-num,
    .dash-table th, .user-date, .error-meta { color: #94A3B8; }
    .dash-table td { color: #E2E8F0; border-bottom-color: #334155; }
    .dash-table th { background: #1a2332; }
    .dash-table tr:hover { background: rgba(99,102,241,0.05); }
    .table-card-header { border-bottom-color: #334155; }
    .user-item, .error-item { border-bottom-color: #2a3544; }
    .publish-extra-item { background: #0F172A; color: #CBD5E1; }
    .cat-bar-track { background: #334155; }
    .publish-bar { background: #334155; }
    .title-cell a { color: #F1F5F9; }
    .title-cell a:hover { color: #A5B4FC; }
    .publish-numbers { color: #94A3B8; }
  }
</style>
