---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="Dashboard â€“ Admin Panel" noIndex={true}>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item active">
          <span class="icon">ğŸ“Š</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">ğŸ“</span>
          YazÄ±lar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">ğŸ‘¥</span>
          Ãœyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">ğŸ“¡</span>
          RSS KaynaklarÄ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">ğŸ“¦</span>
          Ä°Ã§erik KutularÄ±
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">â•</span>
          Yeni YazÄ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <h1>Dashboard</h1>
        <p class="text-muted">Genel bakÄ±ÅŸ ve istatistikler</p>
      </header>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“„</div>
          <div class="stat-info">
            <span class="stat-value" id="totalPosts">-</span>
            <span class="stat-label">Toplam YazÄ±</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-info">
            <span class="stat-value" id="totalUsers">-</span>
            <span class="stat-label">Toplam Ãœye</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’¬</div>
          <div class="stat-info">
            <span class="stat-value" id="totalComments">-</span>
            <span class="stat-label">Yorumlar</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-info">
            <span class="stat-value" id="todayUsers">-</span>
            <span class="stat-label">BugÃ¼n KayÄ±t</span>
          </div>
        </div>
      </div>

      <!-- Kategori Ä°statistikleri -->
      <div class="stats-grid secondary">
        <div class="stat-card small">
          <div class="stat-icon small">ğŸ–¨ï¸</div>
          <div class="stat-info">
            <span class="stat-value" id="posts3d">-</span>
            <span class="stat-label">3D BaskÄ±</span>
          </div>
        </div>
        <div class="stat-card small">
          <div class="stat-icon small">ğŸ’»</div>
          <div class="stat-info">
            <span class="stat-value" id="postsTech">-</span>
            <span class="stat-label">Teknoloji</span>
          </div>
        </div>
        <div class="stat-card small">
          <div class="stat-icon small">ğŸ¤–</div>
          <div class="stat-info">
            <span class="stat-value" id="postsAI">-</span>
            <span class="stat-label">Yapay Zeka</span>
          </div>
        </div>
        <div class="stat-card small">
          <div class="stat-icon small">âœ…</div>
          <div class="stat-info">
            <span class="stat-value" id="publishedPosts">-</span>
            <span class="stat-label">YayÄ±nda</span>
          </div>
        </div>
      </div>

      <section class="recent-section">
        <div class="section-header">
          <h2>Son Eklenen YazÄ±lar</h2>
          <a href="/admin/posts" class="btn btn-secondary">TÃ¼mÃ¼nÃ¼ GÃ¶r</a>
        </div>

        <div class="posts-table-container">
          <table class="posts-table" id="recentPosts">
            <thead>
              <tr>
                <th>BaÅŸlÄ±k</th>
                <th>Kategori</th>
                <th>Durum</th>
                <th>Tarih</th>
                <th>Ä°ÅŸlem</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="loading-row">
                  <span class="spinner"></span> YÃ¼kleniyor...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
</BaseLayout>

<script>
  const API_BASE = 'https://tech-portal-api.turgut-d01.workers.dev';

  // Auth kontrolÃ¼
  const secret = localStorage.getItem('adminSecret');
  if (!secret) {
    window.location.href = '/admin';
  }

  // Logout
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  // Ä°statistikleri yÃ¼kle
  async function loadStats() {
    try {
      // Post istatistikleri
      const res = await fetch(`${API_BASE}/api/stats`);
      const data = await res.json();

      document.getElementById('totalPosts')!.textContent = data.total || '0';
      document.getElementById('posts3d')!.textContent = data.baski_3d || '0';
      document.getElementById('postsTech')!.textContent = data.teknoloji || '0';
      document.getElementById('postsAI')!.textContent = data.yapay_zeka || '0';
      document.getElementById('publishedPosts')!.textContent = data.published || '0';

      // Dashboard istatistikleri
      const dashRes = await fetch(`${API_BASE}/admin/dashboard-stats`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });

      if (dashRes.ok) {
        const dashData = await dashRes.json();
        document.getElementById('totalUsers')!.textContent = dashData.stats?.totalUsers || '0';
        document.getElementById('totalComments')!.textContent = dashData.stats?.totalComments || '0';
        document.getElementById('todayUsers')!.textContent = dashData.stats?.todayUsers || '0';
      }
    } catch (err) {
      console.error('Stats yÃ¼klenemedi:', err);
    }
  }

  // Son yazÄ±larÄ± yÃ¼kle
  async function loadRecentPosts() {
    try {
      const res = await fetch(`${API_BASE}/admin/posts?limit=5`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });

      if (!res.ok) throw new Error('Unauthorized');

      const posts = await res.json();
      const tbody = document.querySelector('#recentPosts tbody')!;

      if (posts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-row">HenÃ¼z yazÄ± yok</td></tr>';
        return;
      }

      const categoryNames: Record<string, string> = {
        '3d-baski': '3D BaskÄ±',
        'teknoloji': 'Teknoloji',
        'yapay-zeka': 'Yapay Zeka'
      };

      tbody.innerHTML = posts.map((post: any) => `
        <tr>
          <td class="title-cell">
            <a href="/admin/edit/${post.id}">${post.title_tr?.substring(0, 50)}${post.title_tr?.length > 50 ? '...' : ''}</a>
          </td>
          <td>
            <span class="category-badge ${post.category}">${categoryNames[post.category] || post.category}</span>
          </td>
          <td>
            <span class="status-badge ${post.published ? 'published' : 'draft'}">
              ${post.published ? 'YayÄ±nda' : 'Taslak'}
            </span>
          </td>
          <td class="date-cell">${new Date(post.created_at).toLocaleDateString('tr-TR')}</td>
          <td>
            <a href="/admin/edit/${post.id}" class="btn btn-ghost btn-sm">DÃ¼zenle</a>
          </td>
        </tr>
      `).join('');
    } catch (err) {
      console.error('Posts yÃ¼klenemedi:', err);
      const tbody = document.querySelector('#recentPosts tbody')!;
      tbody.innerHTML = '<tr><td colspan="5" class="error-row">YÃ¼klenirken hata oluÅŸtu</td></tr>';
    }
  }

  // YÃ¼kle
  loadStats();
  loadRecentPosts();
</script>
