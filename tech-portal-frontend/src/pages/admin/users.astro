---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="√úyeler ‚Äì Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">üìù</span>
          Yazƒ±lar
        </a>
        <a href="/admin/users" class="nav-item active">
          <span class="icon">üë•</span>
          √úyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">üì°</span>
          RSS Kaynaklarƒ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">üì¶</span>
          ƒ∞√ßerik Kutularƒ±
        </a>
        <a href="/admin/logs" class="nav-item">
          <span class="icon">üìã</span>
          Site Loglarƒ±
        </a>
        <a href="/admin/translations" class="nav-item">
          <span class="icon">üåç</span>
          √áeviriler
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">‚ûï</span>
          Yeni Yazƒ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          üö™ √áƒ±kƒ±≈ü Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>√úye Y√∂netimi</h1>
          <p class="text-muted">Kayƒ±tlƒ± kullanƒ±cƒ±larƒ± g√∂r√ºnt√ºleyin ve y√∂netin</p>
        </div>
        <div class="header-actions">
          <span id="userCount" class="badge badge-secondary">0 √úye</span>
        </div>
      </header>

      <!-- Filtreler -->
      <div class="filters">
        <input type="search" id="searchInput" placeholder="Kullanƒ±cƒ± ara..." class="search-input" />

        <select id="roleFilter" class="filter-select">
          <option value="">T√ºm Roller</option>
          <option value="user">Kullanƒ±cƒ±</option>
          <option value="moderator">Moderat√∂r</option>
          <option value="admin">Admin</option>
        </select>

        <select id="statusFilter" class="filter-select">
          <option value="">T√ºm Durumlar</option>
          <option value="active">Aktif</option>
          <option value="inactive">Pasif</option>
          <option value="unverified">Doƒürulanmamƒ±≈ü</option>
        </select>

        <button id="refreshBtn" class="btn btn-secondary">
          üîÑ Yenile
        </button>
      </div>

      <!-- Kullanƒ±cƒ± Tablosu -->
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Kullanƒ±cƒ±</th>
              <th>E-posta</th>
              <th>Rol</th>
              <th>Durum</th>
              <th>Kayƒ±t Tarihi</th>
              <th>Son Giri≈ü</th>
              <th>ƒ∞≈ülemler</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" class="text-center">Y√ºkleniyor...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Sayfalama -->
      <div class="pagination" id="pagination"></div>
    </main>
  </div>

  <!-- Kullanƒ±cƒ± D√ºzenleme Modal -->
  <div id="editModal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Kullanƒ±cƒ± D√ºzenle</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <form id="editForm" class="modal-body">
        <input type="hidden" id="editUserId" />

        <div class="form-group">
          <label>Kullanƒ±cƒ± Adƒ±</label>
          <input type="text" id="editUsername" readonly class="readonly" />
        </div>

        <div class="form-group">
          <label>E-posta</label>
          <input type="email" id="editEmail" readonly class="readonly" />
        </div>

        <div class="form-group">
          <label>G√∂r√ºnen Ad</label>
          <input type="text" id="editDisplayName" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Rol</label>
            <select id="editRole">
              <option value="user">Kullanƒ±cƒ±</option>
              <option value="moderator">Moderat√∂r</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="form-group">
            <label>Durum</label>
            <select id="editStatus">
              <option value="1">Aktif</option>
              <option value="0">Pasif</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="editVerified" />
            E-posta Doƒürulanmƒ±≈ü
          </label>
        </div>

        <div class="form-group">
          <label>Biyografi</label>
          <textarea id="editBio" rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Konum</label>
            <input type="text" id="editLocation" placeholder="ƒ∞stanbul, T√ºrkiye" />
          </div>

          <div class="form-group">
            <label>Website</label>
            <input type="url" id="editWebsite" placeholder="https://..." />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelEdit">ƒ∞ptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ≈ûifre Sƒ±fƒ±rlama Modal -->
  <div id="passwordModal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2>≈ûifre Sƒ±fƒ±rla</h2>
        <button class="modal-close" id="closePasswordModal">&times;</button>
      </div>
      <form id="passwordForm" class="modal-body">
        <input type="hidden" id="passwordUserId" />

        <div class="form-group">
          <label>Yeni ≈ûifre</label>
          <input type="password" id="newPassword" required minlength="6" />
          <small>En az 6 karakter</small>
        </div>

        <div class="form-group">
          <label>≈ûifre Tekrar</label>
          <input type="password" id="confirmPassword" required />
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelPassword">ƒ∞ptal</button>
          <button type="submit" class="btn btn-warning">≈ûifreyi Sƒ±fƒ±rla</button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<style>
  .filters {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 10px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    color: var(--text-main);
  }

  .filter-select {
    padding: 10px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    color: var(--text-main);
    min-width: 140px;
  }

  .table-container {
    overflow-x: auto;
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border-soft);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-soft);
  }

  .data-table th {
    background: var(--bg-main);
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--text-muted);
  }

  .data-table tbody tr:hover {
    background: rgba(255,255,255,0.02);
  }

  .user-cell {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-main);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: var(--text-muted);
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-info {
    display: flex;
    flex-direction: column;
  }

  .user-name {
    font-weight: 600;
    color: var(--text-main);
  }

  .user-username {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .role-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .role-admin { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
  .role-moderator { background: rgba(168, 85, 247, 0.1); color: #A855F7; }
  .role-user { background: rgba(107, 114, 128, 0.1); color: #6B7280; }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-active { background: rgba(34, 197, 94, 0.1); color: #22C55E; }
  .status-inactive { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
  .status-unverified { background: rgba(234, 179, 8, 0.1); color: #EAB308; }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid var(--border-soft);
    background: var(--bg-main);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-icon:hover {
    background: var(--bg-card);
    border-color: var(--accent);
  }

  .btn-icon.danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #EF4444;
  }

  .btn-icon.success {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.3);
  }

  .btn-icon.success:hover {
    background: rgba(34, 197, 94, 0.2);
    border-color: #22C55E;
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 24px;
  }

  .pagination button {
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid var(--border-soft);
    background: var(--bg-card);
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.2s;
  }

  .pagination button:hover:not(:disabled) {
    background: var(--accent);
    border-color: var(--accent);
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination button.active {
    background: var(--accent);
    border-color: var(--accent);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal.hidden {
    display: none;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
  }

  .modal-content {
    position: relative;
    background: var(--bg-card);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-small {
    max-width: 400px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-soft);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
    padding: 4px;
    line-height: 1;
  }

  .modal-body {
    padding: 24px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 20px;
    border-top: 1px solid var(--border-soft);
    margin-top: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-main);
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    color: var(--text-main);
  }

  .form-group input.readonly {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .form-group small {
    display: block;
    margin-top: 4px;
    color: var(--text-muted);
    font-size: 0.8rem;
  }

  .form-group input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
  }

  .text-center {
    text-align: center;
    padding: 40px !important;
    color: var(--text-muted);
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline>
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';
  let currentPage = 1;
  let totalPages = 1;
  let adminSecret = '';

  // Auth check
  document.addEventListener('DOMContentLoaded', () => {
    adminSecret = localStorage.getItem('adminSecret');
    if (!adminSecret) {
      window.location.href = '/admin';
      return;
    }
    loadUsers();
    setupEventListeners();
  });

  function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', debounce(() => {
      currentPage = 1;
      loadUsers();
    }, 300));

    document.getElementById('roleFilter').addEventListener('change', () => {
      currentPage = 1;
      loadUsers();
    });

    document.getElementById('statusFilter').addEventListener('change', () => {
      currentPage = 1;
      loadUsers();
    });

    document.getElementById('refreshBtn').addEventListener('click', loadUsers);
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleMobileMenu() {
      mobileMenuToggle?.classList.toggle('active');
      sidebar?.classList.toggle('open');
      sidebarOverlay?.classList.toggle('active');
    }

    mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
    sidebarOverlay?.addEventListener('click', toggleMobileMenu);

    // Modal events
    document.getElementById('closeModal').addEventListener('click', closeEditModal);
    document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
    document.querySelector('#editModal .modal-overlay').addEventListener('click', closeEditModal);
    document.getElementById('editForm').addEventListener('submit', saveUser);

    document.getElementById('closePasswordModal').addEventListener('click', closePasswordModal);
    document.getElementById('cancelPassword').addEventListener('click', closePasswordModal);
    document.querySelector('#passwordModal .modal-overlay').addEventListener('click', closePasswordModal);
    document.getElementById('passwordForm').addEventListener('submit', resetPassword);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  async function loadUsers() {
    const search = document.getElementById('searchInput').value;
    const role = document.getElementById('roleFilter').value;
    const status = document.getElementById('statusFilter').value;

    const params = new URLSearchParams({
      page: currentPage,
      limit: 20,
      ...(search && { search }),
      ...(role && { role }),
      ...(status && { status })
    });

    try {
      const res = await fetch(`${API_URL}/admin/users?${params}`, {
        headers: { 'X-ADMIN-SECRET': adminSecret }
      });

      if (!res.ok) throw new Error('API hatasƒ±');

      const data = await res.json();
      renderUsers(data.users);
      renderPagination(data.pagination);
      document.getElementById('userCount').textContent = `${data.pagination.total} √úye`;
    } catch (error) {
      console.error('Load error:', error);
      document.getElementById('usersTableBody').innerHTML = `
        <tr><td colspan="7" class="text-center">Y√ºklenirken hata olu≈ütu</td></tr>
      `;
    }
  }

  function renderUsers(users) {
    const tbody = document.getElementById('usersTableBody');

    if (!users || users.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center">Kullanƒ±cƒ± bulunamadƒ±</td></tr>`;
      return;
    }

    tbody.innerHTML = users.map(user => {
      const initials = (user.display_name || user.username || 'U').substring(0, 2).toUpperCase();
      const roleClass = `role-${user.role}`;
      const statusClass = !user.is_active ? 'status-inactive' : !user.email_verified ? 'status-unverified' : 'status-active';
      const statusText = !user.is_active ? 'Pasif' : !user.email_verified ? 'Doƒürulanmamƒ±≈ü' : 'Aktif';

      return `
        <tr>
          <td>
            <div class="user-cell">
              <div class="user-avatar">
                ${user.avatar_url ? `<img src="${user.avatar_url}" alt="${user.username}" />` : initials}
              </div>
              <div class="user-info">
                <span class="user-name">${user.display_name || user.username}</span>
                <span class="user-username">@${user.username}</span>
              </div>
            </div>
          </td>
          <td>${user.email}</td>
          <td><span class="role-badge ${roleClass}">${user.role}</span></td>
          <td>
            <span class="status-badge ${statusClass}">
              <span class="status-dot"></span>
              ${statusText}
            </span>
          </td>
          <td>${formatDate(user.created_at)}</td>
          <td>${user.last_login ? formatDate(user.last_login) : '-'}</td>
          <td>
            <div class="action-buttons">
              ${!user.email_verified ? `<button class="btn-icon success" onclick="verifyUser(${user.id}, '${user.username}')" title="E-posta Onayla">‚úÖ</button>` : ''}
              <button class="btn-icon" onclick="editUser(${user.id})" title="D√ºzenle">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="openPasswordModal(${user.id})" title="≈ûifre Sƒ±fƒ±rla">üîë</button>
              ${user.role !== 'admin' ? `<button class="btn-icon danger" onclick="deleteUser(${user.id}, '${user.username}')" title="Sil">üóëÔ∏è</button>` : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderPagination(pagination) {
    totalPages = pagination.totalPages;
    const container = document.getElementById('pagination');

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = `
      <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê √ñnceki</button>
    `;

    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
        html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
      } else if (i === currentPage - 3 || i === currentPage + 3) {
        html += `<button disabled>...</button>`;
      }
    }

    html += `
      <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Sonraki ‚Üí</button>
    `;

    container.innerHTML = html;
  }

  window.goToPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadUsers();
  }

  window.editUser = async function(userId) {
    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        headers: { 'X-ADMIN-SECRET': adminSecret }
      });

      if (!res.ok) throw new Error('Kullanƒ±cƒ± bulunamadƒ±');

      const data = await res.json();
      const user = data.user;

      document.getElementById('editUserId').value = user.id;
      document.getElementById('editUsername').value = user.username;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editDisplayName').value = user.display_name || '';
      document.getElementById('editRole').value = user.role;
      document.getElementById('editStatus').value = user.is_active ? '1' : '0';
      document.getElementById('editVerified').checked = user.email_verified;
      document.getElementById('editBio').value = user.bio || '';
      document.getElementById('editLocation').value = user.location || '';
      document.getElementById('editWebsite').value = user.website || '';

      document.getElementById('editModal').classList.remove('hidden');
    } catch (error) {
      alert('Kullanƒ±cƒ± y√ºklenemedi: ' + error.message);
    }
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
  }

  async function saveUser(e) {
    e.preventDefault();

    const userId = document.getElementById('editUserId').value;
    const data = {
      display_name: document.getElementById('editDisplayName').value || '',
      role: document.getElementById('editRole').value,
      is_active: document.getElementById('editStatus').value === '1',
      email_verified: document.getElementById('editVerified').checked,
      bio: document.getElementById('editBio').value || '',
      location: document.getElementById('editLocation').value || '',
      website: document.getElementById('editWebsite').value || ''
    };

    console.log('Saving user:', userId, data);

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-ADMIN-SECRET': adminSecret
        },
        body: JSON.stringify(data)
      });

      console.log('Response status:', res.status);
      const result = await res.json();
      console.log('Response body:', result);

      if (res.ok) {
        alert('Kullanƒ±cƒ± g√ºncellendi');
        closeEditModal();
        loadUsers();
      } else {
        alert('Hata: ' + (result.message || result.error || 'Bilinmeyen hata'));
      }
    } catch (error) {
      console.error('Save error:', error);
      alert('Baƒülantƒ± hatasƒ±: ' + error.message);
    }
  }

  window.openPasswordModal = function(userId) {
    document.getElementById('passwordUserId').value = userId;
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('passwordModal').classList.remove('hidden');
  }

  function closePasswordModal() {
    document.getElementById('passwordModal').classList.add('hidden');
  }

  async function resetPassword(e) {
    e.preventDefault();

    const userId = document.getElementById('passwordUserId').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
      alert('≈ûifreler e≈üle≈ümiyor');
      return;
    }

    if (newPassword.length < 6) {
      alert('≈ûifre en az 6 karakter olmalƒ±');
      return;
    }

    if (!confirm('Kullanƒ±cƒ±nƒ±n ≈üifresini sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) return;

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-ADMIN-SECRET': adminSecret
        },
        body: JSON.stringify({ newPassword })
      });

      const result = await res.json();

      if (res.ok) {
        alert('≈ûifre sƒ±fƒ±rlandƒ±');
        closePasswordModal();
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (error) {
      alert('Hata: ' + error.message);
    }
  }

  window.verifyUser = async function(userId, username) {
    if (!confirm(`"${username}" kullanƒ±cƒ±sƒ±nƒ±n e-postasƒ±nƒ± manuel olarak doƒürulamak istediƒüinize emin misiniz?`)) return;

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-ADMIN-SECRET': adminSecret
        },
        body: JSON.stringify({ email_verified: true })
      });

      const result = await res.json();

      if (res.ok) {
        alert('Kullanƒ±cƒ± e-postasƒ± doƒürulandƒ±');
        loadUsers();
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (error) {
      alert('Hata: ' + error.message);
    }
  }

  window.deleteUser = async function(userId, username) {
    if (!confirm(`"${username}" kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) return;

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        method: 'DELETE',
        headers: { 'X-ADMIN-SECRET': adminSecret }
      });

      const result = await res.json();

      if (res.ok) {
        alert('Kullanƒ±cƒ± silindi');
        loadUsers();
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (error) {
      alert('Hata: ' + error.message);
    }
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('tr-TR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }

  function logout() {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  }
</script>
