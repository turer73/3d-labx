---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="√úyeler ‚Äì Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">üìù</span>
          Yazƒ±lar
        </a>
        <a href="/admin/users" class="nav-item active">
          <span class="icon">üë•</span>
          √úyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">üì°</span>
          RSS Kaynaklarƒ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">üì¶</span>
          ƒ∞√ßerik Kutularƒ±
        </a>
        <a href="/admin/logs" class="nav-item">
          <span class="icon">üìã</span>
          Site Loglarƒ±
        </a>
        <a href="/admin/translations" class="nav-item">
          <span class="icon">üåç</span>
          √áeviriler
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">‚ûï</span>
          Yeni Yazƒ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          üö™ √áƒ±kƒ±≈ü Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>√úye Y√∂netimi</h1>
          <p class="text-muted">Kayƒ±tlƒ± kullanƒ±cƒ±larƒ± g√∂r√ºnt√ºleyin ve y√∂netin</p>
        </div>
        <div class="header-actions">
          <span id="userCount" class="user-count-badge">0 √úye</span>
        </div>
      </header>

      <!-- Stats Row -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-info">
            <span class="stat-value" id="statTotal">-</span>
            <span class="stat-label">Toplam √úye</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-info">
            <span class="stat-value" id="statActive">-</span>
            <span class="stat-label">Aktif</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è∏Ô∏è</div>
          <div class="stat-info">
            <span class="stat-value" id="statInactive">-</span>
            <span class="stat-label">Pasif</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üëë</div>
          <div class="stat-info">
            <span class="stat-value" id="statAdmin">-</span>
            <span class="stat-label">Admin/Mod</span>
          </div>
        </div>
      </div>

      <!-- Filtreler -->
      <div class="filter-bar">
        <input type="search" id="searchInput" placeholder="Kullanƒ±cƒ± ara..." class="search-input" />

        <select id="roleFilter" class="filter-select">
          <option value="">T√ºm Roller</option>
          <option value="user">Kullanƒ±cƒ±</option>
          <option value="moderator">Moderat√∂r</option>
          <option value="admin">Admin</option>
        </select>

        <select id="statusFilter" class="filter-select">
          <option value="">T√ºm Durumlar</option>
          <option value="active">Aktif</option>
          <option value="inactive">Pasif</option>
          <option value="unverified">Doƒürulanmamƒ±≈ü</option>
        </select>

        <button id="refreshBtn" class="btn btn-secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          Yenile
        </button>
      </div>

      <!-- Kullanƒ±cƒ± Tablosu -->
      <div class="posts-table-container">
        <table class="posts-table">
          <thead>
            <tr>
              <th>Kullanƒ±cƒ±</th>
              <th>E-posta</th>
              <th>Rol</th>
              <th>Durum</th>
              <th>Kayƒ±t Tarihi</th>
              <th>Son Giri≈ü</th>
              <th>ƒ∞≈ülemler</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" class="loading-row">
                <span class="spinner"></span> Y√ºkleniyor...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Sayfalama -->
      <div id="pagination"></div>
    </main>
  </div>

  <!-- Kullanƒ±cƒ± D√ºzenleme Modal -->
  <div id="editModal" class="modal hidden">
    <div class="modal-backdrop" data-close="editModal"></div>
    <div class="modal-content modal-wide">
      <div class="modal-header-bar">
        <h3>Kullanƒ±cƒ± D√ºzenle</h3>
        <button class="modal-close-btn" data-close="editModal">&times;</button>
      </div>
      <form id="editForm" class="modal-form-body">
        <input type="hidden" id="editUserId" />

        <div class="form-group">
          <label>Kullanƒ±cƒ± Adƒ±</label>
          <input type="text" id="editUsername" readonly class="readonly-input" />
        </div>

        <div class="form-group">
          <label>E-posta</label>
          <input type="email" id="editEmail" readonly class="readonly-input" />
        </div>

        <div class="form-group">
          <label>G√∂r√ºnen Ad</label>
          <input type="text" id="editDisplayName" />
        </div>

        <div class="form-row-grid">
          <div class="form-group">
            <label>Rol</label>
            <select id="editRole">
              <option value="user">Kullanƒ±cƒ±</option>
              <option value="moderator">Moderat√∂r</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="form-group">
            <label>Durum</label>
            <select id="editStatus">
              <option value="1">Aktif</option>
              <option value="0">Pasif</option>
            </select>
          </div>
        </div>

        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="editVerified" />
            E-posta Doƒürulanmƒ±≈ü
          </label>
        </div>

        <div class="form-group">
          <label>Biyografi</label>
          <textarea id="editBio" rows="3"></textarea>
        </div>

        <div class="form-row-grid">
          <div class="form-group">
            <label>Konum</label>
            <input type="text" id="editLocation" placeholder="ƒ∞stanbul, T√ºrkiye" />
          </div>

          <div class="form-group">
            <label>Website</label>
            <input type="url" id="editWebsite" placeholder="https://..." />
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" data-close="editModal">ƒ∞ptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ≈ûifre Sƒ±fƒ±rlama Modal -->
  <div id="passwordModal" class="modal hidden">
    <div class="modal-backdrop" data-close="passwordModal"></div>
    <div class="modal-content">
      <div class="modal-header-bar">
        <h3>≈ûifre Sƒ±fƒ±rla</h3>
        <button class="modal-close-btn" data-close="passwordModal">&times;</button>
      </div>
      <form id="passwordForm" class="modal-form-body">
        <input type="hidden" id="passwordUserId" />

        <div class="form-group">
          <label>Yeni ≈ûifre</label>
          <input type="password" id="newPassword" required minlength="6" />
          <span class="form-hint">En az 6 karakter</span>
        </div>

        <div class="form-group">
          <label>≈ûifre Tekrar</label>
          <input type="password" id="confirmPassword" required />
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" data-close="passwordModal">ƒ∞ptal</button>
          <button type="submit" class="btn btn-danger">≈ûifreyi Sƒ±fƒ±rla</button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<style>
  /* User-specific styles */
  .user-count-badge {
    background: var(--admin-primary-light);
    color: var(--admin-primary);
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .user-cell {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 38px;
    height: 38px;
    border-radius: 10px;
    background: var(--admin-gradient-1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
    color: white;
    flex-shrink: 0;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 10px;
    object-fit: cover;
  }

  .user-info {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .user-name {
    font-weight: 600;
    color: #0F172A;
    font-size: 0.9rem;
  }

  .user-username {
    font-size: 0.78rem;
    color: #94A3B8;
  }

  /* Role badges */
  .role-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .role-admin { background: rgba(239, 68, 68, 0.1); color: #DC2626; }
  .role-moderator { background: rgba(168, 85, 247, 0.1); color: #9333EA; }
  .role-user { background: rgba(107, 114, 128, 0.08); color: #64748B; }

  /* Status badges */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
  }

  .status-active { background: rgba(34, 197, 94, 0.1); color: #16A34A; }
  .status-inactive { background: rgba(239, 68, 68, 0.1); color: #DC2626; }
  .status-unverified { background: rgba(245, 158, 11, 0.1); color: #D97706; }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  /* Action buttons */
  .action-buttons {
    display: flex;
    gap: 6px;
  }

  .btn-icon {
    width: 34px;
    height: 34px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    border: 1.5px solid #E2E8F0;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
  }

  .btn-icon:hover {
    background: var(--admin-primary-light);
    border-color: var(--admin-primary);
    transform: translateY(-1px);
  }

  .btn-icon.danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #EF4444;
  }

  .btn-icon.success {
    background: rgba(34, 197, 94, 0.08);
    border-color: rgba(34, 197, 94, 0.3);
  }

  .btn-icon.success:hover {
    background: rgba(34, 197, 94, 0.15);
    border-color: #22C55E;
  }

  /* Modal enhancements */
  .modal-wide {
    max-width: 600px;
  }

  .modal-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 32px;
    border-bottom: 1px solid #F1F5F9;
  }

  .modal-header-bar h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #0F172A;
  }

  .modal-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #94A3B8;
    padding: 4px 8px;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .modal-close-btn:hover {
    background: #F1F5F9;
    color: #0F172A;
  }

  .modal-form-body {
    padding: 24px 32px 32px;
  }

  .form-row-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .readonly-input {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .email-cell {
    font-size: 0.85rem;
    color: #64748B;
  }

  /* Dark mode for user-specific elements */
  @media (prefers-color-scheme: dark) {
    .user-count-badge {
      background: rgba(99,102,241,0.15);
      color: #A5B4FC;
    }

    .user-name { color: #F1F5F9; }
    .user-username { color: #64748B; }

    .role-admin { background: rgba(239,68,68,0.15); color: #FCA5A5; }
    .role-moderator { background: rgba(168,85,247,0.15); color: #C084FC; }
    .role-user { background: rgba(107,114,128,0.15); color: #94A3B8; }

    .status-active { background: rgba(34,197,94,0.15); color: #4ADE80; }
    .status-inactive { background: rgba(239,68,68,0.15); color: #FCA5A5; }
    .status-unverified { background: rgba(245,158,11,0.15); color: #FBBF24; }

    .btn-icon {
      background: #1E293B;
      border-color: #334155;
    }

    .btn-icon:hover {
      background: #312E81;
      border-color: var(--admin-primary);
    }

    .btn-icon.danger:hover {
      background: rgba(239,68,68,0.15);
      border-color: #EF4444;
    }

    .btn-icon.success {
      background: rgba(34,197,94,0.1);
      border-color: rgba(34,197,94,0.2);
    }

    .modal-header-bar {
      border-bottom-color: #334155;
    }

    .modal-header-bar h3 { color: #F1F5F9; }

    .modal-close-btn:hover {
      background: #334155;
      color: #F1F5F9;
    }

    .email-cell { color: #94A3B8; }
  }

  @media (max-width: 768px) {
    .form-row-grid {
      grid-template-columns: 1fr;
    }

    .modal-form-body {
      padding: 20px;
    }

    .modal-header-bar {
      padding: 16px 20px;
    }
  }
</style>

<script is:inline>
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';
  let currentPage = 1;
  let totalPages = 1;
  let adminSecret = '';

  // Auth check
  document.addEventListener('DOMContentLoaded', () => {
    adminSecret = localStorage.getItem('adminSecret');
    if (!adminSecret) {
      window.location.href = '/admin';
      return;
    }
    loadUsers();
    setupEventListeners();
  });

  function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', debounce(() => {
      currentPage = 1;
      loadUsers();
    }, 300));

    document.getElementById('roleFilter').addEventListener('change', () => {
      currentPage = 1;
      loadUsers();
    });

    document.getElementById('statusFilter').addEventListener('change', () => {
      currentPage = 1;
      loadUsers();
    });

    document.getElementById('refreshBtn').addEventListener('click', loadUsers);
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleMobileMenu() {
      mobileMenuToggle?.classList.toggle('active');
      sidebar?.classList.toggle('open');
      sidebarOverlay?.classList.toggle('active');
    }

    mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
    sidebarOverlay?.addEventListener('click', toggleMobileMenu);

    // Modal close events via data-close attribute
    document.querySelectorAll('[data-close]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-close');
        document.getElementById(modalId)?.classList.add('hidden');
      });
    });

    // Form events
    document.getElementById('editForm').addEventListener('submit', saveUser);
    document.getElementById('passwordForm').addEventListener('submit', resetPassword);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  async function loadUsers() {
    const search = document.getElementById('searchInput').value;
    const role = document.getElementById('roleFilter').value;
    const status = document.getElementById('statusFilter').value;

    const params = new URLSearchParams({
      page: currentPage,
      limit: 20,
      ...(search && { search }),
      ...(role && { role }),
      ...(status && { status })
    });

    try {
      const res = await fetch(`${API_URL}/admin/users?${params}`, {
        headers: { 'X-ADMIN-SECRET': adminSecret }
      });

      if (!res.ok) throw new Error('API hatasƒ±');

      const data = await res.json();
      renderUsers(data.users);
      renderPagination(data.pagination);
      updateStats(data);
    } catch (error) {
      console.error('Load error:', error);
      document.getElementById('usersTableBody').innerHTML = `
        <tr><td colspan="7" class="error-row">Y√ºklenirken hata olu≈ütu</td></tr>
      `;
    }
  }

  function updateStats(data) {
    const users = data.users || [];
    const total = data.pagination?.total || users.length;
    const active = users.filter(u => u.is_active && u.email_verified).length;
    const inactive = users.filter(u => !u.is_active).length;
    const admins = users.filter(u => u.role === 'admin' || u.role === 'moderator').length;

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statActive').textContent = active;
    document.getElementById('statInactive').textContent = inactive;
    document.getElementById('statAdmin').textContent = admins;
    document.getElementById('userCount').textContent = total + ' √úye';
  }

  function renderUsers(users) {
    const tbody = document.getElementById('usersTableBody');

    if (!users || users.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="empty-row">Kullanƒ±cƒ± bulunamadƒ±</td></tr>`;
      return;
    }

    tbody.innerHTML = users.map(user => {
      const initials = (user.display_name || user.username || 'U').substring(0, 2).toUpperCase();
      const roleClass = `role-${user.role}`;
      const statusClass = !user.is_active ? 'status-inactive' : !user.email_verified ? 'status-unverified' : 'status-active';
      const statusText = !user.is_active ? 'Pasif' : !user.email_verified ? 'Doƒürulanmamƒ±≈ü' : 'Aktif';

      return `
        <tr>
          <td>
            <div class="user-cell">
              <div class="user-avatar">
                ${user.avatar_url ? `<img src="${user.avatar_url}" alt="${user.username}" />` : initials}
              </div>
              <div class="user-info">
                <span class="user-name">${user.display_name || user.username}</span>
                <span class="user-username">@${user.username}</span>
              </div>
            </div>
          </td>
          <td class="email-cell">${user.email}</td>
          <td><span class="role-badge ${roleClass}">${user.role}</span></td>
          <td>
            <span class="status-badge ${statusClass}">
              <span class="status-dot"></span>
              ${statusText}
            </span>
          </td>
          <td class="date-cell">${formatDate(user.created_at)}</td>
          <td class="date-cell">${user.last_login ? formatDate(user.last_login) : '-'}</td>
          <td>
            <div class="action-buttons">
              ${!user.email_verified ? `<button class="btn-icon success" onclick="verifyUser(${user.id}, '${user.username}')" title="E-posta Onayla">‚úÖ</button>` : ''}
              <button class="btn-icon" onclick="editUser(${user.id})" title="D√ºzenle">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="openPasswordModal(${user.id})" title="≈ûifre Sƒ±fƒ±rla">üîë</button>
              ${user.role !== 'admin' ? `<button class="btn-icon danger" onclick="deleteUser(${user.id}, '${user.username}')" title="Sil">üóëÔ∏è</button>` : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderPagination(pagination) {
    totalPages = pagination.totalPages;
    const container = document.getElementById('pagination');

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '';

    if (currentPage > 1) {
      html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})">‚Üê √ñnceki</button>`;
    }

    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    if (startPage > 1) {
      html += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
      if (startPage > 2) html += `<span class="pagination-dots">...</span>`;
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) html += `<span class="pagination-dots">...</span>`;
      html += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }

    if (currentPage < totalPages) {
      html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})">Sonraki ‚Üí</button>`;
    }

    container.innerHTML = html;
  }

  window.goToPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadUsers();
  }

  window.editUser = async function(userId) {
    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        headers: { 'X-ADMIN-SECRET': adminSecret }
      });

      if (!res.ok) throw new Error('Kullanƒ±cƒ± bulunamadƒ±');

      const data = await res.json();
      const user = data.user;

      document.getElementById('editUserId').value = user.id;
      document.getElementById('editUsername').value = user.username;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editDisplayName').value = user.display_name || '';
      document.getElementById('editRole').value = user.role;
      document.getElementById('editStatus').value = user.is_active ? '1' : '0';
      document.getElementById('editVerified').checked = user.email_verified;
      document.getElementById('editBio').value = user.bio || '';
      document.getElementById('editLocation').value = user.location || '';
      document.getElementById('editWebsite').value = user.website || '';

      document.getElementById('editModal').classList.remove('hidden');
    } catch (error) {
      alert('Kullanƒ±cƒ± y√ºklenemedi: ' + error.message);
    }
  }

  async function saveUser(e) {
    e.preventDefault();

    const userId = document.getElementById('editUserId').value;
    const data = {
      display_name: document.getElementById('editDisplayName').value || '',
      role: document.getElementById('editRole').value,
      is_active: document.getElementById('editStatus').value === '1',
      email_verified: document.getElementById('editVerified').checked,
      bio: document.getElementById('editBio').value || '',
      location: document.getElementById('editLocation').value || '',
      website: document.getElementById('editWebsite').value || ''
    };

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-ADMIN-SECRET': adminSecret
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (res.ok) {
        alert('Kullanƒ±cƒ± g√ºncellendi');
        document.getElementById('editModal').classList.add('hidden');
        loadUsers();
      } else {
        alert('Hata: ' + (result.message || result.error || 'Bilinmeyen hata'));
      }
    } catch (error) {
      alert('Baƒülantƒ± hatasƒ±: ' + error.message);
    }
  }

  window.openPasswordModal = function(userId) {
    document.getElementById('passwordUserId').value = userId;
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('passwordModal').classList.remove('hidden');
  }

  async function resetPassword(e) {
    e.preventDefault();

    const userId = document.getElementById('passwordUserId').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
      alert('≈ûifreler e≈üle≈ümiyor');
      return;
    }

    if (newPassword.length < 6) {
      alert('≈ûifre en az 6 karakter olmalƒ±');
      return;
    }

    if (!confirm('Kullanƒ±cƒ±nƒ±n ≈üifresini sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) return;

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-ADMIN-SECRET': adminSecret
        },
        body: JSON.stringify({ newPassword })
      });

      const result = await res.json();

      if (res.ok) {
        alert('≈ûifre sƒ±fƒ±rlandƒ±');
        document.getElementById('passwordModal').classList.add('hidden');
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (error) {
      alert('Hata: ' + error.message);
    }
  }

  window.verifyUser = async function(userId, username) {
    if (!confirm(`"${username}" kullanƒ±cƒ±sƒ±nƒ±n e-postasƒ±nƒ± manuel olarak doƒürulamak istediƒüinize emin misiniz?`)) return;

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-ADMIN-SECRET': adminSecret
        },
        body: JSON.stringify({ email_verified: true })
      });

      const result = await res.json();

      if (res.ok) {
        alert('Kullanƒ±cƒ± e-postasƒ± doƒürulandƒ±');
        loadUsers();
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (error) {
      alert('Hata: ' + error.message);
    }
  }

  window.deleteUser = async function(userId, username) {
    if (!confirm(`"${username}" kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) return;

    try {
      const res = await fetch(`${API_URL}/admin/users/${userId}`, {
        method: 'DELETE',
        headers: { 'X-ADMIN-SECRET': adminSecret }
      });

      const result = await res.json();

      if (res.ok) {
        alert('Kullanƒ±cƒ± silindi');
        loadUsers();
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (error) {
      alert('Hata: ' + error.message);
    }
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('tr-TR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }

  function logout() {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  }
</script>
