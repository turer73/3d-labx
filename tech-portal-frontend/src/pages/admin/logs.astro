---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="Site Loglarƒ± ‚Äì Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">üìù</span>
          Yazƒ±lar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">üë•</span>
          √úyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">üì°</span>
          RSS Kaynaklarƒ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">üì¶</span>
          ƒ∞√ßerik Kutularƒ±
        </a>
        <a href="/admin/logs" class="nav-item active">
          <span class="icon">üìã</span>
          Site Loglarƒ±
        </a>
        <a href="/admin/translations" class="nav-item">
          <span class="icon">üåç</span>
          √áeviriler
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">‚ûï</span>
          Yeni Yazƒ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          üö™ √áƒ±kƒ±≈ü Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>Site Loglarƒ±</h1>
          <p class="text-muted">Ziyaret√ßi aktiviteleri ve hata kayƒ±tlarƒ±</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" id="refreshLogs">üîÑ Yenile</button>
          <button class="btn btn-danger" id="cleanupLogs">üóëÔ∏è Eski Loglarƒ± Sil</button>
        </div>
      </header>

      <!-- Stats Cards -->
      <div class="stats-grid" id="logStats">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-info">
            <span class="stat-value" id="totalToday">-</span>
            <span class="stat-label">Bug√ºn Toplam</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üëÅÔ∏è</div>
          <div class="stat-info">
            <span class="stat-value" id="pageviews">-</span>
            <span class="stat-label">Sayfa G√∂r√ºnt√ºleme</span>
          </div>
        </div>
        <div class="stat-card error-card">
          <div class="stat-icon">‚ö†Ô∏è</div>
          <div class="stat-info">
            <span class="stat-value" id="errors24h">-</span>
            <span class="stat-label">Hata (24 saat)</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üîç</div>
          <div class="stat-info">
            <span class="stat-value" id="searches">-</span>
            <span class="stat-label">Arama</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filter-bar">
        <div class="filter-group">
          <label>Log Tipi:</label>
          <select id="filterType" class="filter-select">
            <option value="">T√ºm√º</option>
            <option value="pageview">Sayfa G√∂r√ºnt√ºleme</option>
            <option value="error">Hatalar</option>
            <option value="click">Tƒ±klamalar</option>
            <option value="search">Aramalar</option>
            <option value="form">Form G√∂nderimleri</option>
            <option value="auth">Giri≈ü/√áƒ±kƒ±≈ü</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Seviye:</label>
          <select id="filterLevel" class="filter-select">
            <option value="">T√ºm√º</option>
            <option value="info">Info</option>
            <option value="warning">Warning</option>
            <option value="error">Error</option>
          </select>
        </div>
        <button class="btn btn-primary btn-sm" id="applyFilters">Filtrele</button>
      </div>

      <!-- Logs Table -->
      <div class="posts-table-container">
        <table class="posts-table" id="logsTable">
          <thead>
            <tr>
              <th>Zaman</th>
              <th>Tip</th>
              <th>Seviye</th>
              <th>Mesaj</th>
              <th>Sayfa</th>
              <th>Detay</th>
            </tr>
          </thead>
          <tbody id="logsBody">
            <tr>
              <td colspan="6" class="loading-row">
                <span class="spinner"></span> Y√ºkleniyor...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-bar" id="pagination"></div>
    </main>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal hidden">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-content modal-lg">
      <div class="modal-header-bar">
        <h3>Log Detayƒ±</h3>
        <button class="modal-close-btn" data-close>&times;</button>
      </div>
      <div class="modal-body-content">
        <pre id="detailContent"></pre>
      </div>
      <div class="modal-footer-bar">
        <button class="btn btn-primary" data-close>Kapat</button>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-group label {
    font-size: 0.85rem;
    color: var(--text-muted);
    white-space: nowrap;
  }

  /* Error stat card variant */
  .error-card {
    border-color: rgba(239, 68, 68, 0.3) !important;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), white) !important;
  }

  /* Log type badges */
  .log-type {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .log-type.pageview { background: rgba(59, 130, 246, 0.12); color: #3B82F6; }
  .log-type.error { background: rgba(239, 68, 68, 0.12); color: #EF4444; }
  .log-type.click { background: rgba(34, 197, 94, 0.12); color: #22C55E; }
  .log-type.search { background: rgba(168, 85, 247, 0.12); color: #A855F7; }
  .log-type.form { background: rgba(249, 115, 22, 0.12); color: #F97316; }
  .log-type.auth { background: rgba(6, 182, 212, 0.12); color: #06B6D4; }

  /* Log level badges */
  .log-level {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .log-level.info { background: rgba(107, 114, 128, 0.12); color: #6B7280; }
  .log-level.warning { background: rgba(245, 158, 11, 0.12); color: #F59E0B; }
  .log-level.error { background: rgba(239, 68, 68, 0.12); color: #EF4444; }

  .page-url {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .detail-btn {
    background: rgba(99, 102, 241, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    color: #6366F1;
    transition: all 0.2s;
  }

  .detail-btn:hover {
    background: #6366F1;
    color: white;
    border-color: #6366F1;
  }

  /* Pagination */
  .pagination-bar {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 20px;
  }

  .pagination-bar button {
    padding: 8px 14px;
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: 10px;
    background: white;
    color: #475569;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .pagination-bar button:hover:not(:disabled) {
    border-color: #6366F1;
    color: #6366F1;
    background: rgba(99, 102, 241, 0.04);
  }

  .pagination-bar button.active {
    background: linear-gradient(135deg, #6366F1, #818CF8);
    color: white;
    border-color: transparent;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  }

  .pagination-bar button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Detail Modal */
  .modal-lg {
    max-width: 650px;
  }

  .modal-header-bar {
    padding: 20px 24px;
    border-bottom: 1px solid rgba(99, 102, 241, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-header-bar h3 {
    margin: 0;
    font-size: 1.15rem;
    font-weight: 700;
    color: #1E293B;
  }

  .modal-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #94A3B8;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
    transition: color 0.2s;
  }

  .modal-close-btn:hover {
    color: #EF4444;
  }

  .modal-body-content {
    padding: 24px;
    max-height: 50vh;
    overflow-y: auto;
  }

  .modal-body-content pre {
    background: #F8FAFC;
    border: 1px solid rgba(99, 102, 241, 0.1);
    padding: 16px;
    border-radius: 12px;
    overflow-x: auto;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-break: break-word;
    margin: 0;
    line-height: 1.7;
    color: #334155;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  }

  .modal-footer-bar {
    padding: 16px 24px;
    border-top: 1px solid rgba(99, 102, 241, 0.1);
    display: flex;
    justify-content: flex-end;
  }

  /* Dark Mode */
  @media (prefers-color-scheme: dark) {
    .error-card {
      border-color: rgba(239, 68, 68, 0.4) !important;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), var(--bg-card)) !important;
    }

    .log-type.pageview { background: rgba(59, 130, 246, 0.2); color: #93C5FD; }
    .log-type.error { background: rgba(239, 68, 68, 0.2); color: #FCA5A5; }
    .log-type.click { background: rgba(34, 197, 94, 0.2); color: #86EFAC; }
    .log-type.search { background: rgba(168, 85, 247, 0.2); color: #C4B5FD; }
    .log-type.form { background: rgba(249, 115, 22, 0.2); color: #FDBA74; }
    .log-type.auth { background: rgba(6, 182, 212, 0.2); color: #67E8F9; }

    .log-level.info { background: rgba(107, 114, 128, 0.25); color: #9CA3AF; }
    .log-level.warning { background: rgba(245, 158, 11, 0.25); color: #FCD34D; }
    .log-level.error { background: rgba(239, 68, 68, 0.25); color: #FCA5A5; }

    .detail-btn {
      background: rgba(99, 102, 241, 0.15);
      border-color: rgba(99, 102, 241, 0.3);
      color: #A5B4FC;
    }

    .detail-btn:hover {
      background: #6366F1;
      color: white;
    }

    .pagination-bar button {
      background: var(--bg-card);
      color: var(--text-muted);
      border-color: rgba(99, 102, 241, 0.2);
    }

    .pagination-bar button:hover:not(:disabled) {
      color: #A5B4FC;
      border-color: #6366F1;
    }

    .pagination-bar button.active {
      background: linear-gradient(135deg, #6366F1, #818CF8);
      color: white;
    }

    .modal-header-bar {
      border-bottom-color: rgba(99, 102, 241, 0.15);
    }

    .modal-header-bar h3 {
      color: #F1F5F9;
    }

    .modal-close-btn {
      color: #64748B;
    }

    .modal-body-content pre {
      background: #0F172A;
      border-color: rgba(99, 102, 241, 0.15);
      color: #CBD5E1;
    }

    .modal-footer-bar {
      border-top-color: rgba(99, 102, 241, 0.15);
    }
  }
</style>

<script>
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';
  const ADMIN_SECRET = localStorage.getItem('adminSecret') || '';

  let currentPage = 1;
  let currentType = '';
  let currentLevel = '';

  // Check admin auth
  if (!ADMIN_SECRET) {
    window.location.href = '/admin';
  }

  // Logout
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  // Mobile menu
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  function toggleMobileMenu() {
    mobileMenuToggle?.classList.toggle('active');
    sidebar?.classList.toggle('open');
    sidebarOverlay?.classList.toggle('active');
  }

  mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
  sidebarOverlay?.addEventListener('click', toggleMobileMenu);

  // Load stats
  async function loadStats() {
    try {
      const res = await fetch(`${API_URL}/api/admin/logs/stats`, {
        headers: { 'X-ADMIN-SECRET': ADMIN_SECRET }
      });

      if (!res.ok) {
        if (res.status === 401) {
          localStorage.removeItem('adminSecret');
          window.location.href = '/admin';
        }
        return;
      }

      const data = await res.json();

      document.getElementById('totalToday')!.textContent = data.totalToday || '0';
      document.getElementById('errors24h')!.textContent = data.errorsLast24h || '0';

      let pageviews = 0;
      let searches = 0;
      data.stats?.forEach((s: any) => {
        if (s.log_type === 'pageview') pageviews += s.count;
        if (s.log_type === 'search') searches += s.count;
      });

      document.getElementById('pageviews')!.textContent = pageviews.toString();
      document.getElementById('searches')!.textContent = searches.toString();
    } catch (err) {
      console.error('Stats load error:', err);
    }
  }

  // Load logs
  async function loadLogs(page = 1) {
    currentPage = page;
    const tbody = document.getElementById('logsBody')!;
    tbody.innerHTML = '<tr><td colspan="6" class="loading-row"><span class="spinner"></span> Y√ºkleniyor...</td></tr>';

    try {
      let url = `${API_URL}/api/admin/logs?page=${page}&limit=30`;
      if (currentType) url += `&type=${currentType}`;
      if (currentLevel) url += `&level=${currentLevel}`;

      const res = await fetch(url, {
        headers: { 'X-ADMIN-SECRET': ADMIN_SECRET }
      });

      if (!res.ok) throw new Error('Failed to load logs');

      const data = await res.json();

      if (!data.logs || data.logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-row">Kayƒ±t bulunamadƒ±</td></tr>';
        return;
      }

      tbody.innerHTML = data.logs.map((log: any) => {
        const date = new Date(log.created_at + 'Z');
        const timeStr = date.toLocaleString('tr-TR', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });

        const pageUrl = log.page_url ? log.page_url.replace('https://3d-labx.com', '') : '-';

        return `
          <tr>
            <td>${timeStr}</td>
            <td><span class="log-type ${log.log_type}">${log.log_type}</span></td>
            <td><span class="log-level ${log.log_level}">${log.log_level}</span></td>
            <td>${log.message || '-'}</td>
            <td class="page-url" title="${pageUrl}">${pageUrl}</td>
            <td>
              ${log.details ? `<button class="detail-btn" data-details="${encodeURIComponent(log.details)}">G√∂ster</button>` : '-'}
            </td>
          </tr>
        `;
      }).join('');

      // Attach detail button listeners
      document.querySelectorAll('.detail-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const encoded = (e.target as HTMLButtonElement).dataset.details || '';
          showDetail(encoded);
        });
      });

      // Render pagination
      renderPagination(data.pagination);
    } catch (err) {
      console.error('Logs load error:', err);
      tbody.innerHTML = '<tr><td colspan="6" class="empty-row">Hata olu≈ütu</td></tr>';
    }
  }

  // Render pagination
  function renderPagination(pagination: any) {
    const container = document.getElementById('pagination')!;
    if (!pagination || pagination.totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '';
    html += `<button ${pagination.page === 1 ? 'disabled' : ''} data-page="${pagination.page - 1}">‚Üê √ñnceki</button>`;

    for (let i = 1; i <= Math.min(pagination.totalPages, 5); i++) {
      html += `<button class="${i === pagination.page ? 'active' : ''}" data-page="${i}">${i}</button>`;
    }

    if (pagination.totalPages > 5) {
      html += `<span style="padding: 8px; color: var(--text-muted);">...</span>`;
      html += `<button data-page="${pagination.totalPages}">${pagination.totalPages}</button>`;
    }

    html += `<button ${pagination.page === pagination.totalPages ? 'disabled' : ''} data-page="${pagination.page + 1}">Sonraki ‚Üí</button>`;

    container.innerHTML = html;

    // Attach pagination click listeners
    container.querySelectorAll('button[data-page]').forEach(btn => {
      btn.addEventListener('click', () => {
        const page = parseInt((btn as HTMLButtonElement).dataset.page || '1');
        loadLogs(page);
      });
    });
  }

  // Show detail modal (clean, no inline styles)
  function showDetail(encodedDetails: string) {
    const details = decodeURIComponent(encodedDetails);
    let parsed: any;
    try {
      parsed = JSON.parse(details);
    } catch {
      parsed = details;
    }

    const content = document.getElementById('detailContent')!;
    content.textContent = typeof parsed === 'object' ? JSON.stringify(parsed, null, 2) : parsed;

    document.getElementById('detailModal')!.classList.remove('hidden');
  }

  // Modal close via data-close
  document.querySelectorAll('#detailModal [data-close]').forEach(el => {
    el.addEventListener('click', () => {
      document.getElementById('detailModal')!.classList.add('hidden');
    });
  });

  // ESC to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById('detailModal')!.classList.add('hidden');
    }
  });

  // Cleanup old logs
  async function cleanupLogs() {
    const days = prompt('Ka√ß g√ºnden eski loglar silinsin?', '30');
    if (!days) return;

    if (!confirm(`${days} g√ºnden eski t√ºm loglar silinecek. Emin misiniz?`)) return;

    try {
      const res = await fetch(`${API_URL}/api/admin/logs/cleanup?days=${days}`, {
        method: 'DELETE',
        headers: { 'X-ADMIN-SECRET': ADMIN_SECRET }
      });

      const data = await res.json();
      alert(`${data.deleted || 0} log kaydƒ± silindi.`);
      loadLogs(1);
      loadStats();
    } catch (err) {
      alert('Silme i≈ülemi ba≈üarƒ±sƒ±z!');
    }
  }

  // Event listeners
  document.getElementById('applyFilters')?.addEventListener('click', () => {
    currentType = (document.getElementById('filterType') as HTMLSelectElement).value;
    currentLevel = (document.getElementById('filterLevel') as HTMLSelectElement).value;
    loadLogs(1);
  });

  document.getElementById('refreshLogs')?.addEventListener('click', () => {
    loadLogs(currentPage);
    loadStats();
  });

  document.getElementById('cleanupLogs')?.addEventListener('click', cleanupLogs);

  // Initial load
  loadStats();
  loadLogs(1);
</script>
