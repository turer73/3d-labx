---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="ƒ∞√ßerik Kutularƒ± ‚Äì Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">üìä</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">üìù</span>
          Yazƒ±lar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">üë•</span>
          √úyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">üì°</span>
          RSS Kaynaklarƒ±
        </a>
        <a href="/admin/content-boxes" class="nav-item active">
          <span class="icon">üì¶</span>
          ƒ∞√ßerik Kutularƒ±
        </a>
        <a href="/admin/logs" class="nav-item">
          <span class="icon">üìã</span>
          Site Loglarƒ±
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">‚ûï</span>
          Yeni Yazƒ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          üö™ √áƒ±kƒ±≈ü Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>ƒ∞√ßerik Kutularƒ±</h1>
          <p class="text-muted">Sayfa bazlƒ± kutu yerle≈üimlerini s√ºr√ºkle-bƒ±rak ile y√∂netin</p>
        </div>
        <button id="addBoxBtn" class="btn btn-primary">
          ‚ûï Yeni Kutu Ekle
        </button>
      </header>

      <!-- Sayfa Se√ßici Tabs -->
      <div class="page-tabs">
        <button class="page-tab active" data-page="anasayfa">
          <span class="tab-icon">üè†</span>
          <span class="tab-label">Anasayfa</span>
          <span class="tab-count" id="count-anasayfa">0</span>
        </button>
        <button class="page-tab" data-page="rehberler">
          <span class="tab-icon">üìò</span>
          <span class="tab-label">Rehberler</span>
          <span class="tab-count" id="count-rehberler">0</span>
        </button>
        <button class="page-tab" data-page="sorun-cozumleri">
          <span class="tab-icon">üîß</span>
          <span class="tab-label">Sorun √á√∂z√ºmleri</span>
          <span class="tab-count" id="count-sorun-cozumleri">0</span>
        </button>
        <button class="page-tab" data-page="incelemeler">
          <span class="tab-icon">‚≠ê</span>
          <span class="tab-label">ƒ∞ncelemeler</span>
          <span class="tab-count" id="count-incelemeler">0</span>
        </button>
        <button class="page-tab" data-page="3d-baski">
          <span class="tab-icon">üì∞</span>
          <span class="tab-label">3D Baskƒ±</span>
          <span class="tab-count" id="count-3d-baski">0</span>
        </button>
      </div>

      <!-- √ñnizleme Modu Toggle -->
      <div class="preview-toolbar">
        <div class="toolbar-left">
          <span class="toolbar-label">G√∂r√ºn√ºm:</span>
          <button class="view-btn active" data-view="grid" title="Grid √ñnizleme">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          </button>
          <button class="view-btn" data-view="list" title="Liste G√∂r√ºn√ºm√º">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          </button>
        </div>
        <div class="toolbar-right">
          <span class="drag-hint">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l-3 3 3 3"/><path d="M9 5l3-3 3 3"/><path d="M15 19l-3 3-3-3"/><path d="M19 9l3 3-3 3"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
            S√ºr√ºkle-bƒ±rak ile sƒ±ralayƒ±n
          </span>
        </div>
      </div>

      <!-- Grid √ñnizleme Alanƒ± -->
      <section class="preview-section">
        <div id="boxesGrid" class="boxes-grid">
          <div class="loading-state">
            <span class="spinner"></span>
            <span>Kutular y√ºkleniyor...</span>
          </div>
        </div>

        <!-- Bo≈ü Durum -->
        <div id="emptyState" class="empty-state hidden">
          <div class="empty-icon">üì¶</div>
          <h3>Bu sayfa i√ßin kutu yok</h3>
          <p>Yeni bir i√ßerik kutusu ekleyerek ba≈ülayƒ±n</p>
          <button class="btn btn-primary" id="emptyAddBtn">
            ‚ûï ƒ∞lk Kutuyu Ekle
          </button>
        </div>
      </section>

      <!-- Liste G√∂r√ºn√ºm√º -->
      <section class="list-section hidden">
        <div id="boxesList" class="boxes-list"></div>
      </section>
    </main>
  </div>

  <!-- Ekle/D√ºzenle Modal -->
  <div id="editModal" class="modal hidden">
    <div class="modal-backdrop" id="editBackdrop"></div>
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="modalTitle">Yeni ƒ∞√ßerik Kutusu</h3>
        <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <form id="boxForm">
        <input type="hidden" id="boxId" value="">

        <div class="form-section">
          <h4 class="form-section-title">Temel Bilgiler</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="slotKey">Kutu Kimliƒüi *</label>
              <input type="text" id="slotKey" required placeholder="ornek-kutu">
              <span class="form-hint">Benzersiz bir kimlik (k√º√ß√ºk harf, tire)</span>
            </div>
            <div class="form-group">
              <label for="targetPage">Hedef Sayfa *</label>
              <select id="targetPage" required>
                <option value="anasayfa">üè† Anasayfa</option>
                <option value="rehberler">üìò Rehberler</option>
                <option value="sorun-cozumleri">üîß Sorun √á√∂z√ºmleri</option>
                <option value="incelemeler">‚≠ê ƒ∞ncelemeler</option>
                <option value="3d-baski">üì∞ 3D Baskƒ±</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="contentType">ƒ∞√ßerik Tipi *</label>
              <select id="contentType" required>
                <option value="">Se√ßin...</option>
                <option value="category_post">üìÑ Kategori Yazƒ±sƒ± (Dinamik)</option>
                <option value="custom_html">‚úèÔ∏è √ñzel ƒ∞√ßerik</option>
                <option value="poll">üìä Anket</option>
                <option value="filament_prices">üé® Filament Fiyatlarƒ±</option>
                <option value="ai_tools">ü§ñ AI Ara√ßlarƒ±</option>
                <option value="community">üë• Topluluk</option>
                <option value="featured_post">‚≠ê √ñne √áƒ±kan Yazƒ±</option>
              </select>
            </div>
            <div class="form-group">
              <label for="boxSize">Boyut</label>
              <select id="boxSize">
                <option value="normal">Normal (1x1)</option>
                <option value="large">B√ºy√ºk (2x1)</option>
                <option value="wide">Geni≈ü (1x2)</option>
                <option value="tall">Uzun (1x2 Dikey)</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="colorTheme">Renk Temasƒ±</label>
              <div class="color-picker">
                <label class="color-option">
                  <input type="radio" name="colorTheme" value="orange" checked>
                  <span class="color-swatch orange"></span>
                  <span>Turuncu</span>
                </label>
                <label class="color-option">
                  <input type="radio" name="colorTheme" value="cyan">
                  <span class="color-swatch cyan"></span>
                  <span>Camg√∂beƒüi</span>
                </label>
                <label class="color-option">
                  <input type="radio" name="colorTheme" value="purple">
                  <span class="color-swatch purple"></span>
                  <span>Mor</span>
                </label>
                <label class="color-option">
                  <input type="radio" name="colorTheme" value="green">
                  <span class="color-swatch green"></span>
                  <span>Ye≈üil</span>
                </label>
                <label class="color-option">
                  <input type="radio" name="colorTheme" value="yellow">
                  <span class="color-swatch yellow"></span>
                  <span>Sarƒ±</span>
                </label>
                <label class="color-option">
                  <input type="radio" name="colorTheme" value="pink">
                  <span class="color-swatch pink"></span>
                  <span>Pembe</span>
                </label>
              </div>
            </div>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="isVisible" checked>
              <span class="checkmark"></span>
              <span>G√∂r√ºn√ºr</span>
            </label>
          </div>
        </div>

        <!-- Dinamik config alanlarƒ± -->
        <div class="form-section" id="configSection">
          <h4 class="form-section-title">ƒ∞√ßerik Ayarlarƒ±</h4>
          <div id="configFields"></div>
        </div>

        <div class="modal-actions">
          <button type="button" id="cancelEditBtn" class="btn btn-secondary">ƒ∞ptal</button>
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Kaydet</span>
            <span class="btn-loading hidden">
              <span class="spinner-sm"></span>
              Kaydediliyor...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Silme Onay Modal -->
  <div id="deleteModal" class="modal hidden">
    <div class="modal-backdrop" id="deleteBackdrop"></div>
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Kutuyu Sil</h3>
      </div>
      <div class="modal-body">
        <p>Bu i√ßerik kutusunu silmek istediƒüinizden emin misiniz?</p>
        <p class="delete-box-name"><strong id="deleteBoxName"></strong></p>
      </div>
      <div class="modal-actions">
        <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">ƒ∞ptal</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Sil</button>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Page Tabs */
  .page-tabs {
    display: flex;
    gap: 8px;
    padding: 16px 0;
    border-bottom: 1px solid var(--admin-border);
    margin-bottom: 20px;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .page-tabs::-webkit-scrollbar {
    display: none;
  }

  .page-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--admin-surface);
    border: 1px solid var(--admin-border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    font-size: 0.9rem;
    color: var(--admin-text-muted);
  }

  .page-tab:hover {
    border-color: var(--admin-primary);
    background: var(--admin-surface-hover);
  }

  .page-tab.active {
    background: linear-gradient(135deg, rgba(234, 88, 12, 0.15), rgba(234, 88, 12, 0.05));
    border-color: var(--admin-primary);
    color: var(--admin-primary);
  }

  .tab-icon {
    font-size: 1.1rem;
  }

  .tab-label {
    font-weight: 600;
  }

  .tab-count {
    background: var(--admin-surface-hover);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
  }

  .page-tab.active .tab-count {
    background: var(--admin-primary);
    color: white;
  }

  /* Preview Toolbar */
  .preview-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--admin-surface);
    border: 1px solid var(--admin-border);
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .toolbar-label {
    font-size: 0.85rem;
    color: var(--admin-text-muted);
  }

  .view-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--admin-border);
    border-radius: 8px;
    cursor: pointer;
    color: var(--admin-text-muted);
    transition: all 0.2s;
  }

  .view-btn:hover {
    border-color: var(--admin-primary);
    color: var(--admin-primary);
  }

  .view-btn.active {
    background: var(--admin-primary);
    border-color: var(--admin-primary);
    color: white;
  }

  .drag-hint {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--admin-text-muted);
    padding: 6px 12px;
    background: rgba(234, 88, 12, 0.1);
    border-radius: 8px;
  }

  .drag-hint svg {
    color: var(--admin-primary);
  }

  /* Preview Section */
  .preview-section {
    min-height: 400px;
  }

  /* Boxes Grid - Bento Style */
  .boxes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    min-height: 300px;
  }

  @media (max-width: 1024px) {
    .boxes-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .boxes-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Grid Box Card */
  .grid-box {
    background: var(--admin-surface);
    border: 2px solid var(--admin-border);
    border-radius: 16px;
    padding: 20px;
    min-height: 180px;
    cursor: grab;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .grid-box:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  }

  .grid-box.dragging {
    opacity: 0.5;
    cursor: grabbing;
    transform: scale(1.02);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 100;
  }

  .grid-box.drag-over {
    border-color: var(--admin-primary);
    border-style: dashed;
    background: rgba(234, 88, 12, 0.05);
  }

  /* Size Variants */
  .grid-box.size-large {
    grid-column: span 2;
  }

  .grid-box.size-wide {
    grid-column: span 2;
  }

  .grid-box.size-tall {
    grid-row: span 2;
    min-height: 380px;
  }

  /* Color Themes */
  .grid-box.theme-orange {
    border-left: 4px solid #EA580C;
  }
  .grid-box.theme-cyan {
    border-left: 4px solid #06B6D4;
  }
  .grid-box.theme-purple {
    border-left: 4px solid #8B5CF6;
  }
  .grid-box.theme-green {
    border-left: 4px solid #22C55E;
  }
  .grid-box.theme-yellow {
    border-left: 4px solid #EAB308;
  }
  .grid-box.theme-pink {
    border-left: 4px solid #EC4899;
  }

  .grid-box.hidden-box {
    opacity: 0.5;
    border-style: dashed;
  }

  /* Box Header */
  .box-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .box-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    padding: 4px 10px;
    border-radius: 6px;
    background: rgba(234, 88, 12, 0.1);
    color: var(--admin-primary);
  }

  .box-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .grid-box:hover .box-actions {
    opacity: 1;
  }

  .box-action-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--admin-surface-hover);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .box-action-btn:hover {
    background: var(--admin-primary);
    color: white;
  }

  .box-action-btn.delete:hover {
    background: #EF4444;
  }

  /* Box Content */
  .box-content {
    flex: 1;
  }

  .box-title {
    font-size: 1rem;
    font-weight: 700;
    margin: 0 0 8px;
    color: var(--admin-text);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .box-description {
    font-size: 0.85rem;
    color: var(--admin-text-muted);
    line-height: 1.5;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Box Footer */
  .box-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid var(--admin-border);
  }

  .box-meta {
    display: flex;
    gap: 8px;
  }

  .box-meta-item {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 6px;
    background: var(--admin-surface-hover);
    color: var(--admin-text-muted);
  }

  .box-order {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: var(--admin-text-muted);
  }

  .box-order-num {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--admin-primary);
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.7rem;
  }

  /* Visibility Badge */
  .visibility-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #22C55E;
  }

  .visibility-badge.hidden {
    background: #6B7280;
  }

  /* Empty State */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state h3 {
    margin: 0 0 8px;
    color: var(--admin-text);
  }

  .empty-state p {
    margin: 0 0 20px;
    color: var(--admin-text-muted);
  }

  /* Loading State */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 60px;
    grid-column: 1 / -1;
    color: var(--admin-text-muted);
  }

  /* List View */
  .list-section {
    background: var(--admin-surface);
    border: 1px solid var(--admin-border);
    border-radius: 16px;
    overflow: hidden;
  }

  .boxes-list {
    display: flex;
    flex-direction: column;
  }

  .list-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    border-bottom: 1px solid var(--admin-border);
    cursor: grab;
    transition: all 0.2s;
  }

  .list-item:last-child {
    border-bottom: none;
  }

  .list-item:hover {
    background: var(--admin-surface-hover);
  }

  .list-item.dragging {
    opacity: 0.5;
    background: rgba(234, 88, 12, 0.1);
  }

  .list-drag-handle {
    color: var(--admin-text-muted);
    cursor: grab;
  }

  .list-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .list-info {
    flex: 1;
    min-width: 0;
  }

  .list-info h4 {
    margin: 0;
    font-size: 0.95rem;
    color: var(--admin-text);
  }

  .list-info p {
    margin: 2px 0 0;
    font-size: 0.8rem;
    color: var(--admin-text-muted);
  }

  .list-badges {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }

  .list-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  /* Modal Improvements */
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--admin-border);
  }

  .modal-header h3 {
    margin: 0;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--admin-surface-hover);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--admin-text-muted);
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: #EF4444;
    color: white;
  }

  .modal-body {
    padding: 20px 0;
  }

  .delete-box-name {
    padding: 12px;
    background: var(--admin-surface-hover);
    border-radius: 8px;
    margin-top: 12px;
  }

  /* Form Section */
  .form-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--admin-border);
  }

  .form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .form-section-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--admin-primary);
    margin: 0 0 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-hint {
    display: block;
    font-size: 0.75rem;
    color: var(--admin-text-muted);
    margin-top: 4px;
  }

  /* Color Picker */
  .color-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .color-option {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: var(--admin-surface-hover);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
  }

  .color-option:hover {
    border-color: var(--admin-border);
  }

  .color-option input {
    display: none;
  }

  .color-option input:checked + .color-swatch {
    transform: scale(1.2);
    box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
  }

  .color-option:has(input:checked) {
    border-color: var(--admin-primary);
    background: rgba(234, 88, 12, 0.1);
  }

  .color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    transition: all 0.2s;
  }

  .color-swatch.orange { background: #EA580C; }
  .color-swatch.cyan { background: #06B6D4; }
  .color-swatch.purple { background: #8B5CF6; }
  .color-swatch.green { background: #22C55E; }
  .color-swatch.yellow { background: #EAB308; }
  .color-swatch.pink { background: #EC4899; }

  /* Checkbox Group */
  .checkbox-group {
    margin-top: 16px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .checkbox-label input {
    display: none;
  }

  .checkmark {
    width: 22px;
    height: 22px;
    border: 2px solid var(--admin-border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .checkbox-label input:checked + .checkmark {
    background: var(--admin-primary);
    border-color: var(--admin-primary);
  }

  .checkbox-label input:checked + .checkmark::after {
    content: '‚úì';
    color: white;
    font-size: 0.8rem;
    font-weight: bold;
  }

  /* Button Loading */
  .btn-loading {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .spinner-sm {
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Form Row */
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .modal-lg {
    max-width: 700px;
  }

  .modal-sm {
    max-width: 400px;
  }

  #configFields .form-group {
    margin-top: 12px;
  }

  #configFields .form-group:first-child {
    margin-top: 0;
  }

  /* Hidden class */
  .hidden {
    display: none !important;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .page-tabs {
      gap: 6px;
    }

    .page-tab {
      padding: 10px 14px;
      font-size: 0.8rem;
    }

    .tab-label {
      display: none;
    }

    .preview-toolbar {
      flex-direction: column;
      gap: 12px;
    }

    .toolbar-left, .toolbar-right {
      width: 100%;
      justify-content: center;
    }

    .grid-box {
      padding: 16px;
      min-height: 150px;
    }

    .grid-box.size-large,
    .grid-box.size-wide {
      grid-column: span 1;
    }

    .grid-box.size-tall {
      grid-row: span 1;
      min-height: 150px;
    }
  }
</style>

<script>
  const API_BASE = 'https://tech-portal-api.turgut-d01.workers.dev';
  const secret = localStorage.getItem('adminSecret');
  if (!secret) { window.location.href = '/admin'; }

  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  function toggleMobileMenu() {
    mobileMenuToggle?.classList.toggle('active');
    sidebar?.classList.toggle('open');
    sidebarOverlay?.classList.toggle('active');
  }

  mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
  sidebarOverlay?.addEventListener('click', toggleMobileMenu);

  // Types
  const contentTypeNames: Record<string, string> = {
    'category_post': 'üìÑ Kategori Yazƒ±sƒ±',
    'custom_html': '‚úèÔ∏è √ñzel ƒ∞√ßerik',
    'poll': 'üìä Anket',
    'filament_prices': 'üé® Filament',
    'ai_tools': 'ü§ñ AI Ara√ßlarƒ±',
    'community': 'üë• Topluluk',
    'featured_post': '‚≠ê √ñne √áƒ±kan'
  };

  const colorMap: Record<string, string> = {
    'orange': '#EA580C',
    'cyan': '#06B6D4',
    'purple': '#8B5CF6',
    'green': '#22C55E',
    'yellow': '#EAB308',
    'pink': '#EC4899'
  };

  let allBoxes: any[] = [];
  let currentPage = 'anasayfa';
  let currentView = 'grid';
  let editingId: number | null = null;
  let deleteId: number | null = null;
  let draggedElement: HTMLElement | null = null;

  // Load boxes
  async function loadBoxes() {
    try {
      const res = await fetch(`${API_BASE}/admin/content-boxes`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });
      if (!res.ok) throw new Error('Unauthorized');
      allBoxes = await res.json();
      updatePageCounts();
      renderBoxes();
    } catch (err) {
      console.error('Y√ºklenemedi:', err);
      showError('Kutular y√ºklenirken hata olu≈ütu');
    }
  }

  function updatePageCounts() {
    const pages = ['anasayfa', 'rehberler', 'sorun-cozumleri', 'incelemeler', '3d-baski'];
    pages.forEach(page => {
      const count = allBoxes.filter(b => (b.target_page || 'anasayfa') === page).length;
      const el = document.getElementById(`count-${page}`);
      if (el) el.textContent = count.toString();
    });
  }

  function getPageBoxes() {
    return allBoxes
      .filter(b => (b.target_page || 'anasayfa') === currentPage)
      .sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
  }

  function renderBoxes() {
    const boxes = getPageBoxes();
    const gridContainer = document.getElementById('boxesGrid')!;
    const listContainer = document.getElementById('boxesList')!;
    const emptyState = document.getElementById('emptyState')!;
    const previewSection = document.querySelector('.preview-section');
    const listSection = document.querySelector('.list-section');

    if (boxes.length === 0) {
      emptyState.classList.remove('hidden');
      gridContainer.innerHTML = '';
      listContainer.innerHTML = '';
      return;
    }

    emptyState.classList.add('hidden');

    if (currentView === 'grid') {
      previewSection.classList.remove('hidden');
      listSection.classList.add('hidden');
      renderGridView(boxes, gridContainer);
    } else {
      previewSection.classList.add('hidden');
      listSection.classList.remove('hidden');
      renderListView(boxes, listContainer);
    }
  }

  function renderGridView(boxes: any[], container: HTMLElement) {
    container.innerHTML = boxes.map((box: any, idx: number) => {
      const config = JSON.parse(box.config || '{}');
      const title = config.title || config.category || box.slot_key;
      const description = config.description || config.stat_text || '';
      const typeName = contentTypeNames[box.content_type] || box.content_type;
      const sizeClass = box.size !== 'normal' ? `size-${box.size}` : '';
      const themeClass = `theme-${box.color_theme || 'orange'}`;
      const hiddenClass = !box.is_visible ? 'hidden-box' : '';

      return `
        <div class="grid-box ${sizeClass} ${themeClass} ${hiddenClass}"
             data-id="${box.id}"
             data-order="${box.display_order || idx}"
             draggable="true">
          <div class="visibility-badge ${!box.is_visible ? 'hidden' : ''}"></div>
          <div class="box-header">
            <span class="box-type-badge">${typeName}</span>
            <div class="box-actions">
              <button class="box-action-btn edit-btn" data-id="${box.id}" title="D√ºzenle">‚úèÔ∏è</button>
              <button class="box-action-btn delete delete-btn" data-id="${box.id}" data-name="${title}" title="Sil">üóëÔ∏è</button>
            </div>
          </div>
          <div class="box-content">
            <h3 class="box-title">${title}</h3>
            ${description ? `<p class="box-description">${description}</p>` : ''}
          </div>
          <div class="box-footer">
            <div class="box-meta">
              <span class="box-meta-item">${box.size || 'normal'}</span>
              ${!box.is_visible ? '<span class="box-meta-item">Gizli</span>' : ''}
            </div>
            <div class="box-order">
              <span class="box-order-num">${idx + 1}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Add event listeners
    addBoxEventListeners(container);
    addDragListeners(container);
  }

  function renderListView(boxes: any[], container: HTMLElement) {
    container.innerHTML = boxes.map((box: any, idx: number) => {
      const config = JSON.parse(box.config || '{}');
      const title = config.title || config.category || box.slot_key;
      const typeName = contentTypeNames[box.content_type] || box.content_type;

      return `
        <div class="list-item" data-id="${box.id}" data-order="${box.display_order || idx}" draggable="true">
          <div class="list-drag-handle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/>
              <circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>
            </svg>
          </div>
          <div class="list-color" style="background: ${colorMap[box.color_theme] || '#EA580C'}"></div>
          <div class="list-info">
            <h4>${title}</h4>
            <p>${box.slot_key} ¬∑ Sƒ±ra: ${idx + 1}</p>
          </div>
          <div class="list-badges">
            <span class="box-meta-item">${typeName}</span>
            <span class="box-meta-item">${box.size || 'normal'}</span>
            <button class="status-toggle ${box.is_visible ? 'published' : 'draft'}" data-id="${box.id}" data-visible="${box.is_visible}">
              ${box.is_visible ? 'G√∂r√ºn√ºr' : 'Gizli'}
            </button>
          </div>
          <div class="list-actions">
            <button class="btn btn-ghost btn-sm edit-btn" data-id="${box.id}">‚úèÔ∏è</button>
            <button class="btn btn-ghost btn-sm delete-btn" data-id="${box.id}" data-name="${title}">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');

    addBoxEventListeners(container);
    addDragListeners(container);
  }

  function addBoxEventListeners(container: HTMLElement) {
    container.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', handleEdit);
    });
    container.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', handleDelete);
    });
    container.querySelectorAll('.status-toggle').forEach(btn => {
      btn.addEventListener('click', handleToggleVisibility);
    });
  }

  // Drag and Drop
  function addDragListeners(container: HTMLElement) {
    const items = container.querySelectorAll('[draggable="true"]');

    items.forEach(item => {
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragend', handleDragEnd);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('dragenter', handleDragEnter);
      item.addEventListener('dragleave', handleDragLeave);
      item.addEventListener('drop', handleDrop);
    });
  }

  function handleDragStart(e: DragEvent) {
    draggedElement = e.target;
    draggedElement.classList.add('dragging');
    e.dataTransfer!.effectAllowed = 'move';
    e.dataTransfer!.setData('text/plain', draggedElement.dataset.id || '');
  }

  function handleDragEnd(e: DragEvent) {
    const el = e.target;
    el.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    draggedElement = null;
  }

  function handleDragOver(e: DragEvent) {
    e.preventDefault();
    e.dataTransfer!.dropEffect = 'move';
  }

  function handleDragEnter(e: DragEvent) {
    const target = (e.target).closest('[draggable="true"]');
    if (target && target !== draggedElement) {
      target.classList.add('drag-over');
    }
  }

  function handleDragLeave(e: DragEvent) {
    const target = (e.target).closest('[draggable="true"]');
    if (target) {
      target.classList.remove('drag-over');
    }
  }

  async function handleDrop(e: DragEvent) {
    e.preventDefault();
    const target = (e.target).closest('[draggable="true"]');
    if (!target || !draggedElement || target === draggedElement) return;

    target.classList.remove('drag-over');

    const draggedId = parseInt(draggedElement.dataset.id || '0');
    const targetId = parseInt(target.dataset.id || '0');

    // Reorder in allBoxes
    const pageBoxes = getPageBoxes();
    const draggedIdx = pageBoxes.findIndex(b => b.id === draggedId);
    const targetIdx = pageBoxes.findIndex(b => b.id === targetId);

    if (draggedIdx < 0 || targetIdx < 0) return;

    // Build new order
    const newOrder = pageBoxes.map((b, i) => {
      if (i === draggedIdx) return { id: pageBoxes[targetIdx].id, display_order: i + 1 };
      if (i === targetIdx) return { id: pageBoxes[draggedIdx].id, display_order: i + 1 };
      return { id: b.id, display_order: i + 1 };
    });

    // Swap orders
    const orders = pageBoxes.map((b, i) => ({ id: b.id, display_order: i + 1 }));
    const temp = orders[draggedIdx].display_order;
    orders[draggedIdx].display_order = orders[targetIdx].display_order;
    orders[targetIdx].display_order = temp;

    try {
      await fetch(`${API_BASE}/admin/content-boxes/reorder`, {
        method: 'POST',
        headers: { 'X-ADMIN-SECRET': secret!, 'Content-Type': 'application/json' },
        body: JSON.stringify({ order: orders })
      });
      loadBoxes();
    } catch (err) {
      console.error('Sƒ±ralama hatasƒ±:', err);
    }
  }

  // Page Tabs
  document.querySelectorAll('.page-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentPage = (tab).dataset.page || 'anasayfa';
      renderBoxes();
    });
  });

  // View Toggle
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentView = (btn).dataset.view || 'grid';
      renderBoxes();
    });
  });

  // Toggle Visibility
  async function handleToggleVisibility(e: Event) {
    const btn = e.target;
    const id = parseInt(btn.dataset.id || '0');
    const currentVisible = btn.dataset.visible === '1';

    try {
      await fetch(`${API_BASE}/admin/content-boxes/${id}`, {
        method: 'PUT',
        headers: { 'X-ADMIN-SECRET': secret!, 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_visible: !currentVisible })
      });
      loadBoxes();
    } catch (err) {
      console.error('Toggle hatasƒ±:', err);
    }
  }

  // Edit
  function handleEdit(e: Event) {
    const btn = e.target;
    const id = parseInt(btn.dataset.id || '0');
    const box = allBoxes.find(b => b.id === id);
    if (!box) return;

    editingId = id;
    document.getElementById('modalTitle')!.textContent = 'ƒ∞√ßerik Kutusunu D√ºzenle';
    (document.getElementById('boxId')).value = id.toString();
    (document.getElementById('slotKey')).value = box.slot_key;
    (document.getElementById('targetPage')).value = box.target_page || 'anasayfa';
    (document.getElementById('contentType')).value = box.content_type;
    (document.getElementById('boxSize')).value = box.size || 'normal';
    (document.getElementById('isVisible')).checked = !!box.is_visible;

    // Set color theme
    const colorRadio = document.querySelector(`input[name="colorTheme"][value="${box.color_theme || 'orange'}"]`);
    if (colorRadio) colorRadio.checked = true;

    updateConfigFields(box.content_type, JSON.parse(box.config || '{}'));
    document.getElementById('editModal')!.classList.remove('hidden');
  }

  // Delete
  function handleDelete(e: Event) {
    const btn = e.target;
    deleteId = parseInt(btn.dataset.id || '0');
    document.getElementById('deleteBoxName')!.textContent = btn.dataset.name || '';
    document.getElementById('deleteModal')!.classList.remove('hidden');
  }

  // Config Fields
  function updateConfigFields(type: string, config: any = {}) {
    const container = document.getElementById('configFields')!;
    const section = document.getElementById('configSection')!;

    if (!type) {
      section.classList.add('hidden');
      container.innerHTML = '';
      return;
    }

    section.classList.remove('hidden');

    if (type === 'category_post') {
      container.innerHTML = `
        <div class="form-row">
          <div class="form-group">
            <label for="cfgCategory">Kategori *</label>
            <select id="cfgCategory">
              <option value="3d-baski" ${config.category === '3d-baski' ? 'selected' : ''}>3D Baskƒ±</option>
              <option value="incelemeler" ${config.category === 'incelemeler' ? 'selected' : ''}>ƒ∞ncelemeler</option>
              <option value="rehberler" ${config.category === 'rehberler' ? 'selected' : ''}>Rehberler</option>
              <option value="sorun-cozumleri" ${config.category === 'sorun-cozumleri' ? 'selected' : ''}>Sorun √á√∂z√ºmleri</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cfgTagLabel">Etiket</label>
            <input type="text" id="cfgTagLabel" value="${config.tag_label || ''}" placeholder="Katmanlƒ± ƒ∞malat">
          </div>
        </div>
        <div class="form-group">
          <label for="cfgStatText">ƒ∞statistik Metni</label>
          <input type="text" id="cfgStatText" value="${config.stat_text || ''}" placeholder="+%12 Hƒ±z Artƒ±≈üƒ±">
        </div>
        <div class="form-group">
          <label for="cfgPostCount">G√∂sterilecek Yazƒ± Sayƒ±sƒ±</label>
          <input type="number" id="cfgPostCount" value="${config.post_count || 4}" min="1" max="12">
        </div>
      `;
    } else if (type === 'custom_html') {
      container.innerHTML = `
        <div class="form-group">
          <label for="cfgTitle">Ba≈ülƒ±k *</label>
          <input type="text" id="cfgTitle" value="${config.title || ''}" placeholder="Klipper Kurulum Rehberi">
        </div>
        <div class="form-group">
          <label for="cfgDescription">A√ßƒ±klama</label>
          <textarea id="cfgDescription" rows="3" placeholder="Kƒ±sa a√ßƒ±klama...">${config.description || ''}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgTagLabel">Etiket</label>
            <input type="text" id="cfgTagLabel" value="${config.tag_label || ''}" placeholder="Rehberler">
          </div>
          <div class="form-group">
            <label for="cfgLinkUrl">Link URL</label>
            <input type="text" id="cfgLinkUrl" value="${config.link_url || ''}" placeholder="/rehberler">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgCodeBlock">Kod Bloƒüu</label>
            <textarea id="cfgCodeBlock" rows="2" placeholder="$ git clone ...">${config.code_block || ''}</textarea>
          </div>
          <div class="form-group">
            <label for="cfgVersion">Versiyon Etiketi</label>
            <input type="text" id="cfgVersion" value="${config.version || ''}" placeholder="v2.1.0">
          </div>
        </div>
        <div class="form-group">
          <label for="cfgImageUrl">G√∂rsel URL</label>
          <input type="text" id="cfgImageUrl" value="${config.image_url || ''}" placeholder="https://...">
        </div>
      `;
    } else if (type === 'ai_tools') {
      container.innerHTML = `
        <div class="form-group">
          <label for="cfgTitle">Ba≈ülƒ±k</label>
          <input type="text" id="cfgTitle" value="${config.title || ''}" placeholder="Dijital Asistanlar">
        </div>
        <div class="form-group">
          <label for="cfgDescription">A√ßƒ±klama</label>
          <input type="text" id="cfgDescription" value="${config.description || ''}" placeholder="3D tasarƒ±m i√ßin AI ara√ßlarƒ±">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgTools">Ara√ß Listesi (virg√ºlle)</label>
            <input type="text" id="cfgTools" value="${(config.tools || []).join(', ')}" placeholder="Obico, Luma AI, Meshy">
          </div>
          <div class="form-group">
            <label for="cfgExtraCount">Ek Ara√ß Sayƒ±sƒ±</label>
            <input type="number" id="cfgExtraCount" value="${config.extra_count || 0}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgTagLabel">Etiket</label>
            <input type="text" id="cfgTagLabel" value="${config.tag_label || ''}" placeholder="AI Studyo">
          </div>
          <div class="form-group">
            <label for="cfgLinkUrl">Link URL</label>
            <input type="text" id="cfgLinkUrl" value="${config.link_url || ''}" placeholder="/ai-araclar">
          </div>
        </div>
      `;
    } else if (type === 'community') {
      container.innerHTML = `
        <div class="form-group">
          <label for="cfgTitle">Ba≈ülƒ±k</label>
          <input type="text" id="cfgTitle" value="${config.title || ''}" placeholder="ABS √áatlama Sorunu">
        </div>
        <div class="form-group">
          <label for="cfgDescription">A√ßƒ±klama</label>
          <input type="text" id="cfgDescription" value="${config.description || ''}" placeholder="Kƒ±sa a√ßƒ±klama">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgComments">Yorum Sayƒ±sƒ±</label>
            <input type="number" id="cfgComments" value="${config.comments || 0}">
          </div>
          <div class="form-group">
            <label for="cfgLikes">Beƒüeni Sayƒ±sƒ±</label>
            <input type="number" id="cfgLikes" value="${config.likes || 0}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgTagLabel">Etiket</label>
            <input type="text" id="cfgTagLabel" value="${config.tag_label || ''}" placeholder="Sƒ±cak Tartƒ±≈üma">
          </div>
          <div class="form-group">
            <label for="cfgLinkUrl">Link URL</label>
            <input type="text" id="cfgLinkUrl" value="${config.link_url || ''}" placeholder="/topluluk">
          </div>
        </div>
      `;
    } else if (type === 'poll') {
      container.innerHTML = `
        <div class="form-group">
          <label for="cfgTagLabel">Etiket</label>
          <input type="text" id="cfgTagLabel" value="${config.tag_label || 'Anket'}" placeholder="Anket">
        </div>
        <p class="form-hint" style="margin-top:12px;">Aktif anket otomatik olarak g√∂sterilir. Anket y√∂netimi i√ßin ayrƒ± bir panel kullanƒ±n.</p>
      `;
    } else if (type === 'filament_prices') {
      container.innerHTML = `
        <p class="form-hint">Filament fiyatlarƒ± otomatik olarak veritabanƒ±ndan √ßekilir. Ek ayar gerekmez.</p>
      `;
    } else if (type === 'featured_post') {
      container.innerHTML = `
        <div class="form-group">
          <label for="cfgPostSlug">Yazƒ± Slug (bo≈ü bƒ±rakƒ±lƒ±rsa son yazƒ±)</label>
          <input type="text" id="cfgPostSlug" value="${config.post_slug || ''}" placeholder="ornek-yazi-slug">
        </div>
        <div class="form-group">
          <label for="cfgTagLabel">Etiket</label>
          <input type="text" id="cfgTagLabel" value="${config.tag_label || '√ñne √áƒ±kan'}" placeholder="√ñne √áƒ±kan">
        </div>
      `;
    } else {
      container.innerHTML = '';
      section.classList.add('hidden');
    }
  }

  function getConfigFromForm(type: string): any {
    const config: any = {};

    const tagLabel = (document.getElementById('cfgTagLabel'))?.value;
    if (tagLabel) config.tag_label = tagLabel;

    const linkUrl = (document.getElementById('cfgLinkUrl'))?.value;
    if (linkUrl) config.link_url = linkUrl;

    if (type === 'category_post') {
      config.category = (document.getElementById('cfgCategory'))?.value || '3d-baski';
      const statText = (document.getElementById('cfgStatText'))?.value;
      if (statText) config.stat_text = statText;
      const postCount = (document.getElementById('cfgPostCount'))?.value;
      if (postCount) config.post_count = parseInt(postCount);
    } else if (type === 'custom_html') {
      config.title = (document.getElementById('cfgTitle'))?.value || '';
      config.description = (document.getElementById('cfgDescription'))?.value || '';
      const codeBlock = (document.getElementById('cfgCodeBlock'))?.value;
      if (codeBlock) config.code_block = codeBlock;
      const version = (document.getElementById('cfgVersion'))?.value;
      if (version) config.version = version;
      const imageUrl = (document.getElementById('cfgImageUrl'))?.value;
      if (imageUrl) config.image_url = imageUrl;
    } else if (type === 'ai_tools') {
      config.title = (document.getElementById('cfgTitle'))?.value || '';
      config.description = (document.getElementById('cfgDescription'))?.value || '';
      const toolsStr = (document.getElementById('cfgTools'))?.value || '';
      config.tools = toolsStr.split(',').map((t: string) => t.trim()).filter(Boolean);
      config.extra_count = parseInt((document.getElementById('cfgExtraCount'))?.value || '0');
    } else if (type === 'community') {
      config.title = (document.getElementById('cfgTitle'))?.value || '';
      config.description = (document.getElementById('cfgDescription'))?.value || '';
      config.comments = parseInt((document.getElementById('cfgComments'))?.value || '0');
      config.likes = parseInt((document.getElementById('cfgLikes'))?.value || '0');
    } else if (type === 'featured_post') {
      const postSlug = (document.getElementById('cfgPostSlug'))?.value;
      if (postSlug) config.post_slug = postSlug;
    }

    return config;
  }

  // Content type deƒüi≈üince config alanlarƒ±nƒ± g√ºncelle
  document.getElementById('contentType')?.addEventListener('change', (e) => {
    const type = (e.target).value;
    updateConfigFields(type);
  });

  // Yeni kutu ekleme
  document.getElementById('addBoxBtn')?.addEventListener('click', openAddModal);
  document.getElementById('emptyAddBtn')?.addEventListener('click', openAddModal);

  function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle')!.textContent = 'Yeni ƒ∞√ßerik Kutusu';
    (document.getElementById('boxForm')).reset();
    (document.getElementById('boxId')).value = '';
    (document.getElementById('targetPage')).value = currentPage;
    (document.getElementById('isVisible')).checked = true;
    const orangeRadio = document.querySelector('input[name="colorTheme"][value="orange"]');
    if (orangeRadio) orangeRadio.checked = true;
    document.getElementById('configFields')!.innerHTML = '';
    document.getElementById('configSection')!.classList.add('hidden');
    document.getElementById('editModal')!.classList.remove('hidden');
  }

  // Form g√∂nderme
  document.getElementById('boxForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = (document.getElementById('boxId')).value;
    const contentType = (document.getElementById('contentType')).value;
    const colorTheme = (document.querySelector('input[name="colorTheme"]:checked'))?.value || 'orange';

    const payload: any = {
      slot_key: (document.getElementById('slotKey')).value,
      target_page: (document.getElementById('targetPage')).value,
      content_type: contentType,
      size: (document.getElementById('boxSize')).value,
      color_theme: colorTheme,
      is_visible: (document.getElementById('isVisible')).checked,
      config: getConfigFromForm(contentType)
    };

    if (!id) {
      const pageBoxes = allBoxes.filter(b => (b.target_page || 'anasayfa') === payload.target_page);
      const maxOrder = pageBoxes.reduce((max: number, b: any) => Math.max(max, b.display_order || 0), 0);
      payload.display_order = maxOrder + 1;
    }

    const submitBtn = document.querySelector('#boxForm button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');
    submitBtn.disabled = true;

    try {
      const url = id ? `${API_BASE}/admin/content-boxes/${id}` : `${API_BASE}/admin/content-boxes`;
      const method = id ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: { 'X-ADMIN-SECRET': secret!, 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (res.ok && data.success) {
        document.getElementById('editModal')!.classList.add('hidden');
        loadBoxes();
      } else {
        alert(data.error || data.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z');
      }
    } catch (err) {
      console.error('Kaydetme hatasƒ±:', err);
      alert('Bir hata olu≈ütu');
    } finally {
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
      submitBtn.disabled = false;
    }
  });

  // Silme
  async function deleteBox() {
    if (!deleteId) return;
    try {
      const res = await fetch(`${API_BASE}/admin/content-boxes/${deleteId}`, {
        method: 'DELETE',
        headers: { 'X-ADMIN-SECRET': secret! }
      });
      if (res.ok) {
        document.getElementById('deleteModal')!.classList.add('hidden');
        deleteId = null;
        loadBoxes();
      }
    } catch (err) {
      console.error('Silme hatasƒ±:', err);
    }
  }

  // Modal kapatma
  document.getElementById('cancelEditBtn')?.addEventListener('click', closeEditModal);
  document.getElementById('editBackdrop')?.addEventListener('click', closeEditModal);
  document.getElementById('modalCloseBtn')?.addEventListener('click', closeEditModal);

  function closeEditModal() {
    document.getElementById('editModal')!.classList.add('hidden');
  }

  document.getElementById('cancelDeleteBtn')?.addEventListener('click', closeDeleteModal);
  document.getElementById('deleteBackdrop')?.addEventListener('click', closeDeleteModal);

  function closeDeleteModal() {
    document.getElementById('deleteModal')!.classList.add('hidden');
    deleteId = null;
  }

  document.getElementById('confirmDeleteBtn')?.addEventListener('click', deleteBox);

  function showError(message: string) {
    const container = document.getElementById('boxesGrid')!;
    container.innerHTML = `<div class="loading-state" style="color: #EF4444;">${message}</div>`;
  }

  // Y√ºkle
  loadBoxes();
</script>
