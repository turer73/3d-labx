---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="YazÄ±lar â€“ Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">ğŸ“Š</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item active">
          <span class="icon">ğŸ“</span>
          YazÄ±lar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">ğŸ‘¥</span>
          Ãœyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">ğŸ“¡</span>
          RSS KaynaklarÄ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">ğŸ“¦</span>
          Ä°Ã§erik KutularÄ±
        </a>
        <a href="/admin/logs" class="nav-item">
          <span class="icon">ğŸ“‹</span>
          Site LoglarÄ±
        </a>
        <a href="/admin/translations" class="nav-item">
          <span class="icon">ğŸŒ</span>
          Ã‡eviriler
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">â•</span>
          Yeni YazÄ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>YazÄ±lar</h1>
          <p class="text-muted">TÃ¼m yazÄ±larÄ± yÃ¶netin ve dÃ¼zenleyin</p>
        </div>
        <a href="/admin/new" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Yeni YazÄ±
        </a>
      </header>

      <!-- Stats Row -->
      <div class="stats-grid" id="postStats">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“„</div>
          <div class="stat-info">
            <span class="stat-value" id="statTotal">-</span>
            <span class="stat-label">Toplam YazÄ±</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-info">
            <span class="stat-value" id="statPublished">-</span>
            <span class="stat-label">YayÄ±nda</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-info">
            <span class="stat-value" id="statDraft">-</span>
            <span class="stat-label">Taslak</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â­</div>
          <div class="stat-info">
            <span class="stat-value" id="statFeatured">-</span>
            <span class="stat-label">Ã–ne Ã‡Ä±kan</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filter-bar">
        <select id="categoryFilter" class="filter-select">
          <option value="">TÃ¼m Kategoriler</option>
          <option value="3d-baski">ğŸ”¶ 3D BaskÄ± Haberleri</option>
          <option value="rehberler">ğŸ“˜ Rehberler</option>
          <option value="sorun-cozumleri">ğŸ”§ Sorun Ã‡Ã¶zÃ¼mleri</option>
          <option value="incelemeler">â­ Ä°ncelemeler</option>
        </select>

        <select id="statusFilter" class="filter-select">
          <option value="">TÃ¼m Durumlar</option>
          <option value="1">YayÄ±nda</option>
          <option value="0">Taslak</option>
        </select>

        <input type="search" id="searchInput" placeholder="YazÄ± ara..." class="search-input" />
      </div>

      <!-- Table -->
      <div class="posts-table-container">
        <table class="posts-table" id="postsTable">
          <thead>
            <tr>
              <th>BaÅŸlÄ±k</th>
              <th>Kategori</th>
              <th>Durum</th>
              <th>Ã–ne Ã‡Ä±kan</th>
              <th>Tarih</th>
              <th>Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" class="loading-row">
                <span class="spinner"></span> YÃ¼kleniyor...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" id="pagination"></div>
    </main>
  </div>

  <!-- Silme Onay Modal -->
  <div id="deleteModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h3>YazÄ±yÄ± Sil</h3>
      <p>Bu yazÄ±yÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelDelete">Ä°ptal</button>
        <button class="btn btn-danger" id="confirmDelete">Sil</button>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Category badge colors */
  .category-badge.\33 d-baski { background: rgba(59,130,246,0.1); color: #2563EB; }
  .category-badge.rehberler { background: rgba(6,182,212,0.1); color: #0891B2; }
  .category-badge.sorun-cozumleri { background: rgba(34,197,94,0.1); color: #16A34A; }
  .category-badge.incelemeler { background: rgba(168,85,247,0.1); color: #9333EA; }
  .category-badge.teknoloji { background: rgba(139,92,246,0.1); color: #7C3AED; }
  .category-badge.yapay-zeka { background: rgba(245,158,11,0.1); color: #D97706; }

  @media (prefers-color-scheme: dark) {
    .category-badge.\33 d-baski { background: rgba(59,130,246,0.15); color: #60A5FA; }
    .category-badge.rehberler { background: rgba(6,182,212,0.15); color: #22D3EE; }
    .category-badge.sorun-cozumleri { background: rgba(34,197,94,0.15); color: #4ADE80; }
    .category-badge.incelemeler { background: rgba(168,85,247,0.15); color: #C084FC; }
    .category-badge.teknoloji { background: rgba(139,92,246,0.15); color: #A78BFA; }
    .category-badge.yapay-zeka { background: rgba(245,158,11,0.15); color: #FBBF24; }
  }
</style>

<script>
  const API_BASE = 'https://tech-portal-api.turgut-d01.workers.dev';

  // Auth kontrolÃ¼
  const secret = localStorage.getItem('adminSecret');
  if (!secret) {
    window.location.href = '/admin';
  }

  // Logout
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  function toggleMobileMenu() {
    mobileMenuToggle?.classList.toggle('active');
    sidebar?.classList.toggle('open');
    sidebarOverlay?.classList.toggle('active');
  }

  mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
  sidebarOverlay?.addEventListener('click', toggleMobileMenu);

  let allPosts: any[] = [];
  let deletePostId: number | null = null;
  let currentPage = 1;
  let totalPages = 1;
  let currentSearch = '';
  let currentCategory = '';

  const categoryNames: Record<string, string> = {
    '3d-baski': '3D BaskÄ±',
    'rehberler': 'Rehber',
    'sorun-cozumleri': 'Sorun Ã‡Ã¶zÃ¼mÃ¼',
    'incelemeler': 'Ä°nceleme',
    'teknoloji': 'Teknoloji',
    'yapay-zeka': 'Yapay Zeka'
  };

  // Stats gÃ¼ncelle
  function updateStats(posts: any[], totalCount?: number) {
    const total = totalCount || posts.length;
    const published = posts.filter(p => p.published).length;
    const draft = posts.filter(p => !p.published).length;
    const featured = posts.filter(p => p.is_featured).length;

    const el = (id: string) => document.getElementById(id);
    el('statTotal')!.textContent = total.toString();
    el('statPublished')!.textContent = published.toString();
    el('statDraft')!.textContent = draft.toString();
    el('statFeatured')!.textContent = featured.toString();
  }

  // YazÄ±larÄ± yÃ¼kle
  async function loadPosts(page = 1) {
    currentPage = page;
    const tbody = document.querySelector('#postsTable tbody')!;
    tbody.innerHTML = '<tr><td colspan="6" class="loading-row"><span class="spinner"></span> YÃ¼kleniyor...</td></tr>';

    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: '50'
      });

      if (currentSearch) params.append('search', currentSearch);
      if (currentCategory) params.append('category', currentCategory);

      const res = await fetch(`${API_BASE}/admin/posts?${params}`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });

      if (!res.ok) throw new Error('Unauthorized');

      const data = await res.json();
      allPosts = data.posts || data;
      totalPages = data.pagination?.totalPages || 1;

      updateStats(allPosts, data.pagination?.total);
      renderPosts(allPosts);
      renderPagination();
    } catch (err) {
      console.error('Posts yÃ¼klenemedi:', err);
      tbody.innerHTML = '<tr><td colspan="6" class="error-row">YÃ¼klenirken hata oluÅŸtu</td></tr>';
    }
  }

  // YazÄ±larÄ± render et
  function renderPosts(posts: any[]) {
    const tbody = document.querySelector('#postsTable tbody')!;

    if (posts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty-row">YazÄ± bulunamadÄ±</td></tr>';
      return;
    }

    tbody.innerHTML = posts.map(post => `
      <tr data-id="${post.id}">
        <td class="title-cell">
          <a href="/admin/edit/${post.id}">${post.title_tr?.substring(0, 60)}${post.title_tr?.length > 60 ? '...' : ''}</a>
        </td>
        <td>
          <span class="category-badge ${post.category}">${categoryNames[post.category] || post.category}</span>
        </td>
        <td>
          <button class="status-toggle ${post.published ? 'published' : 'draft'}" data-id="${post.id}" data-published="${post.published}">
            ${post.published ? 'â— YayÄ±nda' : 'â—‹ Taslak'}
          </button>
        </td>
        <td>
          <button class="featured-toggle ${post.is_featured ? 'active' : ''}" data-id="${post.id}" data-featured="${post.is_featured}">
            ${post.is_featured ? 'â­' : 'â˜†'}
          </button>
        </td>
        <td class="date-cell">${new Date(post.created_at).toLocaleDateString('tr-TR')}</td>
        <td class="actions-cell">
          <a href="/admin/edit/${post.id}" class="btn btn-ghost btn-sm" title="DÃ¼zenle">âœï¸</a>
          <a href="/${post.category}/${post.slug}" target="_blank" class="btn btn-ghost btn-sm" title="GÃ¶rÃ¼ntÃ¼le">ğŸ‘ï¸</a>
          <button class="btn btn-ghost btn-sm delete-btn" data-id="${post.id}" title="Sil">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `).join('');

    // Event listeners
    attachEventListeners();
  }

  // Event listeners ekle
  function attachEventListeners() {
    // Durum deÄŸiÅŸtir
    document.querySelectorAll('.status-toggle').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLElement;
        const id = target.dataset.id;
        const currentStatus = target.dataset.published === '1';

        try {
          const res = await fetch(`${API_BASE}/admin/update/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-ADMIN-SECRET': secret!
            },
            body: JSON.stringify({ published: currentStatus ? 0 : 1 })
          });

          if (res.ok) {
            loadPosts(currentPage);
          }
        } catch (err) {
          console.error('GÃ¼ncelleme hatasÄ±:', err);
        }
      });
    });

    // Ã–ne Ã§Ä±kan deÄŸiÅŸtir
    document.querySelectorAll('.featured-toggle').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLElement;
        const id = target.dataset.id;
        const currentFeatured = target.dataset.featured === '1';

        try {
          const res = await fetch(`${API_BASE}/admin/update/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-ADMIN-SECRET': secret!
            },
            body: JSON.stringify({ is_featured: currentFeatured ? 0 : 1 })
          });

          if (res.ok) {
            loadPosts(currentPage);
          }
        } catch (err) {
          console.error('GÃ¼ncelleme hatasÄ±:', err);
        }
      });
    });

    // Silme
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        deletePostId = parseInt(target.dataset.id!);
        document.getElementById('deleteModal')?.classList.remove('hidden');
      });
    });
  }

  // Pagination render
  function renderPagination() {
    const paginationEl = document.getElementById('pagination')!;

    if (totalPages <= 1) {
      paginationEl.innerHTML = '';
      return;
    }

    let buttons = '';

    // Ã–nceki buton
    if (currentPage > 1) {
      buttons += `<button class="pagination-btn" data-page="${currentPage - 1}">â† Ã–nceki</button>`;
    }

    // Sayfa numaralarÄ±
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    if (startPage > 1) {
      buttons += `<button class="pagination-btn" data-page="1">1</button>`;
      if (startPage > 2) buttons += `<span class="pagination-dots">...</span>`;
    }

    for (let i = startPage; i <= endPage; i++) {
      buttons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) buttons += `<span class="pagination-dots">...</span>`;
      buttons += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
    }

    // Sonraki buton
    if (currentPage < totalPages) {
      buttons += `<button class="pagination-btn" data-page="${currentPage + 1}">Sonraki â†’</button>`;
    }

    paginationEl.innerHTML = buttons;

    // Event listeners
    paginationEl.querySelectorAll('.pagination-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const page = parseInt((e.target as HTMLElement).dataset.page!);
        loadPosts(page);
      });
    });
  }

  // Filtreleme - server-side
  let searchTimeout: number;

  function handleSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = window.setTimeout(() => {
      currentSearch = (document.getElementById('searchInput') as HTMLInputElement).value.trim();
      loadPosts(1);
    }, 300);
  }

  function handleCategoryChange() {
    currentCategory = (document.getElementById('categoryFilter') as HTMLSelectElement).value;
    loadPosts(1);
  }

  // Client-side status filtresi (API'de yok)
  function filterByStatus() {
    const status = (document.getElementById('statusFilter') as HTMLSelectElement).value;
    if (status === '') {
      renderPosts(allPosts);
    } else {
      renderPosts(allPosts.filter(p => p.published === parseInt(status)));
    }
  }

  document.getElementById('categoryFilter')?.addEventListener('change', handleCategoryChange);
  document.getElementById('statusFilter')?.addEventListener('change', filterByStatus);
  document.getElementById('searchInput')?.addEventListener('input', handleSearch);

  // Modal
  document.getElementById('cancelDelete')?.addEventListener('click', () => {
    document.getElementById('deleteModal')?.classList.add('hidden');
    deletePostId = null;
  });

  document.querySelector('.modal-backdrop')?.addEventListener('click', () => {
    document.getElementById('deleteModal')?.classList.add('hidden');
    deletePostId = null;
  });

  document.getElementById('confirmDelete')?.addEventListener('click', async () => {
    if (!deletePostId) return;

    try {
      const res = await fetch(`${API_BASE}/admin/delete/${deletePostId}`, {
        method: 'DELETE',
        headers: { 'X-ADMIN-SECRET': secret! }
      });

      if (res.ok) {
        document.getElementById('deleteModal')?.classList.add('hidden');
        deletePostId = null;
        loadPosts(currentPage);
      }
    } catch (err) {
      console.error('Silme hatasÄ±:', err);
    }
  });

  // YÃ¼kle
  loadPosts();
</script>
