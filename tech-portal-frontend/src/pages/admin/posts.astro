---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="YazÄ±lar â€“ Admin Panel" noIndex={true}>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">ğŸ“Š</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item active">
          <span class="icon">ğŸ“</span>
          YazÄ±lar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">ğŸ‘¥</span>
          Ãœyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">ğŸ“¡</span>
          RSS KaynaklarÄ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">ğŸ“¦</span>
          Ä°Ã§erik KutularÄ±
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">â•</span>
          Yeni YazÄ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>YazÄ±lar</h1>
          <p class="text-muted">TÃ¼m yazÄ±larÄ± yÃ¶netin</p>
        </div>
        <a href="/admin/new" class="btn btn-primary">+ Yeni YazÄ±</a>
      </header>

      <div class="filters">
        <select id="categoryFilter" class="filter-select">
          <option value="">TÃ¼m Kategoriler</option>
          <optgroup label="ğŸ“¦ 3D BaskÄ±">
            <option value="3d-baski">ğŸ”¶ 3D BaskÄ± Haberleri</option>
            <option value="rehberler">ğŸ“˜ Rehberler</option>
            <option value="sorun-cozumleri">ğŸ”§ Sorun Ã‡Ã¶zÃ¼mleri</option>
            <option value="incelemeler">â­ Ä°ncelemeler</option>
          </optgroup>
          <optgroup label="ğŸ“ DiÄŸer">
            <option value="teknoloji">ğŸ’» Teknoloji</option>
            <option value="yapay-zeka">ğŸ¤– Yapay Zeka</option>
          </optgroup>
        </select>

        <select id="statusFilter" class="filter-select">
          <option value="">TÃ¼m Durumlar</option>
          <option value="1">YayÄ±nda</option>
          <option value="0">Taslak</option>
        </select>

        <input type="search" id="searchInput" placeholder="YazÄ± ara..." class="search-input" />
      </div>

      <div class="posts-table-container">
        <table class="posts-table" id="postsTable">
          <thead>
            <tr>
              <th>BaÅŸlÄ±k</th>
              <th>Kategori</th>
              <th>Durum</th>
              <th>Ã–ne Ã‡Ä±kan</th>
              <th>Tarih</th>
              <th>Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" class="loading-row">
                <span class="spinner"></span> YÃ¼kleniyor...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" id="pagination"></div>
    </main>
  </div>

  <!-- Silme Onay Modal -->
  <div id="deleteModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h3>YazÄ±yÄ± Sil</h3>
      <p>Bu yazÄ±yÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelDelete">Ä°ptal</button>
        <button class="btn btn-danger" id="confirmDelete">Sil</button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const API_BASE = 'https://tech-portal-api.turgut-d01.workers.dev';

  // Auth kontrolÃ¼
  const secret = localStorage.getItem('adminSecret');
  if (!secret) {
    window.location.href = '/admin';
  }

  // Logout
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  let allPosts: any[] = [];
  let deletePostId: number | null = null;

  const categoryNames: Record<string, string> = {
    '3d-baski': '3D BaskÄ±',
    'rehberler': 'Rehber',
    'sorun-cozumleri': 'Sorun Ã‡Ã¶zÃ¼mÃ¼',
    'incelemeler': 'Ä°nceleme',
    'teknoloji': 'Teknoloji',
    'yapay-zeka': 'Yapay Zeka'
  };

  // YazÄ±larÄ± yÃ¼kle
  async function loadPosts() {
    try {
      const res = await fetch(`${API_BASE}/admin/posts`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });

      if (!res.ok) throw new Error('Unauthorized');

      allPosts = await res.json();
      renderPosts(allPosts);
    } catch (err) {
      console.error('Posts yÃ¼klenemedi:', err);
      const tbody = document.querySelector('#postsTable tbody')!;
      tbody.innerHTML = '<tr><td colspan="6" class="error-row">YÃ¼klenirken hata oluÅŸtu</td></tr>';
    }
  }

  // YazÄ±larÄ± render et
  function renderPosts(posts: any[]) {
    const tbody = document.querySelector('#postsTable tbody')!;

    if (posts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty-row">YazÄ± bulunamadÄ±</td></tr>';
      return;
    }

    tbody.innerHTML = posts.map(post => `
      <tr data-id="${post.id}">
        <td class="title-cell">
          <a href="/admin/edit/${post.id}">${post.title_tr?.substring(0, 60)}${post.title_tr?.length > 60 ? '...' : ''}</a>
        </td>
        <td>
          <span class="category-badge ${post.category}">${categoryNames[post.category] || post.category}</span>
        </td>
        <td>
          <button class="status-toggle ${post.published ? 'published' : 'draft'}" data-id="${post.id}" data-published="${post.published}">
            ${post.published ? 'YayÄ±nda' : 'Taslak'}
          </button>
        </td>
        <td>
          <button class="featured-toggle ${post.is_featured ? 'active' : ''}" data-id="${post.id}" data-featured="${post.is_featured}">
            ${post.is_featured ? 'â­' : 'â˜†'}
          </button>
        </td>
        <td class="date-cell">${new Date(post.created_at).toLocaleDateString('tr-TR')}</td>
        <td class="actions-cell">
          <a href="/admin/edit/${post.id}" class="btn btn-ghost btn-sm">âœï¸</a>
          <a href="/${post.category}/${post.slug}" target="_blank" class="btn btn-ghost btn-sm">ğŸ‘ï¸</a>
          <button class="btn btn-ghost btn-sm delete-btn" data-id="${post.id}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `).join('');

    // Event listeners
    attachEventListeners();
  }

  // Event listeners ekle
  function attachEventListeners() {
    // Durum deÄŸiÅŸtir
    document.querySelectorAll('.status-toggle').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const id = target.dataset.id;
        const currentStatus = target.dataset.published === '1';

        try {
          const res = await fetch(`${API_BASE}/admin/update/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-ADMIN-SECRET': secret!
            },
            body: JSON.stringify({ published: currentStatus ? 0 : 1 })
          });

          if (res.ok) {
            loadPosts();
          }
        } catch (err) {
          console.error('GÃ¼ncelleme hatasÄ±:', err);
        }
      });
    });

    // Ã–ne Ã§Ä±kan deÄŸiÅŸtir
    document.querySelectorAll('.featured-toggle').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const id = target.dataset.id;
        const currentFeatured = target.dataset.featured === '1';

        try {
          const res = await fetch(`${API_BASE}/admin/update/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-ADMIN-SECRET': secret!
            },
            body: JSON.stringify({ is_featured: currentFeatured ? 0 : 1 })
          });

          if (res.ok) {
            loadPosts();
          }
        } catch (err) {
          console.error('GÃ¼ncelleme hatasÄ±:', err);
        }
      });
    });

    // Silme
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        deletePostId = parseInt(target.dataset.id!);
        document.getElementById('deleteModal')?.classList.remove('hidden');
      });
    });
  }

  // Filtreleme
  function filterPosts() {
    const category = (document.getElementById('categoryFilter') as HTMLSelectElement).value;
    const status = (document.getElementById('statusFilter') as HTMLSelectElement).value;
    const search = (document.getElementById('searchInput') as HTMLInputElement).value.toLowerCase();

    let filtered = allPosts;

    if (category) {
      filtered = filtered.filter(p => p.category === category);
    }

    if (status !== '') {
      filtered = filtered.filter(p => p.published === parseInt(status));
    }

    if (search) {
      filtered = filtered.filter(p =>
        p.title_tr?.toLowerCase().includes(search) ||
        p.summary_tr?.toLowerCase().includes(search)
      );
    }

    renderPosts(filtered);
  }

  document.getElementById('categoryFilter')?.addEventListener('change', filterPosts);
  document.getElementById('statusFilter')?.addEventListener('change', filterPosts);
  document.getElementById('searchInput')?.addEventListener('input', filterPosts);

  // Modal
  document.getElementById('cancelDelete')?.addEventListener('click', () => {
    document.getElementById('deleteModal')?.classList.add('hidden');
    deletePostId = null;
  });

  document.querySelector('.modal-backdrop')?.addEventListener('click', () => {
    document.getElementById('deleteModal')?.classList.add('hidden');
    deletePostId = null;
  });

  document.getElementById('confirmDelete')?.addEventListener('click', async () => {
    if (!deletePostId) return;

    try {
      const res = await fetch(`${API_BASE}/admin/delete/${deletePostId}`, {
        method: 'DELETE',
        headers: { 'X-ADMIN-SECRET': secret! }
      });

      if (res.ok) {
        document.getElementById('deleteModal')?.classList.add('hidden');
        deletePostId = null;
        loadPosts();
      }
    } catch (err) {
      console.error('Silme hatasÄ±:', err);
    }
  });

  // YÃ¼kle
  loadPosts();
</script>
