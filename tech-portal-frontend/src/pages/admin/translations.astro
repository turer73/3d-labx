---
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout title="Ã‡eviri YÃ¶netimi â€“ Admin Panel" noIndex={true}>
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX <span class="admin-badge">ADMÄ°N</span></a>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/dashboard"><span class="nav-icon">ğŸ“Š</span> Dashboard</a>
        <a href="/admin/posts"><span class="nav-icon">ğŸ“</span> YazÄ±lar</a>
        <a href="/admin/users"><span class="nav-icon">ğŸ‘¥</span> Ãœyeler</a>
        <a href="/admin/rss"><span class="nav-icon">ğŸ“¡</span> RSS KaynaklarÄ±</a>
        <a href="/admin/content-boxes"><span class="nav-icon">ğŸ“¦</span> Ä°Ã§erik KutularÄ±</a>
        <a href="/admin/logs"><span class="nav-icon">ğŸ“‹</span> Site LoglarÄ±</a>
        <a href="/admin/translations" class="active"><span class="nav-icon">ğŸŒ</span> Ã‡eviriler</a>
        <a href="/admin/new"><span class="nav-icon">â•</span> Yeni YazÄ±</a>
      </nav>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-btn">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
      </div>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <h1>ğŸŒ Ã‡eviri YÃ¶netimi</h1>
        <p>AI ile otomatik iÃ§erik Ã§evirisi</p>
      </header>

      <div class="content-grid">
        <!-- Ã‡eviri Durumu -->
        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-icon" style="background: #10B981;">ğŸ‡¬ğŸ‡§</div>
            <div class="stat-info">
              <h3 id="enTranslated">-</h3>
              <p>Ä°ngilizce Ã‡eviri</p>
              <div class="progress-bar">
                <div class="progress-fill" id="enProgress" style="width: 0%;"></div>
              </div>
              <span class="stat-detail" id="enPending">- bekliyor</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon" style="background: #F59E0B;">ğŸ‡©ğŸ‡ª</div>
            <div class="stat-info">
              <h3 id="deTranslated">-</h3>
              <p>Almanca Ã‡eviri</p>
              <div class="progress-bar">
                <div class="progress-fill" id="deProgress" style="width: 0%;"></div>
              </div>
              <span class="stat-detail" id="dePending">- bekliyor</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon" style="background: #6366F1;">ğŸ“Š</div>
            <div class="stat-info">
              <h3 id="totalPosts">-</h3>
              <p>Toplam Ä°Ã§erik</p>
            </div>
          </div>
        </div>

        <!-- Toplu Ã‡eviri -->
        <div class="translate-section">
          <h2>ğŸš€ Toplu Ã‡eviri</h2>
          <p>Ã‡evrilmemiÅŸ iÃ§erikleri AI ile toplu olarak Ã§evirin</p>

          <div class="translate-controls">
            <div class="control-group">
              <label>Hedef Dil</label>
              <select id="targetLang">
                <option value="en">ğŸ‡¬ğŸ‡§ Ä°ngilizce</option>
                <option value="de">ğŸ‡©ğŸ‡ª Almanca</option>
              </select>
            </div>

            <div class="control-group">
              <label>Adet (max 50)</label>
              <input type="number" id="batchLimit" value="10" min="1" max="50" />
            </div>

            <button id="startBatchBtn" class="btn-primary">
              <span class="btn-text">ğŸ¤– Ã‡eviriyi BaÅŸlat</span>
              <span class="btn-loading" style="display: none;">â³ Ã‡eviriliyor...</span>
            </button>
          </div>

          <div id="batchResult" class="batch-result" style="display: none;"></div>
        </div>

        <!-- Ã‡eviri GeÃ§miÅŸi -->
        <div class="history-section">
          <h2>ğŸ“‹ Son Ã‡eviriler</h2>
          <div id="translationHistory" class="history-list">
            <p class="empty-state">HenÃ¼z Ã§eviri yapÄ±lmadÄ±</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</BaseLayout>

<script is:inline>
  const API = 'https://tech-portal-api.turgut-d01.workers.dev';

  // Auth check
  const token = localStorage.getItem('authToken');
  const user = JSON.parse(localStorage.getItem('authUser') || '{}');
  if (!token || user.role !== 'admin') {
    window.location.href = '/auth/giris?redirect=/admin/translations';
  }

  // Load translation status
  async function loadStatus() {
    try {
      const res = await fetch(`${API}/admin/translation-status`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();

      document.getElementById('totalPosts').textContent = data.total;
      document.getElementById('enTranslated').textContent = `${data.english.translated}/${data.total}`;
      document.getElementById('enPending').textContent = `${data.english.pending} bekliyor`;
      document.getElementById('enProgress').style.width = `${data.english.percentage}%`;

      document.getElementById('deTranslated').textContent = `${data.german.translated}/${data.total}`;
      document.getElementById('dePending').textContent = `${data.german.pending} bekliyor`;
      document.getElementById('deProgress').style.width = `${data.german.percentage}%`;
    } catch (err) {
      console.error('Status load error:', err);
    }
  }

  // Batch translate
  document.getElementById('startBatchBtn').addEventListener('click', async function() {
    const btn = this;
    const btnText = btn.querySelector('.btn-text');
    const btnLoading = btn.querySelector('.btn-loading');
    const resultDiv = document.getElementById('batchResult');

    const lang = document.getElementById('targetLang').value;
    const limit = parseInt(document.getElementById('batchLimit').value) || 10;

    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    btn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const res = await fetch(`${API}/admin/translate-batch`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ lang, limit })
      });

      const data = await res.json();

      resultDiv.style.display = 'block';
      if (data.success) {
        resultDiv.className = 'batch-result success';
        resultDiv.innerHTML = `
          <strong>âœ… Ã‡eviri TamamlandÄ±!</strong><br>
          ${data.translated}/${data.total} iÃ§erik ${lang === 'en' ? 'Ä°ngilizce' : 'Almanca'}\'ya Ã§evrildi.
          ${data.errors ? `<br><small>âš ï¸ ${data.errors.length} hata oluÅŸtu</small>` : ''}
        `;
        loadStatus(); // Refresh stats
        addToHistory(lang, data.translated, data.total);
      } else {
        resultDiv.className = 'batch-result error';
        resultDiv.innerHTML = `<strong>âŒ Hata:</strong> ${data.error || 'Bilinmeyen hata'}`;
      }
    } catch (err) {
      resultDiv.style.display = 'block';
      resultDiv.className = 'batch-result error';
      resultDiv.innerHTML = `<strong>âŒ BaÄŸlantÄ± hatasÄ±:</strong> ${err.message}`;
    } finally {
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      btn.disabled = false;
    }
  });

  // History
  function addToHistory(lang, translated, total) {
    const historyDiv = document.getElementById('translationHistory');
    const emptyState = historyDiv.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerHTML = `
      <span class="history-lang">${lang === 'en' ? 'ğŸ‡¬ğŸ‡§' : 'ğŸ‡©ğŸ‡ª'}</span>
      <span class="history-text">${translated}/${total} iÃ§erik Ã§evrildi</span>
      <span class="history-time">${new Date().toLocaleTimeString('tr-TR')}</span>
    `;
    historyDiv.insertBefore(item, historyDiv.firstChild);
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('authToken');
    localStorage.removeItem('authUser');
    window.location.href = '/';
  });

  // Init
  loadStatus();
</script>

<style>
  .admin-layout {
    display: flex;
    min-height: 100vh;
    background: var(--bg-main);
  }

  .admin-sidebar {
    width: 240px;
    background: var(--bg-card);
    border-right: 1px solid var(--border-soft);
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    z-index: 100;
  }

  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-soft);
  }

  .logo {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-main);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .admin-badge {
    font-size: 0.65rem;
    padding: 3px 6px;
    background: linear-gradient(135deg, #8B5CF6, #6366F1);
    color: white;
    border-radius: 4px;
    font-weight: 600;
  }

  .sidebar-nav {
    flex: 1;
    padding: 16px 0;
    overflow-y: auto;
  }

  .sidebar-nav a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    color: var(--text-muted);
    text-decoration: none;
    transition: all 0.2s;
    font-size: 0.9rem;
  }

  .sidebar-nav a:hover {
    background: var(--bg-soft);
    color: var(--text-main);
  }

  .sidebar-nav a.active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    color: #8B5CF6;
    border-left: 3px solid #8B5CF6;
  }

  .nav-icon {
    font-size: 1.1rem;
  }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-soft);
  }

  .logout-btn {
    width: 100%;
    padding: 10px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #EF4444;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .logout-btn:hover {
    background: rgba(239, 68, 68, 0.2);
  }

  .admin-main {
    flex: 1;
    margin-left: 240px;
    padding: 32px;
  }

  .admin-header {
    margin-bottom: 32px;
  }

  .admin-header h1 {
    font-size: 1.75rem;
    margin-bottom: 8px;
  }

  .admin-header p {
    color: var(--text-muted);
  }

  .content-grid {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .stat-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 24px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .stat-info h3 {
    font-size: 1.5rem;
    margin-bottom: 4px;
  }

  .stat-info p {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-soft);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 4px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10B981, #34D399);
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .stat-detail {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .translate-section,
  .history-section {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 24px;
  }

  .translate-section h2,
  .history-section h2 {
    font-size: 1.25rem;
    margin-bottom: 8px;
  }

  .translate-section > p {
    color: var(--text-muted);
    margin-bottom: 24px;
  }

  .translate-controls {
    display: flex;
    gap: 16px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .control-group label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .control-group select,
  .control-group input {
    padding: 10px 14px;
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    background: var(--bg-main);
    color: var(--text-main);
    font-size: 0.9rem;
    min-width: 150px;
  }

  .btn-primary {
    padding: 10px 24px;
    background: linear-gradient(135deg, #6366F1, #8B5CF6);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .batch-result {
    margin-top: 20px;
    padding: 16px;
    border-radius: 10px;
    font-size: 0.9rem;
  }

  .batch-result.success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #10B981;
  }

  .batch-result.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #EF4444;
  }

  .history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }

  .history-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-soft);
    border-radius: 10px;
  }

  .history-lang {
    font-size: 1.5rem;
  }

  .history-text {
    flex: 1;
    font-size: 0.9rem;
  }

  .history-time {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .empty-state {
    color: var(--text-muted);
    text-align: center;
    padding: 20px;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .admin-sidebar {
      width: 100%;
      height: auto;
      position: relative;
    }

    .admin-main {
      margin-left: 0;
      padding: 16px;
    }

    .translate-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .control-group select,
    .control-group input {
      min-width: auto;
    }
  }
</style>
