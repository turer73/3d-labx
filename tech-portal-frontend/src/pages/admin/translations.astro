---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";

export const prerender = false;
---

<BaseLayout title="Ã‡eviri YÃ¶netimi â€“ Admin Panel" noIndex={true}>
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <span></span>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="admin-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="logo">3D-labX</a>
        <span class="badge badge-primary">Admin</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <span class="icon">ğŸ“Š</span>
          Dashboard
        </a>
        <a href="/admin/posts" class="nav-item">
          <span class="icon">ğŸ“</span>
          YazÄ±lar
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="icon">ğŸ‘¥</span>
          Ãœyeler
        </a>
        <a href="/admin/rss" class="nav-item">
          <span class="icon">ğŸ“¡</span>
          RSS KaynaklarÄ±
        </a>
        <a href="/admin/content-boxes" class="nav-item">
          <span class="icon">ğŸ“¦</span>
          Ä°Ã§erik KutularÄ±
        </a>
        <a href="/admin/logs" class="nav-item">
          <span class="icon">ğŸ“‹</span>
          Site LoglarÄ±
        </a>
        <a href="/admin/translations" class="nav-item active">
          <span class="icon">ğŸŒ</span>
          Ã‡eviriler
        </a>
        <a href="/admin/new" class="nav-item">
          <span class="icon">â•</span>
          Yeni YazÄ±
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-ghost btn-full">
          ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="content-header">
        <div>
          <h1>Ã‡eviri YÃ¶netimi</h1>
          <p class="text-muted">AI ile otomatik iÃ§erik Ã§evirisi</p>
        </div>
      </header>

      <!-- Ã‡eviri Durumu -->
      <div class="stats-grid">
        <div class="stat-card stat-card-en">
          <div class="stat-icon">ğŸ‡¬ğŸ‡§</div>
          <div class="stat-info">
            <span class="stat-value" id="enTranslated">-</span>
            <span class="stat-label">Ä°ngilizce Ã‡eviri</span>
            <div class="progress-bar">
              <div class="progress-fill progress-fill-en" id="enProgress" style="width: 0%;"></div>
            </div>
            <span class="stat-detail" id="enPending">- bekliyor</span>
          </div>
        </div>

        <div class="stat-card stat-card-de">
          <div class="stat-icon">ğŸ‡©ğŸ‡ª</div>
          <div class="stat-info">
            <span class="stat-value" id="deTranslated">-</span>
            <span class="stat-label">Almanca Ã‡eviri</span>
            <div class="progress-bar">
              <div class="progress-fill progress-fill-de" id="deProgress" style="width: 0%;"></div>
            </div>
            <span class="stat-detail" id="dePending">- bekliyor</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-info">
            <span class="stat-value" id="totalPosts">-</span>
            <span class="stat-label">Toplam Ä°Ã§erik</span>
          </div>
        </div>
      </div>

      <!-- Toplu Ä°Ã§erik Ã‡evirisi -->
      <div class="translate-card">
        <div class="translate-card-header">
          <h2>ğŸš€ Toplu Ä°Ã§erik Ã‡evirisi</h2>
          <p>Ã‡evrilmemiÅŸ iÃ§erikleri AI ile toplu olarak Ã§evirin</p>
        </div>

        <div class="translate-controls">
          <div class="control-group">
            <label>Hedef Dil</label>
            <select id="targetLang" class="filter-select">
              <option value="en">ğŸ‡¬ğŸ‡§ Ä°ngilizce</option>
              <option value="de">ğŸ‡©ğŸ‡ª Almanca</option>
            </select>
          </div>

          <div class="control-group">
            <label>Adet (max 50)</label>
            <input type="number" id="batchLimit" class="search-input" value="10" min="1" max="50" style="width: 100px;" />
          </div>

          <button id="startBatchBtn" class="btn btn-primary">
            <span class="btn-text">ğŸ¤– Ã‡eviriyi BaÅŸlat</span>
            <span class="btn-loading" style="display: none;">â³ Ã‡eviriliyor...</span>
          </button>
        </div>

        <div id="batchResult" class="batch-result" style="display: none;"></div>
      </div>

      <!-- Slug Ã‡evirisi (SEO iÃ§in) -->
      <div class="translate-card">
        <div class="translate-card-header">
          <h2>ğŸ”— URL Slug Ã‡evirisi (SEO)</h2>
          <p>Ã‡evrilmiÅŸ iÃ§eriklerin URL'lerini dile gÃ¶re oluÅŸturun. Bu SEO iÃ§in kritiktir!</p>
        </div>

        <div class="slug-stats">
          <div class="slug-stat">
            <span class="flag">ğŸ‡¬ğŸ‡§</span>
            <span id="enSlugCount">-</span> slug oluÅŸturuldu
            <span class="pending" id="enSlugPending">(-)</span>
          </div>
          <div class="slug-stat">
            <span class="flag">ğŸ‡©ğŸ‡ª</span>
            <span id="deSlugCount">-</span> slug oluÅŸturuldu
            <span class="pending" id="deSlugPending">(-)</span>
          </div>
        </div>

        <div class="translate-controls">
          <div class="control-group">
            <label>Hedef Dil</label>
            <select id="slugTargetLang" class="filter-select">
              <option value="en">ğŸ‡¬ğŸ‡§ Ä°ngilizce</option>
              <option value="de">ğŸ‡©ğŸ‡ª Almanca</option>
            </select>
          </div>

          <div class="control-group">
            <label>Adet (max 100)</label>
            <input type="number" id="slugBatchLimit" class="search-input" value="50" min="1" max="100" style="width: 100px;" />
          </div>

          <button id="startSlugBtn" class="btn btn-success">
            <span class="btn-text">ğŸ”— Slug OluÅŸtur</span>
            <span class="btn-loading" style="display: none;">â³ OluÅŸturuluyor...</span>
          </button>
        </div>

        <div id="slugResult" class="batch-result" style="display: none;"></div>
      </div>

      <!-- Ã‡eviri GeÃ§miÅŸi -->
      <div class="translate-card">
        <div class="translate-card-header">
          <h2>ğŸ“‹ Son Ã‡eviriler</h2>
        </div>
        <div id="translationHistory" class="history-list">
          <p class="empty-state">HenÃ¼z Ã§eviri yapÄ±lmadÄ±</p>
        </div>
      </div>
    </main>
  </div>
</BaseLayout>

<style>
  /* Progress bars */
  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(99, 102, 241, 0.08);
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0 4px;
  }

  .progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
  }

  .progress-fill-en {
    background: linear-gradient(90deg, #10B981, #34D399);
  }

  .progress-fill-de {
    background: linear-gradient(90deg, #F59E0B, #FBBF24);
  }

  .stat-detail {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  /* Stat card variants */
  .stat-card-en {
    border-top: 3px solid #10B981;
  }

  .stat-card-de {
    border-top: 3px solid #F59E0B;
  }

  /* Translate cards */
  .translate-card {
    background: white;
    border: 1px solid rgba(99, 102, 241, 0.08);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  }

  .translate-card-header {
    margin-bottom: 20px;
  }

  .translate-card-header h2 {
    font-size: 1.2rem;
    font-weight: 700;
    color: #1E293B;
    margin-bottom: 6px;
  }

  .translate-card-header p {
    color: #64748B;
    font-size: 0.9rem;
  }

  .translate-controls {
    display: flex;
    gap: 16px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .control-group label {
    font-size: 0.85rem;
    color: #64748B;
    font-weight: 500;
  }

  /* Success button variant */
  .btn-success {
    padding: 10px 24px;
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }

  .btn-success:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
  }

  .btn-success:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Batch result */
  .batch-result {
    margin-top: 20px;
    padding: 16px 20px;
    border-radius: 12px;
    font-size: 0.9rem;
  }

  .batch-result.success {
    background: rgba(16, 185, 129, 0.08);
    border: 1px solid rgba(16, 185, 129, 0.25);
    color: #059669;
  }

  .batch-result.error {
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.25);
    color: #DC2626;
  }

  /* Slug stats */
  .slug-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .slug-stat {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: rgba(99, 102, 241, 0.04);
    border: 1px solid rgba(99, 102, 241, 0.08);
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 500;
    color: #475569;
  }

  .slug-stat .flag {
    font-size: 1.2rem;
  }

  .slug-stat .pending {
    color: #94A3B8;
    font-size: 0.8rem;
  }

  /* History */
  .history-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .history-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(99, 102, 241, 0.04);
    border: 1px solid rgba(99, 102, 241, 0.08);
    border-radius: 12px;
    transition: all 0.2s;
  }

  .history-item:hover {
    background: rgba(99, 102, 241, 0.08);
  }

  .history-lang {
    font-size: 1.5rem;
  }

  .history-text {
    flex: 1;
    font-size: 0.9rem;
    color: #475569;
  }

  .history-time {
    font-size: 0.8rem;
    color: #94A3B8;
  }

  .empty-state {
    color: #94A3B8;
    text-align: center;
    padding: 24px;
    font-size: 0.9rem;
  }

  /* Dark Mode */
  @media (prefers-color-scheme: dark) {
    .translate-card {
      background: var(--bg-card);
      border-color: rgba(99, 102, 241, 0.12);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .translate-card-header h2 {
      color: #F1F5F9;
    }

    .translate-card-header p {
      color: #94A3B8;
    }

    .control-group label {
      color: #94A3B8;
    }

    .progress-bar {
      background: rgba(99, 102, 241, 0.15);
    }

    .batch-result.success {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.3);
      color: #6EE7B7;
    }

    .batch-result.error {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: #FCA5A5;
    }

    .slug-stat {
      background: rgba(99, 102, 241, 0.08);
      border-color: rgba(99, 102, 241, 0.15);
      color: #CBD5E1;
    }

    .slug-stat .pending {
      color: #64748B;
    }

    .history-item {
      background: rgba(99, 102, 241, 0.06);
      border-color: rgba(99, 102, 241, 0.12);
    }

    .history-item:hover {
      background: rgba(99, 102, 241, 0.12);
    }

    .history-text {
      color: #CBD5E1;
    }

    .history-time {
      color: #64748B;
    }

    .empty-state {
      color: #64748B;
    }
  }

  @media (max-width: 768px) {
    .translate-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .slug-stats {
      flex-direction: column;
    }
  }
</style>

<script>
  const API = 'https://tech-portal-api.turgut-d01.workers.dev';

  // Auth check - use adminSecret pattern (consistent with other admin pages)
  const secret = localStorage.getItem('adminSecret');
  if (!secret) {
    window.location.href = '/admin';
  }

  // Logout
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSecret');
    window.location.href = '/admin';
  });

  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  function toggleMobileMenu() {
    mobileMenuToggle?.classList.toggle('active');
    sidebar?.classList.toggle('open');
    sidebarOverlay?.classList.toggle('active');
  }

  mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
  sidebarOverlay?.addEventListener('click', toggleMobileMenu);

  // Load translation status
  async function loadStatus() {
    try {
      const res = await fetch(`${API}/admin/translation-status`, {
        headers: { 'X-ADMIN-SECRET': secret! }
      });
      const data = await res.json();

      document.getElementById('totalPosts')!.textContent = data.total;
      document.getElementById('enTranslated')!.textContent = `${data.english.translated}/${data.total}`;
      document.getElementById('enPending')!.textContent = `${data.english.pending} bekliyor`;
      (document.getElementById('enProgress') as HTMLElement).style.width = `${data.english.percentage}%`;

      document.getElementById('deTranslated')!.textContent = `${data.german.translated}/${data.total}`;
      document.getElementById('dePending')!.textContent = `${data.german.pending} bekliyor`;
      (document.getElementById('deProgress') as HTMLElement).style.width = `${data.german.percentage}%`;

      // Slug stats
      document.getElementById('enSlugCount')!.textContent = data.english.slugs || '0';
      document.getElementById('enSlugPending')!.textContent = `(${(data.english.translated || 0) - (data.english.slugs || 0)} bekliyor)`;
      document.getElementById('deSlugCount')!.textContent = data.german.slugs || '0';
      document.getElementById('deSlugPending')!.textContent = `(${(data.german.translated || 0) - (data.german.slugs || 0)} bekliyor)`;
    } catch (err) {
      console.error('Status load error:', err);
    }
  }

  // Batch translate
  document.getElementById('startBatchBtn')?.addEventListener('click', async function() {
    const btn = this as HTMLButtonElement;
    const btnText = btn.querySelector('.btn-text') as HTMLElement;
    const btnLoading = btn.querySelector('.btn-loading') as HTMLElement;
    const resultDiv = document.getElementById('batchResult')!;

    const lang = (document.getElementById('targetLang') as HTMLSelectElement).value;
    const limit = parseInt((document.getElementById('batchLimit') as HTMLInputElement).value) || 10;

    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    btn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const res = await fetch(`${API}/admin/translate-batch`, {
        method: 'POST',
        headers: {
          'X-ADMIN-SECRET': secret!,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ lang, limit })
      });

      const data = await res.json();

      resultDiv.style.display = 'block';
      if (data.success) {
        resultDiv.className = 'batch-result success';
        resultDiv.innerHTML = `
          <strong>âœ… Ã‡eviri TamamlandÄ±!</strong><br>
          ${data.translated}/${data.total} iÃ§erik ${lang === 'en' ? 'Ä°ngilizce' : 'Almanca'}'ya Ã§evrildi.
          ${data.errors ? `<br><small>âš ï¸ ${data.errors.length} hata oluÅŸtu</small>` : ''}
        `;
        loadStatus();
        addToHistory(lang, data.translated, data.total);
      } else {
        resultDiv.className = 'batch-result error';
        resultDiv.innerHTML = `<strong>âŒ Hata:</strong> ${data.error || 'Bilinmeyen hata'}`;
      }
    } catch (err: any) {
      resultDiv.style.display = 'block';
      resultDiv.className = 'batch-result error';
      resultDiv.innerHTML = `<strong>âŒ BaÄŸlantÄ± hatasÄ±:</strong> ${err.message}`;
    } finally {
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      btn.disabled = false;
    }
  });

  // History
  function addToHistory(lang: string, translated: number, total: number, type = 'content') {
    const historyDiv = document.getElementById('translationHistory')!;
    const emptyState = historyDiv.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    const item = document.createElement('div');
    item.className = 'history-item';
    const actionText = type === 'slug' ? 'slug oluÅŸturuldu' : 'iÃ§erik Ã§evrildi';
    const icon = type === 'slug' ? 'ğŸ”—' : 'ğŸ“';
    item.innerHTML = `
      <span class="history-lang">${lang === 'en' ? 'ğŸ‡¬ğŸ‡§' : 'ğŸ‡©ğŸ‡ª'}</span>
      <span class="history-text">${icon} ${translated}/${total} ${actionText}</span>
      <span class="history-time">${new Date().toLocaleTimeString('tr-TR')}</span>
    `;
    historyDiv.insertBefore(item, historyDiv.firstChild);
  }

  // Slug generation
  document.getElementById('startSlugBtn')?.addEventListener('click', async function() {
    const btn = this as HTMLButtonElement;
    const btnText = btn.querySelector('.btn-text') as HTMLElement;
    const btnLoading = btn.querySelector('.btn-loading') as HTMLElement;
    const resultDiv = document.getElementById('slugResult')!;

    const lang = (document.getElementById('slugTargetLang') as HTMLSelectElement).value;
    const limit = parseInt((document.getElementById('slugBatchLimit') as HTMLInputElement).value) || 50;

    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    btn.disabled = true;
    resultDiv.style.display = 'none';

    try {
      const res = await fetch(`${API}/admin/translate-slugs`, {
        method: 'POST',
        headers: {
          'X-ADMIN-SECRET': secret!,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ lang, limit })
      });

      const data = await res.json();

      resultDiv.style.display = 'block';
      if (data.success) {
        resultDiv.className = 'batch-result success';
        resultDiv.innerHTML = `
          <strong>âœ… Slug OluÅŸturma TamamlandÄ±!</strong><br>
          ${data.translated}/${data.total} ${lang === 'en' ? 'Ä°ngilizce' : 'Almanca'} slug oluÅŸturuldu.
          ${data.errors ? `<br><small>âš ï¸ ${data.errors.length} hata oluÅŸtu</small>` : ''}
        `;
        loadStatus();
        addToHistory(lang, data.translated, data.total, 'slug');
      } else {
        resultDiv.className = 'batch-result error';
        resultDiv.innerHTML = `<strong>âŒ Hata:</strong> ${data.error || 'Bilinmeyen hata'}`;
      }
    } catch (err: any) {
      resultDiv.style.display = 'block';
      resultDiv.className = 'batch-result error';
      resultDiv.innerHTML = `<strong>âŒ BaÄŸlantÄ± hatasÄ±:</strong> ${err.message}`;
    } finally {
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      btn.disabled = false;
    }
  });

  // Init
  loadStatus();
</script>
