---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
---

<BaseLayout title="Ayarlar ‚Äì 3D-labX">
  <Header />

  <main class="settings-page">
    <div class="container">
      <div class="settings-layout">
        <!-- Sidebar -->
        <aside class="settings-sidebar">
          <h2>Ayarlar</h2>
          <nav class="settings-nav">
            <a href="#profile" class="nav-item active" data-section="profile">
              <span class="icon">üë§</span>
              Profil Bilgileri
            </a>
            <a href="#account" class="nav-item" data-section="account">
              <span class="icon">üîê</span>
              Hesap G√ºvenliƒüi
            </a>
            <a href="#notifications" class="nav-item" data-section="notifications">
              <span class="icon">üîî</span>
              Bildirimler
            </a>
            <a href="#appearance" class="nav-item" data-section="appearance">
              <span class="icon">üé®</span>
              G√∂r√ºn√ºm
            </a>
            <a href="#privacy" class="nav-item" data-section="privacy">
              <span class="icon">üõ°Ô∏è</span>
              Gizlilik
            </a>
          </nav>
          <div class="sidebar-footer">
            <a href="/profil" class="btn btn-ghost btn-full">‚Üê Profile D√∂n</a>
          </div>
        </aside>

        <!-- Content -->
        <div class="settings-content">
          <!-- Y√ºkleniyor -->
          <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
          </div>

          <!-- Profil Bilgileri -->
          <section id="section-profile" class="settings-section">
            <div class="section-header">
              <h3>Profil Bilgileri</h3>
              <p>Herkese a√ßƒ±k profil bilgilerinizi y√∂netin</p>
            </div>

            <form id="profileForm" class="settings-form">
              <div class="form-group">
                <label>Profil Fotoƒürafƒ±</label>
                <div class="avatar-upload">
                  <div class="avatar-preview" id="avatarPreview">
                    <span id="avatarInitials">U</span>
                  </div>
                  <div class="avatar-actions">
                    <label class="btn btn-secondary btn-sm">
                      Fotoƒüraf Y√ºkle
                      <input type="file" id="avatarInput" accept="image/*" hidden />
                    </label>
                    <button type="button" id="removeAvatar" class="btn btn-ghost btn-sm">Kaldƒ±r</button>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="displayName">G√∂r√ºnen Ad</label>
                  <input type="text" id="displayName" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z" />
                </div>
                <div class="form-group">
                  <label for="username">Kullanƒ±cƒ± Adƒ±</label>
                  <input type="text" id="username" readonly class="readonly" />
                  <small>Kullanƒ±cƒ± adƒ± deƒüi≈ütirilemez</small>
                </div>
              </div>

              <div class="form-group">
                <label for="bio">Biyografi</label>
                <textarea id="bio" rows="3" placeholder="Kendinizi kƒ±saca tanƒ±tƒ±n..." maxlength="500"></textarea>
                <small><span id="bioCount">0</span>/500 karakter</small>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="location">Konum</label>
                  <input type="text" id="location" placeholder="ƒ∞stanbul, T√ºrkiye" />
                </div>
                <div class="form-group">
                  <label for="website">Website</label>
                  <input type="url" id="website" placeholder="https://..." />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="twitter">Twitter</label>
                  <div class="input-prefix">
                    <span>@</span>
                    <input type="text" id="twitter" placeholder="kullanici_adi" />
                  </div>
                </div>
                <div class="form-group">
                  <label for="github">GitHub</label>
                  <div class="input-prefix">
                    <span>@</span>
                    <input type="text" id="github" placeholder="kullanici_adi" />
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Deƒüi≈üiklikleri Kaydet</button>
              </div>
            </form>
          </section>

          <!-- Hesap G√ºvenliƒüi -->
          <section id="section-account" class="settings-section hidden">
            <div class="section-header">
              <h3>Hesap G√ºvenliƒüi</h3>
              <p>≈ûifre ve g√ºvenlik ayarlarƒ±nƒ±zƒ± y√∂netin</p>
            </div>

            <form id="passwordForm" class="settings-form">
              <div class="form-group">
                <label for="currentPassword">Mevcut ≈ûifre</label>
                <input type="password" id="currentPassword" required />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="newPassword">Yeni ≈ûifre</label>
                  <input type="password" id="newPassword" minlength="6" required />
                  <small>En az 6 karakter</small>
                </div>
                <div class="form-group">
                  <label for="confirmPassword">Yeni ≈ûifre (Tekrar)</label>
                  <input type="password" id="confirmPassword" required />
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-warning">≈ûifreyi Deƒüi≈ütir</button>
              </div>
            </form>

            <hr class="divider" />

            <div class="danger-zone">
              <h4>Tehlikeli B√∂lge</h4>
              <p>Bu i≈ülemler geri alƒ±namaz</p>

              <div class="danger-actions">
                <button id="logoutAllBtn" class="btn btn-secondary">
                  T√ºm Oturumlarƒ± Kapat
                </button>
                <button id="deleteAccountBtn" class="btn btn-danger">
                  Hesabƒ± Sil
                </button>
              </div>
            </div>
          </section>

          <!-- Bildirimler -->
          <section id="section-notifications" class="settings-section hidden">
            <div class="section-header">
              <h3>Bildirim Ayarlarƒ±</h3>
              <p>Hangi bildirimleri almak istediƒüinizi se√ßin</p>
            </div>

            <form id="notificationForm" class="settings-form">
              <div class="toggle-group">
                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">E-posta Bildirimleri</span>
                    <span class="toggle-desc">Yeni i√ßerikler ve g√ºncellemeler hakkƒ±nda e-posta al</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="emailNotifications" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">Yorum Bildirimleri</span>
                    <span class="toggle-desc">Yazƒ±larƒ±nƒ±za yapƒ±lan yorumlar hakkƒ±nda bildirim al</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="commentNotifications" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">B√ºlten</span>
                    <span class="toggle-desc">Haftalƒ±k √∂zet ve √∂ne √ßƒ±kan i√ßerikler</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="newsletter" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">Pazarlama E-postalarƒ±</span>
                    <span class="toggle-desc">Kampanya ve promosyonlar hakkƒ±nda e-posta al</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="marketing" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Kaydet</button>
              </div>
            </form>
          </section>

          <!-- G√∂r√ºn√ºm -->
          <section id="section-appearance" class="settings-section hidden">
            <div class="section-header">
              <h3>G√∂r√ºn√ºm Ayarlarƒ±</h3>
              <p>Tema ve g√∂r√ºn√ºm tercihlerinizi ayarlayƒ±n</p>
            </div>

            <div class="settings-form">
              <div class="form-group">
                <label>Tema</label>
                <div class="theme-options">
                  <label class="theme-option">
                    <input type="radio" name="theme" value="dark" checked />
                    <div class="theme-preview dark">
                      <span>üåô</span>
                      Koyu
                    </div>
                  </label>
                  <label class="theme-option">
                    <input type="radio" name="theme" value="light" />
                    <div class="theme-preview light">
                      <span>‚òÄÔ∏è</span>
                      A√ßƒ±k
                    </div>
                  </label>
                  <label class="theme-option">
                    <input type="radio" name="theme" value="system" />
                    <div class="theme-preview system">
                      <span>üíª</span>
                      Sistem
                    </div>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label>Yazƒ± Boyutu</label>
                <div class="font-size-options">
                  <button type="button" class="font-btn" data-size="small">A</button>
                  <button type="button" class="font-btn active" data-size="medium">A</button>
                  <button type="button" class="font-btn" data-size="large">A</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Gizlilik -->
          <section id="section-privacy" class="settings-section hidden">
            <div class="section-header">
              <h3>Gizlilik Ayarlarƒ±</h3>
              <p>Profil g√∂r√ºn√ºrl√ºƒü√º ve veri tercihlerinizi y√∂netin</p>
            </div>

            <form id="privacyForm" class="settings-form">
              <div class="toggle-group">
                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">Profili Herkese A√ßƒ±k Yap</span>
                    <span class="toggle-desc">Profiliniz herkes tarafƒ±ndan g√∂r√ºlebilir</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="publicProfile" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">E-postamƒ± G√∂ster</span>
                    <span class="toggle-desc">E-posta adresiniz profilinizde g√∂r√ºn√ºr</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="showEmail" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>

                <div class="toggle-item">
                  <div class="toggle-info">
                    <span class="toggle-label">Aktivitelerimi G√∂ster</span>
                    <span class="toggle-desc">Yorum ve beƒüenileriniz g√∂r√ºn√ºr olsun</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="showActivity" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <hr class="divider" />

              <div class="data-section">
                <h4>Verilerim</h4>
                <div class="data-actions">
                  <button type="button" id="exportDataBtn" class="btn btn-secondary">
                    üì• Verilerimi ƒ∞ndir
                  </button>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Kaydet</button>
              </div>
            </form>
          </section>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  .settings-page {
    padding: 100px 20px 60px;
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .settings-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 30px;
  }

  /* Sidebar */
  .settings-sidebar {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 24px;
    height: fit-content;
    position: sticky;
    top: 100px;
  }

  .settings-sidebar h2 {
    font-size: 1.25rem;
    margin-bottom: 20px;
  }

  .settings-nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .settings-nav .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 10px;
    color: var(--text-muted);
    text-decoration: none;
    transition: all 0.2s;
  }

  .settings-nav .nav-item:hover {
    background: var(--bg-main);
    color: var(--text-main);
  }

  .settings-nav .nav-item.active {
    background: var(--accent);
    color: white;
  }

  .sidebar-footer {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border-soft);
  }

  /* Content */
  .settings-content {
    min-height: 500px;
  }

  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-soft);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .settings-section {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    padding: 30px;
  }

  .section-header {
    margin-bottom: 30px;
  }

  .section-header h3 {
    font-size: 1.25rem;
    margin-bottom: 6px;
  }

  .section-header p {
    color: var(--text-muted);
  }

  .hidden {
    display: none !important;
  }

  /* Form Styles */
  .settings-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    font-weight: 500;
    font-size: 0.9rem;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    padding: 12px 16px;
    background: var(--bg-main);
    border: 1px solid var(--border-soft);
    border-radius: 10px;
    color: var(--text-main);
    font-size: 1rem;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  .form-group input.readonly {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .form-group small {
    color: var(--text-muted);
    font-size: 0.8rem;
  }

  .input-prefix {
    display: flex;
    align-items: center;
    background: var(--bg-main);
    border: 1px solid var(--border-soft);
    border-radius: 10px;
    overflow: hidden;
  }

  .input-prefix span {
    padding: 12px;
    background: var(--border-soft);
    color: var(--text-muted);
  }

  .input-prefix input {
    border: none;
    background: transparent;
    flex: 1;
  }

  .form-actions {
    padding-top: 10px;
  }

  /* Avatar Upload */
  .avatar-upload {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #A855F7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
  }

  .avatar-preview img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .avatar-actions {
    display: flex;
    gap: 12px;
  }

  /* Toggle */
  .toggle-group {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .toggle-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--bg-main);
    border-radius: 12px;
  }

  .toggle-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .toggle-label {
    font-weight: 500;
  }

  .toggle-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .toggle {
    position: relative;
    width: 50px;
    height: 28px;
  }

  .toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--border-soft);
    border-radius: 28px;
    transition: 0.3s;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
  }

  .toggle input:checked + .toggle-slider {
    background: var(--accent);
  }

  .toggle input:checked + .toggle-slider:before {
    transform: translateX(22px);
  }

  /* Theme Options */
  .theme-options {
    display: flex;
    gap: 16px;
  }

  .theme-option {
    cursor: pointer;
  }

  .theme-option input {
    display: none;
  }

  .theme-preview {
    padding: 20px 30px;
    border-radius: 12px;
    border: 2px solid var(--border-soft);
    text-align: center;
    transition: all 0.2s;
  }

  .theme-preview span {
    display: block;
    font-size: 2rem;
    margin-bottom: 8px;
  }

  .theme-option input:checked + .theme-preview {
    border-color: var(--accent);
    background: rgba(99, 102, 241, 0.1);
  }

  /* Font Size */
  .font-size-options {
    display: flex;
    gap: 12px;
  }

  .font-btn {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    border: 2px solid var(--border-soft);
    background: var(--bg-main);
    cursor: pointer;
    transition: all 0.2s;
  }

  .font-btn:nth-child(1) { font-size: 0.9rem; }
  .font-btn:nth-child(2) { font-size: 1.1rem; }
  .font-btn:nth-child(3) { font-size: 1.4rem; }

  .font-btn.active {
    border-color: var(--accent);
    background: rgba(99, 102, 241, 0.1);
  }

  /* Danger Zone */
  .divider {
    border: none;
    border-top: 1px solid var(--border-soft);
    margin: 30px 0;
  }

  .danger-zone h4 {
    color: #EF4444;
    margin-bottom: 8px;
  }

  .danger-zone p {
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .danger-actions {
    display: flex;
    gap: 12px;
  }

  .data-section h4 {
    margin-bottom: 12px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-secondary {
    background: var(--bg-main);
    color: var(--text-main);
    border: 1px solid var(--border-soft);
  }

  .btn-warning {
    background: #EAB308;
    color: black;
  }

  .btn-danger {
    background: #EF4444;
    color: white;
  }

  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
  }

  .btn-sm {
    padding: 8px 16px;
    font-size: 0.9rem;
  }

  .btn-full {
    width: 100%;
  }

  @media (max-width: 768px) {
    .settings-layout {
      grid-template-columns: 1fr;
    }

    .settings-sidebar {
      position: static;
    }

    .settings-nav {
      flex-direction: row;
      overflow-x: auto;
      gap: 8px;
    }

    .settings-nav .nav-item {
      white-space: nowrap;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .theme-options {
      flex-direction: column;
    }
  }
</style>

<script is:inline>
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';
  let currentUser = null;

  document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('authToken');

    if (!token) {
      window.location.href = '/giris?redirect=/profil/ayarlar';
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) throw new Error('Oturum ge√ßersiz');

      currentUser = await res.json();
      document.getElementById('loadingState').classList.add('hidden');
      loadUserData();
      setupEventListeners();
    } catch (error) {
      localStorage.removeItem('authToken');
      window.location.href = '/giris?redirect=/profil/ayarlar';
    }
  });

  function loadUserData() {
    // Avatar
    const initials = (currentUser.display_name || currentUser.username || 'U').substring(0, 2).toUpperCase();
    if (currentUser.avatar_url) {
      document.getElementById('avatarPreview').innerHTML = `<img src="${currentUser.avatar_url}" />`;
    } else {
      document.getElementById('avatarInitials').textContent = initials;
    }

    // Form alanlarƒ±
    document.getElementById('displayName').value = currentUser.display_name || '';
    document.getElementById('username').value = currentUser.username;
    document.getElementById('bio').value = currentUser.bio || '';
    document.getElementById('location').value = currentUser.location || '';
    document.getElementById('website').value = currentUser.website || '';
    document.getElementById('twitter').value = currentUser.twitter || '';
    document.getElementById('github').value = currentUser.github || '';

    // Bio karakter sayacƒ±
    updateBioCount();
  }

  function setupEventListeners() {
    // Sidebar navigation
    document.querySelectorAll('.settings-nav .nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const section = item.dataset.section;
        showSection(section);
      });
    });

    // Bio karakter sayacƒ±
    document.getElementById('bio').addEventListener('input', updateBioCount);

    // Profil formu
    document.getElementById('profileForm').addEventListener('submit', saveProfile);

    // ≈ûifre formu
    document.getElementById('passwordForm').addEventListener('submit', changePassword);
  }

  function showSection(sectionId) {
    // Nav active state
    document.querySelectorAll('.settings-nav .nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.section === sectionId);
    });

    // Section visibility
    document.querySelectorAll('.settings-section').forEach(section => {
      section.classList.add('hidden');
    });
    document.getElementById(`section-${sectionId}`).classList.remove('hidden');
  }

  function updateBioCount() {
    const bio = document.getElementById('bio');
    document.getElementById('bioCount').textContent = bio.value.length;
  }

  async function saveProfile(e) {
    e.preventDefault();

    const token = localStorage.getItem('authToken');
    const data = {
      display_name: document.getElementById('displayName').value,
      bio: document.getElementById('bio').value,
      location: document.getElementById('location').value,
      website: document.getElementById('website').value,
      twitter: document.getElementById('twitter').value,
      github: document.getElementById('github').value
    };

    try {
      const res = await fetch(`${API_URL}/api/auth/profile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        window.showToast('Profil g√ºncellendi!', 'success');
      } else {
        const result = await res.json();
        window.showToast('Hata: ' + (result.error || 'Bilinmeyen hata'), 'error');
      }
    } catch (error) {
      window.showToast('Baƒülantƒ± hatasƒ±', 'error');
    }
  }

  async function changePassword(e) {
    e.preventDefault();

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
      window.showToast('Yeni ≈üifreler e≈üle≈ümiyor!', 'warning');
      return;
    }

    if (newPassword.length < 6) {
      window.showToast('≈ûifre en az 6 karakter olmalƒ±!', 'warning');
      return;
    }

    const token = localStorage.getItem('authToken');

    try {
      const res = await fetch(`${API_URL}/api/auth/change-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ currentPassword, newPassword })
      });

      if (res.ok) {
        window.showToast('≈ûifre deƒüi≈ütirildi!', 'success');
        document.getElementById('passwordForm').reset();
      } else {
        const result = await res.json();
        window.showToast('Hata: ' + (result.error || 'Mevcut ≈üifre yanlƒ±≈ü olabilir'), 'error');
      }
    } catch (error) {
      window.showToast('Baƒülantƒ± hatasƒ±', 'error');
    }
  }
</script>
