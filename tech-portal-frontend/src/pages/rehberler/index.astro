---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import { getApiBase } from "../../lib/api";

type Post = {
  id: number;
  title_tr: string;
  summary_tr: string;
  slug: string;
  category: string;
  image_url?: string;
  is_featured: number;
  created_at?: string;
};

type Pagination = {
  page: number;
  limit: number;
  total: number;
  totalPages: number;
  hasNext: boolean;
  hasPrev: boolean;
};

type ApiResponse = {
  posts: Post[];
  pagination: Pagination;
};

export const prerender = false;

const API_BASE = getApiBase(Astro.request);

const url = new URL(Astro.request.url);
const currentPage = Math.max(1, parseInt(url.searchParams.get("page") || "1", 10));
const POSTS_PER_PAGE = 24;

let posts: Post[] = [];
let pagination: Pagination | null = null;
let error: string | null = null;

try {
  const res = await fetch(
    `${API_BASE}/api/posts?category=rehberler&page=${currentPage}&limit=${POSTS_PER_PAGE}`,
    { headers: { "Accept": "application/json" } }
  );

  if (!res.ok) {
    throw new Error(`API hatasƒ±: ${res.status}`);
  }

  const data: ApiResponse = await res.json();
  posts = data.posts;
  pagination = data.pagination;
} catch (e) {
  error = e instanceof Error ? e.message : "Bilinmeyen hata";
  console.error("Rehberler sayfasƒ± hatasƒ±:", error);
}

const title = currentPage > 1
  ? `Rehberler - Sayfa ${currentPage} - 3D-labX`
  : "3D Baskƒ± Rehberleri - Dilimleyici, Kalibrasyon, Malzeme | 3D-labX";

const description = "3D baskƒ± rehberleri: Cura, Orca Slicer, PrusaSlicer ayarlarƒ±, Klipper kurulumu, filament se√ßimi ve kalibrasyon kƒ±lavuzlarƒ±.";

// ƒ∞nteraktif rehberler (statik sayfalar)
const interactiveGuides = [
  {
    name: "Cura Slicer",
    slug: "cura-slicer-interaktif-rehber",
    icon: "üéØ",
    color: "#0077C8",
    description: "Akƒ±≈ü hesaplamalarƒ±, yapƒ±sal mekanik ve sorun √ß√∂z√ºmleri",
    features: ["Volumetrik Akƒ±≈ü", "Z-Offset Sim√ºlasyonu", "Infill Desenleri"]
  },
  {
    name: "Orca Slicer",
    slug: "orca-slicer-rehberi",
    icon: "üêã",
    color: "#10b981",
    description: "Kalibrasyon, ayarlar s√∂zl√ºƒü√º ve sorun giderme",
    features: ["PA Kalibrasyonu", "Akƒ±≈ü Testi", "Max Volumetric"]
  },
  {
    name: "Bambu Lab Slicer",
    slug: "bambu-slicer-rehberi",
    icon: "üéã",
    color: "#00AE42",
    description: "X1C, P1P, P1S, A1 i√ßin uzman rehberi ve sorun giderme",
    features: ["Filament Kurutma", "Volumetric Flow", "Sorun Giderme"]
  }
];

// Kategoriler
const categories = [
  {
    id: "slicer",
    name: "Dilimleyici Rehberleri",
    icon: "üñ•Ô∏è",
    color: "#3B82F6",
    keywords: ["cura", "orca", "prusa", "slicer", "dilimleme", "dilimleyici"]
  },
  {
    id: "klipper",
    name: "Klipper & Firmware",
    icon: "‚ö°",
    color: "#F97316",
    keywords: ["klipper", "firmware", "marlin", "input shaping", "pressure advance"]
  },
  {
    id: "material",
    name: "Malzeme Rehberleri",
    icon: "üßµ",
    color: "#8B5CF6",
    keywords: ["filament", "pla", "petg", "abs", "tpu", "re√ßine", "malzeme", "shore"]
  },
  {
    id: "calibration",
    name: "Kalibrasyon",
    icon: "üìê",
    color: "#22C55E",
    keywords: ["kalibrasyon", "ayar", "seviyeleme", "e-step", "pid"]
  },
  {
    id: "business",
    name: "ƒ∞≈ü & Satƒ±≈ü",
    icon: "üí∞",
    color: "#EAB308",
    keywords: ["maƒüaza", "satƒ±≈ü", "esnaf", "vergi", "kazan√ß", "fiyat"]
  }
];

// ƒ∞nteraktif rehberlerin slug'larƒ± - bunlarƒ± listeden hari√ß tut
const interactiveSlugs = interactiveGuides.map(g => g.slug);

// Postlarƒ± kategorilere ayƒ±r
function categorizePost(post: Post): string {
  const titleLower = post.title_tr.toLowerCase();
  const summaryLower = post.summary_tr.toLowerCase();
  const combined = titleLower + " " + summaryLower;

  for (const cat of categories) {
    if (cat.keywords.some(kw => combined.includes(kw))) {
      return cat.id;
    }
  }
  return "other";
}

const categorizedPosts: Record<string, Post[]> = {
  slicer: [],
  klipper: [],
  material: [],
  calibration: [],
  business: [],
  other: []
};

// ƒ∞nteraktif rehberleri ve Cura/Orca i√ßeren postlarƒ± hari√ß tut
posts.forEach(post => {
  // ƒ∞nteraktif rehber slug'larƒ±nƒ± atla
  if (interactiveSlugs.includes(post.slug)) return;

  // "Cura", "Orca" veya "Bambu" i√ßeren ba≈ülƒ±klarƒ± atla (zaten √ºstte interaktif olarak var)
  const titleLower = post.title_tr.toLowerCase();
  if (titleLower.includes('cura') || titleLower.includes('orca') || titleLower.includes('bambu')) return;

  const catId = categorizePost(post);
  categorizedPosts[catId].push(post);
});

// Schema.org
const schemaData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "3D Baskƒ± Rehberleri",
  "description": description,
  "url": "https://3d-labx.com/rehberler",
  "publisher": {
    "@type": "Organization",
    "name": "3D-labX",
    "url": "https://3d-labx.com"
  }
};
---

<BaseLayout title={title} description={description}>
  <Header />

  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

  <main class="guides-page">
    <div class="container">

      <!-- Hero Section -->
      <header class="page-hero">
        <nav class="breadcrumb">
          <a href="/">Ana Sayfa</a>
          <span>/</span>
          <span class="current">Rehberler</span>
        </nav>
        <div class="hero-content">
          <div class="hero-badge">
            <span class="badge-icon">üìö</span>
            <span>Kapsamlƒ± Kƒ±lavuzlar</span>
          </div>
          <h1>3D Baskƒ± Rehberleri</h1>
          <p class="hero-desc">Dilimleyici ayarlarƒ±ndan kalibrasyon s√ºre√ßlerine, malzeme se√ßiminden sorun gidermeye kadar t√ºm rehberler.</p>
          <div class="hero-stats">
            <div class="stat">
              <span class="stat-number">{pagination?.total || posts.length}</span>
              <span class="stat-label">Rehber</span>
            </div>
            <div class="stat">
              <span class="stat-number">{interactiveGuides.length}</span>
              <span class="stat-label">ƒ∞nteraktif</span>
            </div>
            <div class="stat">
              <span class="stat-number">{categories.length}</span>
              <span class="stat-label">Kategori</span>
            </div>
          </div>
        </div>
      </header>

      <!-- ƒ∞nteraktif Rehberler - √ñne √áƒ±kan -->
      <section class="interactive-section">
        <div class="section-header">
          <h2>
            <span class="section-icon">üéÆ</span>
            ƒ∞nteraktif Rehberler
          </h2>
          <span class="section-badge">√ñzel ƒ∞√ßerik</span>
        </div>

        <div class="interactive-grid">
          {interactiveGuides.map(guide => (
            <a href={`/rehberler/${guide.slug}`} class="interactive-card" style={`--card-color: ${guide.color}`}>
              <div class="card-glow"></div>
              <div class="card-header">
                <span class="card-icon">{guide.icon}</span>
                <span class="card-badge">ƒ∞nteraktif</span>
              </div>
              <div class="card-body">
                <h3>{guide.name}</h3>
                <p>{guide.description}</p>
                <div class="feature-tags">
                  {guide.features.map(f => (
                    <span class="feature-tag">{f}</span>
                  ))}
                </div>
              </div>
              <div class="card-footer">
                <span class="explore-link">
                  Ke≈üfet
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m9 18 6-6-6-6"/>
                  </svg>
                </span>
              </div>
            </a>
          ))}
        </div>
      </section>

      <!-- Filament Fiyat Takibi - Bento Grid -->
      <section class="filament-bento" id="filamentSection">
        <div class="filament-bento-header">
          <div class="filament-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>Fiyat Takibi</span>
          </div>
          <h2>Filament & Re√ßine Fiyatlarƒ±</h2>
          <span class="filament-update" id="filamentUpdate"></span>
        </div>
        <div class="filament-bento-grid" id="filamentGrid">
          <div class="filament-loading">
            <div class="spinner"></div>
            <span>Y√ºkleniyor...</span>
          </div>
        </div>
      </section>

      {error && (
        <div class="message message-error">
          <p><strong>ƒ∞√ßerikler y√ºklenirken bir hata olu≈ütu.</strong></p>
          <p class="text-sm">{error}</p>
        </div>
      )}

      <!-- Kategori Bazlƒ± Rehberler -->
      {categories.map(cat => {
        const catPosts = categorizedPosts[cat.id];
        if (catPosts.length === 0) return null;

        return (
          <section class="category-section" id={`cat-${cat.id}`}>
            <div class="section-header">
              <h2 style={`--cat-color: ${cat.color}`}>
                <span class="section-icon">{cat.icon}</span>
                {cat.name}
              </h2>
              <span class="post-count">{catPosts.length} rehber</span>
            </div>

            <div class="posts-grid">
              {catPosts.slice(0, 6).map((post, i) => (
                <a href={`/rehberler/${post.slug}`} class={`post-card ${i === 0 ? 'featured' : ''}`} style={`--cat-color: ${cat.color}`}>
                  {post.image_url && (
                    <div class="post-image">
                      <img src={post.image_url} alt={post.title_tr} loading="lazy" />
                    </div>
                  )}
                  <div class="post-content">
                    {post.is_featured === 1 && (
                      <span class="post-badge">√ñne √áƒ±kan</span>
                    )}
                    <h3>{post.title_tr}</h3>
                    <p>{post.summary_tr}</p>
                    {post.created_at && (
                      <time class="post-date">
                        {new Date(post.created_at).toLocaleDateString("tr-TR", {
                          year: "numeric",
                          month: "short",
                          day: "numeric"
                        })}
                      </time>
                    )}
                  </div>
                </a>
              ))}
            </div>

            {catPosts.length > 6 && (
              <div class="show-more">
                <button class="show-more-btn" data-category={cat.id}>
                  <span>T√ºm√ºn√º G√∂ster ({catPosts.length})</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m6 9 6 6 6-6"/>
                  </svg>
                </button>
              </div>
            )}
          </section>
        );
      })}

      <!-- Diƒüer Rehberler -->
      {categorizedPosts.other.length > 0 && (
        <section class="category-section" id="cat-other">
          <div class="section-header">
            <h2>
              <span class="section-icon">üìñ</span>
              Diƒüer Rehberler
            </h2>
            <span class="post-count">{categorizedPosts.other.length} rehber</span>
          </div>

          <div class="posts-grid">
            {categorizedPosts.other.map((post, i) => (
              <a href={`/rehberler/${post.slug}`} class={`post-card ${i === 0 ? 'featured' : ''}`}>
                {post.image_url && (
                  <div class="post-image">
                    <img src={post.image_url} alt={post.title_tr} loading="lazy" />
                  </div>
                )}
                <div class="post-content">
                  <h3>{post.title_tr}</h3>
                  <p>{post.summary_tr}</p>
                  {post.created_at && (
                    <time class="post-date">
                      {new Date(post.created_at).toLocaleDateString("tr-TR", {
                        year: "numeric",
                        month: "short",
                        day: "numeric"
                      })}
                    </time>
                  )}
                </div>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Quick Links -->
      <section class="quick-links-section">
        <h2>
          <span class="section-icon">üîó</span>
          Hƒ±zlƒ± Eri≈üim
        </h2>
        <div class="quick-links">
          <a href="/sorun-cozumleri" class="quick-link">
            <span class="link-icon">üîß</span>
            <span>Sorun √á√∂z√ºmleri</span>
          </a>
          <a href="/3d-baski/malzemeler" class="quick-link">
            <span class="link-icon">üßµ</span>
            <span>Filament T√ºrleri</span>
          </a>
          <a href="/filamentler" class="quick-link">
            <span class="link-icon">üáπüá∑</span>
            <span>Yerli Markalar</span>
          </a>
          <a href="/topluluk/forum" class="quick-link">
            <span class="link-icon">üí¨</span>
            <span>Foruma Sor</span>
          </a>
        </div>
      </section>

    </div>
  </main>
</BaseLayout>

<style is:global>
  .guides-page {
    padding: 120px 0 60px;
    min-height: 100vh;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .breadcrumb a {
    color: var(--text-muted);
    text-decoration: none;
  }

  .breadcrumb a:hover { color: var(--accent); }
  .breadcrumb .current { color: var(--text-main); }

  /* Hero Section */
  .page-hero {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border: 1px solid var(--border-soft);
    border-radius: 24px;
    padding: 40px;
    margin-bottom: 40px;
  }

  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    background: var(--bg-card);
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .badge-icon { font-size: 1rem; }

  .page-hero h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-main);
    margin-bottom: 12px;
  }

  .hero-desc {
    font-size: 1.1rem;
    color: var(--text-muted);
    max-width: 600px;
    line-height: 1.6;
    margin-bottom: 24px;
  }

  .hero-stats {
    display: flex;
    gap: 32px;
  }

  .stat {
    display: flex;
    flex-direction: column;
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 800;
    color: var(--accent);
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  /* Section Headers */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .section-header h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-main);
    margin: 0;
  }

  .section-icon {
    font-size: 1.25rem;
  }

  .section-badge {
    padding: 4px 12px;
    background: linear-gradient(135deg, #3B82F6, #8B5CF6);
    color: white;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .update-badge {
    padding: 4px 12px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #22C55E;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .post-count {
    padding: 6px 14px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  /* Interactive Section */
  .interactive-section {
    margin-bottom: 48px;
  }

  .interactive-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
  }

  .interactive-card {
    position: relative;
    background: var(--bg-card);
    border: 2px solid var(--border-soft);
    border-radius: 20px;
    padding: 28px;
    text-decoration: none;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .interactive-card:hover {
    transform: translateY(-4px);
    border-color: var(--card-color);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .card-glow {
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, var(--card-color) 0%, transparent 70%);
    opacity: 0.05;
    pointer-events: none;
  }

  .interactive-card:hover .card-glow {
    opacity: 0.1;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .card-icon {
    font-size: 2.5rem;
  }

  .card-badge {
    padding: 4px 10px;
    background: var(--card-color);
    color: white;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .card-body h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 8px;
  }

  .card-body p {
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  .feature-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .feature-tag {
    padding: 4px 10px;
    background: var(--bg-soft);
    border-radius: 6px;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .card-footer {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--border-soft);
  }

  .explore-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--card-color);
  }

  .explore-link svg {
    width: 16px;
    height: 16px;
    transition: transform 0.2s;
  }

  .interactive-card:hover .explore-link svg {
    transform: translateX(4px);
  }

  /* Filament Bento Grid */
  .filament-bento {
    margin-bottom: 48px;
    padding: 24px;
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 20px;
    position: relative;
  }

  .filament-bento::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #F97316, #EAB308, #22C55E, #06B6D4, #A855F7, #EF4444);
    border-radius: 20px 20px 0 0;
  }

  .filament-bento-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filament-bento-header h2 {
    font-size: 1.1rem;
    margin: 0;
    background: linear-gradient(135deg, var(--text-main) 0%, var(--text-muted) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .filament-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #EAB308;
    background: rgba(234, 179, 8, 0.1);
    padding: 4px 10px;
    border-radius: 12px;
  }

  .filament-update {
    margin-left: auto;
    font-size: 0.7rem;
    color: var(--text-light);
  }

  .filament-bento-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  @media (min-width: 640px) {
    .filament-bento-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (min-width: 1024px) {
    .filament-bento-grid { grid-template-columns: repeat(4, 1fr); }
  }

  .filament-loading {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 40px;
    color: var(--text-muted);
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border-soft);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Filament Category Cards */
  .filament-category-card {
    background: #1e293b;
    border: 2px solid #334155;
    border-radius: 14px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  [data-theme="light"] .filament-category-card {
    background: #f8fafc;
    border-color: #e2e8f0;
  }

  .filament-category-card:hover {
    border-color: var(--card-color, #EAB308);
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  }

  .filament-category-card.expanded {
    border-color: var(--card-color, #EAB308);
    background: #0f172a;
  }

  [data-theme="light"] .filament-category-card.expanded {
    background: #ffffff;
  }

  .filament-category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .filament-category-name {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--card-color, #EAB308);
  }

  .filament-category-count {
    font-size: 0.65rem;
    color: #94a3b8;
    background: rgba(255,255,255,0.1);
    padding: 4px 8px;
    border-radius: 8px;
  }

  [data-theme="light"] .filament-category-count {
    color: #64748b;
    background: rgba(0,0,0,0.05);
  }

  .filament-best-price {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .filament-best-label {
    font-size: 0.6rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .filament-best-value {
    display: flex;
    align-items: baseline;
    gap: 4px;
  }

  .filament-best-amount {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--text-main);
  }

  .filament-best-currency {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
  }

  .filament-best-brand {
    font-size: 0.65rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .filament-expand-icon {
    position: absolute;
    bottom: 6px;
    right: 8px;
    color: var(--text-light);
    transition: transform 0.2s ease;
  }

  .filament-category-card.expanded .filament-expand-icon {
    transform: rotate(180deg);
  }

  /* Alternatives Panel */
  .filament-alternatives {
    grid-column: 1 / -1;
    background: #1e293b;
    border: 2px solid #334155;
    border-radius: 14px;
    padding: 20px;
    display: none;
    animation: slideDown 0.2s ease;
  }

  [data-theme="light"] .filament-alternatives {
    background: #f8fafc;
    border-color: #e2e8f0;
  }

  .filament-alternatives.visible {
    display: block;
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .filament-alternatives-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-soft);
  }

  .filament-alternatives-title {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-main);
  }

  .filament-alternatives-close {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    padding: 4px;
  }

  .filament-alternatives-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
  }

  .filament-alt-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.2s;
  }

  [data-theme="light"] .filament-alt-item {
    background: #ffffff;
    border-color: #e2e8f0;
  }

  .filament-alt-item:hover {
    border-color: var(--card-color, #EAB308);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .filament-alt-item.best-deal {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
    border: 2px solid rgba(34, 197, 94, 0.4);
    position: relative;
  }

  .filament-alt-item .best-badge {
    position: absolute;
    top: -10px;
    left: 12px;
    background: linear-gradient(135deg, #22c55e, #10b981);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
  }

  .filament-alt-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .filament-alt-brand {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-main);
  }

  .filament-alt-name {
    font-size: 0.7rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
  }

  .filament-alt-meta {
    display: flex;
    gap: 8px;
    font-size: 0.6rem;
    color: var(--text-light);
  }

  .filament-alt-price {
    text-align: right;
  }

  .filament-alt-amount {
    font-size: 1rem;
    font-weight: 800;
    color: #22C55E;
  }

  .filament-alt-store {
    font-size: 0.6rem;
    color: var(--text-light);
  }

  .filament-view-all {
    display: block;
    text-align: center;
    padding: 14px 20px;
    margin-top: 12px;
    background: linear-gradient(135deg, var(--card-color, #F97316) 0%, color-mix(in srgb, var(--card-color, #F97316) 80%, black) 100%);
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .filament-view-all:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  .filament-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 30px;
    color: var(--text-muted);
  }

  @media (max-width: 640px) {
    .filament-bento { padding: 16px; }
    .filament-bento-header { flex-direction: column; align-items: flex-start; gap: 8px; }
    .filament-update { margin-left: 0; }
  }

  /* Category Section */
  .category-section {
    margin-bottom: 48px;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  .post-card {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 16px;
    overflow: hidden;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    border-color: var(--cat-color, var(--accent));
  }

  .post-card.featured {
    grid-column: span 2;
  }

  .post-image {
    aspect-ratio: 16/9;
    overflow: hidden;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  }

  .post-card.featured .post-image {
    aspect-ratio: 21/9;
  }

  .post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .post-card:hover .post-image img {
    transform: scale(1.05);
  }

  .post-content {
    padding: 16px;
  }

  .post-badge {
    display: inline-block;
    padding: 3px 8px;
    background: var(--cat-color, var(--accent));
    color: white;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .post-content h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 8px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .post-card.featured .post-content h3 {
    font-size: 1.15rem;
  }

  .post-content p {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin: 0;
  }

  .post-date {
    display: block;
    margin-top: 12px;
    font-size: 0.75rem;
    color: var(--text-light);
  }

  /* Show More */
  .show-more {
    text-align: center;
    margin-top: 20px;
  }

  .show-more-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: var(--bg-card);
    border: 2px solid var(--border-soft);
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.2s;
  }

  .show-more-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .show-more-btn svg {
    width: 18px;
    height: 18px;
    transition: transform 0.2s;
  }

  .show-more-btn:hover svg {
    transform: translateY(2px);
  }

  /* Quick Links */
  .quick-links-section {
    background: var(--bg-card);
    border: 1px solid var(--border-soft);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 40px;
  }

  .quick-links-section h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 20px;
  }

  .quick-links {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }

  .quick-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: var(--bg-soft);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text-main);
    transition: all 0.2s;
  }

  .quick-link:hover {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
    transform: translateY(-2px);
  }

  .link-icon {
    font-size: 1.25rem;
  }

  .quick-link span:last-child {
    font-size: 0.9rem;
    font-weight: 500;
  }

  /* Error Message */
  .message-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    margin-bottom: 32px;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .interactive-grid {
      grid-template-columns: 1fr;
    }

    .posts-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .post-card.featured {
      grid-column: span 2;
    }

    .quick-links {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .guides-page {
      padding-top: 100px;
    }

    .page-hero {
      padding: 24px;
    }

    .page-hero h1 {
      font-size: 1.75rem;
    }

    .hero-stats {
      gap: 20px;
    }

    .stat-number {
      font-size: 1.5rem;
    }

    .posts-grid {
      grid-template-columns: 1fr;
    }

    .post-card.featured {
      grid-column: span 1;
    }

    .post-card.featured .post-image {
      aspect-ratio: 16/9;
    }

    .quick-links {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline>
  (function() {
    const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';

    let allFilamentPrices = [];
    let expandedCategory = null;

    const CATEGORIES = ['PLA', 'PETG', 'ABS', 'ASA'];
    const CATEGORY_COLORS = {
      'PLA': '#F97316',
      'PETG': '#06B6D4',
      'ABS': '#EF4444',
      'ASA': '#EAB308'
    };

    async function loadFilamentPrices() {
      const grid = document.getElementById('filamentGrid');
      const updateEl = document.getElementById('filamentUpdate');
      if (!grid) return;

      try {
        const res = await fetch(`${API_URL}/api/filament-prices`);
        const data = await res.json();

        allFilamentPrices = data.prices || [];

        if (updateEl) {
          updateEl.textContent = new Date().toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
        }

        renderBentoGrid();
      } catch (err) {
        console.error('Filament prices error:', err);
        grid.innerHTML = '<div class="filament-empty">Fiyatlar y√ºklenemedi.</div>';
      }
    }

    function renderBentoGrid() {
      const grid = document.getElementById('filamentGrid');
      if (!grid) return;

      if (allFilamentPrices.length === 0) {
        grid.innerHTML = '<div class="filament-empty">Fiyat verisi bulunamadƒ±.</div>';
        return;
      }

      const categoryCards = CATEGORIES.map(cat => {
        const items = allFilamentPrices.filter(p => p.filament_type === cat);
        if (items.length === 0) return '';

        const sorted = [...items].sort((a, b) => a.price_tl - b.price_tl);
        const best = sorted[0];
        const isExpanded = expandedCategory === cat;
        const color = CATEGORY_COLORS[cat] || '#EAB308';

        return `
          <div class="filament-category-card ${isExpanded ? 'expanded' : ''}" data-category="${cat}" style="--card-color: ${color}">
            <div class="filament-category-header">
              <span class="filament-category-name">${cat}</span>
              <span class="filament-category-count">${items.length} √ºr√ºn</span>
            </div>
            <div class="filament-best-price">
              <span class="filament-best-label">En uygun</span>
              <div class="filament-best-value">
                <span class="filament-best-amount">${Math.round(best.price_tl)}</span>
                <span class="filament-best-currency">TL</span>
              </div>
              <span class="filament-best-brand">${best.brand}</span>
            </div>
            <svg class="filament-expand-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
          </div>
        `;
      }).filter(Boolean).join('');

      let alternativesHtml = '';
      if (expandedCategory) {
        const items = allFilamentPrices.filter(p => p.filament_type === expandedCategory);
        const sorted = [...items].sort((a, b) => a.price_tl - b.price_tl).slice(0, 6);
        const color = CATEGORY_COLORS[expandedCategory] || '#EAB308';

        const categoryUrls = {
          'PLA': 'https://www.filamentmarketim.com/pla-filament?siralama=en-dusuk-fiyat',
          'PETG': 'https://www.filamentmarketim.com/petg-filament?siralama=en-dusuk-fiyat',
          'ABS': 'https://www.filamentmarketim.com/abs-filament?siralama=en-dusuk-fiyat',
          'ASA': 'https://www.filamentmarketim.com/asa-filament?siralama=en-dusuk-fiyat'
        };

        alternativesHtml = `
          <div class="filament-alternatives visible" data-for="${expandedCategory}" style="--card-color: ${color}">
            <div class="filament-alternatives-header">
              <span class="filament-alternatives-title">${expandedCategory} Fiyatlarƒ± (En Ucuzdan Pahalƒ±ya)</span>
              <button class="filament-alternatives-close" data-close="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
              </button>
            </div>
            <div class="filament-alternatives-list">
              ${sorted.map((p, i) => `
                <a href="${p.store_url || '#'}" target="_blank" rel="noopener noreferrer" class="filament-alt-item ${i === 0 ? 'best-deal' : ''}" style="--card-color: ${color}">
                  ${i === 0 ? '<span class="best-badge">üèÜ En Uygun</span>' : ''}
                  <div class="filament-alt-info">
                    <span class="filament-alt-brand">${p.brand}</span>
                    <span class="filament-alt-name">${p.product_name || ''}</span>
                    <div class="filament-alt-meta">
                      <span>${p.weight_grams || 1000}g</span>
                      <span>${p.color || ''}</span>
                    </div>
                  </div>
                  <div class="filament-alt-price">
                    <span class="filament-alt-amount">${Math.round(p.price_tl)} TL</span>
                    <span class="filament-alt-store">${p.store_name}</span>
                  </div>
                </a>
              `).join('')}
            </div>
            <a href="${categoryUrls[expandedCategory] || '#'}" target="_blank" rel="noopener noreferrer" class="filament-view-all">
              T√ºm ${expandedCategory} Fiyatlarƒ±nƒ± G√∂r ‚Üí
            </a>
          </div>
        `;
      }

      grid.innerHTML = categoryCards + alternativesHtml;
      setupCardListeners();
    }

    function setupCardListeners() {
      const cards = document.querySelectorAll('.filament-category-card');
      cards.forEach(card => {
        card.addEventListener('click', function() {
          const cat = this.dataset.category;
          if (expandedCategory === cat) {
            expandedCategory = null;
          } else {
            expandedCategory = cat || null;
          }
          renderBentoGrid();
        });
      });

      const closeBtn = document.querySelector('.filament-alternatives-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          expandedCategory = null;
          renderBentoGrid();
        });
      }
    }

    // Load immediately
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadFilamentPrices);
    } else {
      loadFilamentPrices();
    }

    // Also listen for Astro navigation
    document.addEventListener('astro:page-load', function() {
      expandedCategory = null;
      loadFilamentPrices();
    });
  })();
</script>
