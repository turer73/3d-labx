---
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/admin.css";
---

<BaseLayout title="Admin Giri≈ü ‚Äì 3D-labX" noIndex={true}>
  <main class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1>üîê Admin Panel</h1>
        <p>3D-labX y√∂netim paneline ho≈ü geldiniz</p>
      </div>

      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="secret">Admin ≈ûifresi</label>
          <input
            type="password"
            id="secret"
            name="secret"
            placeholder="≈ûifrenizi girin..."
            required
            autocomplete="current-password"
          />
        </div>

        <button type="submit" class="btn btn-primary btn-full">
          <span class="btn-text">Giri≈ü Yap</span>
          <span class="btn-loading hidden">
            <span class="spinner"></span>
            Kontrol ediliyor...
          </span>
        </button>

        <div id="errorMessage" class="error-message hidden"></div>
      </form>
    </div>
  </main>
</BaseLayout>

<script>
  const form = document.getElementById('loginForm') as HTMLFormElement;
  const errorDiv = document.getElementById('errorMessage') as HTMLDivElement;
  const btn = form.querySelector('button') as HTMLButtonElement;
  const btnText = btn.querySelector('.btn-text') as HTMLSpanElement;
  const btnLoading = btn.querySelector('.btn-loading') as HTMLSpanElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const secret = (document.getElementById('secret') as HTMLInputElement).value;

    // Loading state
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');
    btn.disabled = true;
    errorDiv.classList.add('hidden');

    try {
      // API'yi test et
      const res = await fetch('https://tech-portal-api.turgut-d01.workers.dev/admin/posts', {
        headers: {
          'X-ADMIN-SECRET': secret
        }
      });

      if (res.ok) {
        // ≈ûifreyi localStorage'a kaydet ve dashboard'a y√∂nlendir
        localStorage.setItem('adminSecret', secret);
        window.location.href = '/admin/dashboard';
      } else {
        throw new Error('Ge√ßersiz ≈üifre');
      }
    } catch (err) {
      errorDiv.textContent = 'Ge√ßersiz ≈üifre. L√ºtfen tekrar deneyin.';
      errorDiv.classList.remove('hidden');
    } finally {
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
      btn.disabled = false;
    }
  });

  // Zaten giri≈ü yapmƒ±≈üsa dashboard'a y√∂nlendir
  const savedSecret = localStorage.getItem('adminSecret');
  if (savedSecret) {
    fetch('https://tech-portal-api.turgut-d01.workers.dev/admin/posts', {
      headers: { 'X-ADMIN-SECRET': savedSecret }
    }).then(res => {
      if (res.ok) {
        window.location.href = '/admin/dashboard';
      } else {
        localStorage.removeItem('adminSecret');
      }
    });
  }
</script>
