name: Sync Turkish to English Site

on:
  push:
    branches: [main]
    paths:
      - 'tech-portal-frontend/**'
  workflow_dispatch:

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tech-portal-frontend-en/package-lock.json

      - name: Sync files from Turkish to English site
        run: |
          echo "ðŸ”„ Syncing files..."

          # Sync components (except Header.astro - has custom translations)
          rsync -av --exclude="Header.astro" \
            tech-portal-frontend/src/components/ \
            tech-portal-frontend-en/src/components/

          # Sync styles
          rsync -av tech-portal-frontend/src/styles/ tech-portal-frontend-en/src/styles/

          # Sync public assets
          rsync -av tech-portal-frontend/public/ tech-portal-frontend-en/public/

          # Sync layouts (except BaseLayout.astro - has custom translations)
          rsync -av --exclude="BaseLayout.astro" \
            tech-portal-frontend/src/layouts/ \
            tech-portal-frontend-en/src/layouts/

          echo "âœ… Sync complete"

      - name: Install dependencies
        working-directory: tech-portal-frontend-en
        run: npm ci

      - name: Build English site
        working-directory: tech-portal-frontend-en
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: tech-portal-frontend-en
          command: pages deploy dist --project-name=tech-portal-frontend-en

      - name: Commit synced changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tech-portal-frontend-en/
          git diff --staged --quiet || git commit -m "ðŸ”„ Auto-sync: English site updated"
          git push
