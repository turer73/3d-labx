---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const title = "√úr√ºn Ekle - 3D-labX Maƒüaza";
const description = "3D baskƒ± √ºr√ºn√ºn√ºz√º maƒüazamƒ±za ekleyin.";

const categories = [
  "Lamba",
  "Dekoratif",
  "Fig√ºr",
  "Aksesuar",
  "Fonksiyonel",
  "Oyuncak",
  "Takƒ±",
  "Diƒüer"
];
---

<BaseLayout title={title} description={description} noIndex={true}>
  <Header />

  <main class="add-product-page">
    <div class="container">
      <div class="page-header">
        <a href="/" class="back-link">‚Üê Maƒüazaya D√∂n</a>
        <h1>√úr√ºn Ekle</h1>
        <p>3D baskƒ± √ºr√ºn√ºn√ºz√º satƒ±≈üa sunun</p>
      </div>

      <!-- Giri≈ü Yapƒ±lmamƒ±≈ü -->
      <div id="loginWarning" class="warning-box">
        <div class="warning-icon">üîí</div>
        <h3>Giri≈ü Yapmalƒ±sƒ±nƒ±z</h3>
        <p>√úr√ºn eklemek i√ßin 3D-labX hesabƒ±nƒ±zla giri≈ü yapƒ±n.</p>
        <a href="https://3d-labx.com/auth/giris" class="btn btn-primary" target="_blank">Giri≈ü Yap</a>
      </div>

      <!-- Form -->
      <form id="productForm" class="product-form" style="display: none;">
        <div class="form-section">
          <h2>√úr√ºn Bilgileri</h2>

          <div class="form-group">
            <label for="title">√úr√ºn Ba≈ülƒ±ƒüƒ± *</label>
            <input type="text" id="title" name="title" required maxlength="200"
                   placeholder="√ñrn: 3D Baskƒ± Dekoratif Lamba" />
          </div>

          <div class="form-group">
            <label for="description">√úr√ºn A√ßƒ±klamasƒ±</label>
            <textarea id="description" name="description" rows="5" maxlength="2000"
                      placeholder="√úr√ºn√ºn√ºz√º detaylƒ± a√ßƒ±klayƒ±n. Malzeme, boyut, √∂zellikler..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="price">Fiyat (TL) *</label>
              <input type="number" id="price" name="price" required min="1" step="0.01"
                     placeholder="750" />
            </div>
            <div class="form-group">
              <label for="stock">Stok Adedi</label>
              <input type="number" id="stock" name="stock" min="1" value="1" />
            </div>
          </div>

          <div class="form-group">
            <label for="category">Kategori *</label>
            <select id="category" name="category" required>
              {categories.map(cat => (
                <option value={cat}>{cat}</option>
              ))}
            </select>
          </div>

          <div class="form-group">
            <label for="features">√ñzellikler</label>
            <input type="text" id="features" name="features" maxlength="500"
                   placeholder="Virg√ºlle ayƒ±rƒ±n: LED Aydƒ±nlatma, PLA+ Malzeme, USB G√º√ß" />
            <span class="form-hint">Her √∂zelliƒüi virg√ºlle ayƒ±rƒ±n</span>
          </div>
        </div>

        <div class="form-section">
          <h2>G√∂rsel</h2>

          <div class="form-group">
            <label>√úr√ºn G√∂rseli</label>
            <div class="image-upload-area" id="imageUploadArea">
              <input type="file" id="imageInput" accept="image/*" hidden />
              <div class="upload-placeholder" id="uploadPlaceholder">
                <span class="upload-icon">üì∑</span>
                <p>G√∂rsel y√ºklemek i√ßin tƒ±klayƒ±n</p>
                <span class="upload-hint">PNG, JPG - Max 5MB</span>
              </div>
              <div class="image-preview" id="imagePreview" style="display: none;">
                <img id="previewImg" src="" alt="√ñnizleme" />
                <button type="button" class="remove-image" id="removeImage">‚úï</button>
              </div>
            </div>
            <input type="hidden" id="image_url" name="image_url" />
          </div>
        </div>

        <div class="form-section">
          <h2>Satƒ±≈ü Linki</h2>

          <div class="form-group">
            <label for="shopier_url">Shopier √úr√ºn Linki *</label>
            <input type="url" id="shopier_url" name="shopier_url" required
                   placeholder="https://shopier.com/..." />
            <span class="form-hint">
              Shopier'da √ºr√ºn√ºn√ºz√º olu≈üturup linkini buraya yapƒ±≈ütƒ±rƒ±n.
              <a href="https://shopier.com" target="_blank" rel="noopener">Shopier'a Git ‚Üí</a>
            </span>
          </div>
        </div>

        <div class="form-info">
          <div class="info-icon">‚ÑπÔ∏è</div>
          <p>√úr√ºn√ºn√ºz y√∂netici onayƒ±ndan sonra maƒüazada g√∂r√ºnecektir. Onay s√ºreci genellikle 24 saat i√ßinde tamamlanƒ±r.</p>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="window.history.back()">ƒ∞ptal</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="btn-text">√úr√ºn√º Ekle</span>
            <span class="btn-loading" style="display: none;">Ekleniyor...</span>
          </button>
        </div>
      </form>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  const API_URL = 'https://tech-portal-api.turgut-d01.workers.dev';

  // Auth kontrol√º
  document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('authToken');
    const loginWarning = document.getElementById('loginWarning');
    const productForm = document.getElementById('productForm');

    if (!token) {
      loginWarning.style.display = 'block';
      return;
    }

    // Token'ƒ± doƒürula
    try {
      const res = await fetch(`${API_URL}/api/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.ok) {
        loginWarning.style.display = 'none';
        productForm.style.display = 'block';
      } else {
        localStorage.removeItem('authToken');
        localStorage.removeItem('authUser');
        loginWarning.style.display = 'block';
      }
    } catch {
      loginWarning.style.display = 'block';
    }
  });

  // G√∂rsel y√ºkleme
  const imageUploadArea = document.getElementById('imageUploadArea');
  const imageInput = document.getElementById('imageInput');
  const uploadPlaceholder = document.getElementById('uploadPlaceholder');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const removeImageBtn = document.getElementById('removeImage');
  const imageUrlInput = document.getElementById('image_url');

  imageUploadArea?.addEventListener('click', () => imageInput?.click());

  imageInput?.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert('Dosya boyutu 5MB\'dan k√º√ß√ºk olmalƒ±dƒ±r');
      return;
    }

    // √ñnizleme g√∂ster
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImg.src = e.target.result;
      uploadPlaceholder.style.display = 'none';
      imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    // R2'ye y√ºkle
    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch(`${API_URL}/api/upload`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: formData
      });

      if (res.ok) {
        const data = await res.json();
        imageUrlInput.value = data.url;
      } else {
        alert('G√∂rsel y√ºklenirken hata olu≈ütu');
      }
    } catch (err) {
      console.error('Upload error:', err);
      alert('G√∂rsel y√ºklenirken hata olu≈ütu');
    }
  });

  removeImageBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    imageInput.value = '';
    imageUrlInput.value = '';
    previewImg.src = '';
    uploadPlaceholder.style.display = 'flex';
    imagePreview.style.display = 'none';
  });

  // Form g√∂nderimi
  document.getElementById('productForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';

    const data = {
      title: document.getElementById('title').value,
      description: document.getElementById('description').value,
      price: parseFloat(document.getElementById('price').value),
      stock: parseInt(document.getElementById('stock').value) || 1,
      category: document.getElementById('category').value,
      features: document.getElementById('features').value,
      image_url: document.getElementById('image_url').value,
      shopier_url: document.getElementById('shopier_url').value
    };

    try {
      const res = await fetch(`${API_URL}/api/products`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (res.ok) {
        alert('√úr√ºn√ºn√ºz ba≈üarƒ±yla eklendi! Y√∂netici onayƒ±ndan sonra maƒüazada g√∂r√ºnecektir.');
        window.location.href = '/urunlerim';
      } else {
        alert('Hata: ' + (result.message || result.error));
      }
    } catch (err) {
      alert('Bir hata olu≈ütu: ' + err.message);
    } finally {
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  });
</script>

<style>
  .add-product-page {
    padding: 100px 0 60px;
    min-height: 100vh;
  }

  .page-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .back-link {
    display: inline-block;
    color: var(--text-muted);
    margin-bottom: 16px;
    font-size: 0.9rem;
  }

  .back-link:hover {
    color: var(--accent);
  }

  .page-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 8px;
  }

  .page-header p {
    color: var(--text-muted);
    font-size: 1.1rem;
  }

  /* Warning Box */
  .warning-box {
    display: none;
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
    padding: 40px;
    background: var(--bg-card);
    border-radius: 20px;
    border: 1px solid var(--border-soft);
  }

  .warning-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }

  .warning-box h3 {
    font-size: 1.5rem;
    margin-bottom: 12px;
  }

  .warning-box p {
    color: var(--text-muted);
    margin-bottom: 24px;
  }

  /* Form */
  .product-form {
    max-width: 700px;
    margin: 0 auto;
  }

  .form-section {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 24px;
    border: 1px solid var(--border-soft);
  }

  .form-section h2 {
    font-size: 1.2rem;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-soft);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-main);
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border-soft);
    border-radius: 12px;
    font-size: 1rem;
    background: var(--bg-main);
    color: var(--text-main);
    transition: all 0.3s ease;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
  }

  .form-hint {
    display: block;
    margin-top: 8px;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .form-hint a {
    color: var(--accent);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 600px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  /* Image Upload */
  .image-upload-area {
    border: 2px dashed var(--border-soft);
    border-radius: 12px;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .image-upload-area:hover {
    border-color: var(--accent);
  }

  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
  }

  .upload-icon {
    font-size: 3rem;
    margin-bottom: 12px;
  }

  .upload-placeholder p {
    font-weight: 600;
    margin-bottom: 8px;
  }

  .upload-hint {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .image-preview {
    position: relative;
  }

  .image-preview img {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
  }

  .remove-image {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }

  /* Info Box */
  .form-info {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    background: rgba(34, 197, 94, 0.1);
    border-radius: 12px;
    margin-bottom: 24px;
  }

  .info-icon {
    font-size: 1.2rem;
  }

  .form-info p {
    font-size: 0.9rem;
    color: var(--text-main);
    line-height: 1.5;
  }

  /* Actions */
  .form-actions {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
  }
</style>
